# 性能測試 (Performance Testing)

- **難度**: 8
- **重要程度**: 5
- **標籤**: `Testing`, `Performance`, `Load Testing`, `Stress Testing`

## 問題詳述

什麼是性能測試？它包含哪些主要類型（如負載測試、壓力測試、浸泡測試）？在後端系統開發中，為什麼性能測試至關重要，以及如何設計和執行一個有效的性能測試？

## 核心理論與詳解

性能測試是一種非功能性測試，旨在評估系統在特定工作負載下的響應速度、穩定性、可擴展性和資源使用情況。對於後端系統而言，性能測試是確保服務品質 (QoS) 和使用者體驗的關鍵環節，尤其是在高併發場景下。

一個完整的性能測試策略通常包含以下幾種類型：

### 1. 負載測試 (Load Testing)

- **目標**：驗證系統在**預期**的正常和峰值負載下的表現。例如，模擬黑色星期五促銷活動時，預計同時有 10,000 名使用者在線下單。
- **方法**：逐漸增加併發使用者數或請求量，直到達到預設的負載目標。
- **關鍵指標**：
  - **平均響應時間 (Average Response Time)**：處理請求所需的平均時間。
  - **吞吐量 (Throughput)**：單位時間內系統處理的請求數（例如，RPS - Requests Per Second）。
  - **錯誤率 (Error Rate)**：失敗請求的百分比。
- **目的**：確保系統在日常和預期高峰期能穩定運行，並找出性能瓶頸。

### 2. 壓力測試 (Stress Testing)

- **目標**：評估系統在**超出預期**的極限負載下的行為，直到系統崩潰或性能下降到不可接受的程度。
- **方法**：持續增加負載，遠超過系統的設計容量。
- **關鍵指標**：
  - **系統崩潰點 (Breaking Point)**：系統開始大量拋出錯誤或完全無響應的負載水準。
  - **恢復能力 (Recovery)**：在壓力減輕後，系統是否能自動恢復到正常狀態。
- **目的**：了解系統的極限在哪裡，以及在高壓下如何優雅地降級（Graceful Degradation），而不是災難性地崩潰。例如，在高流量下，系統可以選擇性地關閉非核心功能，或返回一個友好的錯誤頁面。

### 3. 浸泡測試 (Soak Testing / Endurance Testing)

- **目標**：評估系統在**長時間**內持續承受正常負載下的穩定性。
- **方法**：將系統置於正常的生產負載下，運行數小時甚至數天。
- **關鍵指標**：
  - **記憶體洩漏 (Memory Leaks)**：長時間運行後，記憶體使用量是否持續增長且不被釋放。
  - **資源耗盡**：資料庫連接池、文件句柄等資源是否被正確管理和釋放。
  - **性能衰退**：系統的響應時間或吞吐量是否隨時間推移而下降。
- **目的**：發現因長時間運行才會暴露的隱藏問題，如資源洩漏、日誌堆積、快取失效等。

### 為什麼性能測試對後端至關重要？

1. **保障使用者體驗**：沒有人喜歡緩慢或不穩定的服務。性能是使用者滿意度的核心。
2. **預防生產事故**：提前發現性能瓶頸，避免在高流量衝擊下導致服務癱瘓，造成商業損失。
3. **容量規劃 (Capacity Planning)**：通過性能測試結果，可以科學地預估未來需要多少硬體資源來支撐業務增長。
4. **建立信心**：為系統上線和市場推廣活動提供數據支持，確保系統能夠應對預期的挑戰。

## 程式碼範例 (可選)

性能測試通常使用專門的工具（如 k6, JMeter, Gatling）來模擬大量使用者，而不是透過單元測試框架來編寫。以下是一個使用 Go 和 `k6` 進行簡單負載測試的例子。

假設我們有一個簡單的 HTTP 伺服器：

```go
// main.go
package main

import (
    "fmt"
    "net/http"
    "time"
)

func handler(w http.ResponseWriter, r *http.Request) {
    // 模擬一些處理時間
    time.Sleep(100 * time.Millisecond)
    fmt.Fprintf(w, "Hello, this is a test server!")
}

func main() {
    http.HandleFunc("/", handler)
    fmt.Println("Server started at :8080")
    http.ListenAndServe(":8080", nil)
}
```

我們可以使用 `k6` 編寫一個測試腳本來模擬負載：

```javascript
// load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  // 模擬 10 個虛擬使用者，持續 30 秒
  vus: 10,
  duration: '30s',
};

export default function () {
  // 訪問我們的 Go 伺服器
  const res = http.get('http://localhost:8080');

  // 驗證響應是否成功
  check(res, { 'status was 200': (r) => r.status == 200 });

  // 每次請求後等待 1 秒
  sleep(1);
}
```

**如何運行測試：**

1. 安裝 `k6`。
2. 運行 Go 伺服器: `go run main.go`
3. 在另一個終端中運行 k6 測試: `k6 run load-test.js`

`k6` 會輸出詳細的報告，包括平均響應時間、請求率 (RPS) 和錯誤率，幫助我們評估伺服器的性能。
