# 整合測試 (Integration Testing)

- **難度**: 6
- **重要性**: 4
- **標籤**: `Testing`, `Integration Testing`

## 問題詳述

什麼是整合測試 (Integration Testing)？它在測試金字塔中處於什麼位置？請解釋整合測試的主要目標，並舉例說明在後端開發中，哪些場景特別適合進行整合測試。

## 核心理論與詳解

整合測試是測試金字塔中間層的關鍵部分，它扮演著連接底層單元測試和頂層端對端測試的橋樑角色。

### 什麼是整合測試？

整合測試的核心目標是驗證**多個獨立的模組、服務或組件在協同工作時是否能正常運作**。與單元測試的「隔離」原則相反，整合測試強調的是「互動」和「整合」。

它主要關注以下幾個方面：
1.  **模組間的介面**：一個模組的輸出是否能被另一個模組正確接收和處理？
2.  **與外部系統的通訊**：應用程式是否能正確地與資料庫、快取、訊息佇列、第三方 API 等外部依賴進行互動？
3.  **資料流的正確性**：資料在系統的不同部分之間流動時，是否保持一致性和完整性？

在測試金字塔中，整合測試位於單元測試之上、端對端測試之下。這意味著它們的數量應該比單元測試少，但比端對端測試多；執行速度比單元測試慢，但比端對端測試快。

---

### 整合測試的類型

整合測試可以根據其整合範圍和策略分為幾種類型：

1.  **大爆炸式整合 (Big Bang Integration)**:
    -   **做法**: 等待所有模組都開發完成後，再將它們全部組裝在一起進行測試。
    -   **優點**: 簡單，不需要規劃。
    -   **缺點**: 風險極高。一旦出現問題，很難定位錯誤的根源，因為可能有無數個互動點出錯。這是一種應極力避免的反模式。

2.  **增量式整合 (Incremental Integration)**:
    -   **做法**: 將模組逐步地、一個接一個地整合進來測試。這種方式更為科學和高效。
    -   **類型**:
        -   **自頂向下 (Top-Down)**: 從最高層的模組（例如 UI 或 API 層）開始測試，並使用**樁 (Stubs)** 來模擬尚未開發的底層模組。
        -   **自底向上 (Bottom-Up)**: 從最底層的模組（例如工具函式或資料庫存取層）開始測試，並使用**驅動程式 (Drivers)** 來模擬呼叫它們的上層模組。
        -   **三明治式 (Sandwich/Hybrid)**: 結合自頂向下和自底向上的優點，從中間層向兩端同時進行整合。

在現代後端開發，特別是微服務架構中，整合測試通常聚焦於單一服務與其外部依賴（如資料庫）之間的互動。

### 後端開發中的整合測試場景

在後端開發中，整合測試至關重要，因為服務的價值恰恰體現在它如何與其他系統協同工作。以下是一些典型的整合測試場景：

1.  **API 層與業務邏輯層的整合**:
    -   **目標**: 驗證 API 端點 (Endpoint) 是否能正確地呼叫到對應的業務邏輯服務 (Service)，並處理其回傳值。
    -   **範例**: 發送一個 `POST /users` 請求，測試它是否能成功觸發 `UserService` 中的 `CreateUser` 方法，並回傳 `201 Created` 狀態碼。

2.  **服務層與資料存取層 (DAL) 的整合**:
    -   **目標**: 這是最常見也最重要的整合測試。驗證業務邏輯是否能正確地透過資料存取層對資料庫進行增、刪、改、查 (CRUD) 操作。
    -   **範例**: 呼叫 `UserService.CreateUser` 方法後，直接查詢**測試資料庫**，驗證使用者記錄是否已成功寫入 `users` 資料表中。

3.  **與訊息佇列的整合**:
    -   **目標**: 驗證服務是否能成功地向訊息佇列（如 Kafka, RabbitMQ）發布訊息，或從中消費訊息。
    -   **範例**: 呼叫一個會觸發非同步任務的方法後，測試是否有一個對應的訊息被發送到指定的佇列中。反之，可以模擬向佇列發送一條訊息，測試消費者服務是否能正確地處理它。

4.  **與快取的整合**:
    -   **目標**: 驗證快取策略（如 Cache-Aside, Read-Through）是否被正確實現。
    -   **範例**: 第一次呼叫 `ProductService.GetProduct(123)` 時，驗證服務從資料庫獲取了資料並將其寫入 Redis。第二次呼叫相同方法時，驗證資料是直接從 Redis 中讀取的，而不是資料庫。

5.  **與第三方 API 的整合**:
    -   **目標**: 驗證服務是否能正確地呼叫外部 API 並處理其回應。
    -   **注意**: 直接呼叫真實的第三方 API 會讓測試變得不穩定且緩慢。在這種情況下，通常會使用像 `WireMock` 這樣的工具來在本機啟動一個模擬的 HTTP 伺服器，讓它回傳預期的回應。

### 整合測試的最佳實踐

-   **使用獨立的測試環境**: 整合測試應該在一個與生產環境隔離的環境中運行，使用獨立的測試資料庫、訊息佇列等。
-   **資料清理**: 每個測試案例執行前後，都應該確保資料庫處於一個乾淨、可預測的狀態。常見的做法是在測試前填充數據，在測試後進行清理（例如，透過資料庫交易回滾）。
-   **專注於整合點**: 整合測試不應該重複單元測試已經覆蓋的業務邏輯。它的重點是驗證「黏合層」的程式碼是否正確。
-   **保持適度**: 過多的整合測試會拖慢開發和部署流程。應該只為關鍵的整合點編寫測試，而不是為每個可能的互動都編寫。

### 結論

整合測試是確保軟體品質的關鍵環節。它彌補了單元測試無法驗證模組間協作的缺陷，同時又比端對端測試更穩定、更快速、更易於除錯。在後端開發中，良好設計的整合測試是保證服務能夠可靠地與資料庫、快取、訊息系統等外部依賴協同工作的最重要防線。