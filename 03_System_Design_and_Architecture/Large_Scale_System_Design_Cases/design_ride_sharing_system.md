# 如何設計共乘打車系統？

- **難度**: 9
- **重要程度**: 5
- **標籤**: `System Design`, `Ride Sharing`, `Location`, `Matching`

## 問題詳述

共乘打車平台（如 Uber、Lyft、滴滴）需要實時匹配乘客與司機、規劃路線、計算費用。請設計一個可擴展的打車系統，需要考慮：

1. **核心功能**：如何實現乘客叫車、司機接單、路線導航、費用計算？
2. **實時定位**：如何追蹤司機和乘客的實時位置？
3. **匹配算法**：如何高效匹配乘客與附近的司機？
4. **路線規劃**：如何計算最優路線和預估到達時間？
5. **高可用性**：如何應對尖峰時段的大量請求？

## 核心理論與詳解

打車系統是一個複雜的實時系統，結合了地理位置服務、匹配演算法、實時通訊等多個技術領域。

### 1. 核心業務流程

#### 典型打車流程

1. **乘客叫車**：
   - 乘客在 App 中輸入目的地
   - 系統顯示預估費用和到達時間
   - 乘客確認叫車

2. **司機匹配**：
   - 系統搜尋附近可用司機
   - 根據距離、評分、車型等因素排序
   - 依序向司機推送訂單

3. **司機接單**：
   - 司機查看訂單詳情（起點、終點、預估收入）
   - 決定是否接單
   - 第一個接單的司機獲得訂單

4. **前往接乘客**：
   - 司機導航到乘客位置
   - 乘客實時追蹤司機位置
   - 系統通知預計到達時間

5. **開始行程**：
   - 司機確認乘客上車
   - 開始計費
   - 導航到目的地

6. **完成行程**：
   - 到達目的地，司機結束行程
   - 系統計算費用並扣款
   - 乘客評價司機

### 2. 地理位置系統

#### 位置上報

- **司機位置上報**：
  - 司機 App 定期上報 GPS 座標（如每 4 秒一次）
  - 使用 WebSocket 或 HTTP 長輪詢
  - 上報內容：經度、緯度、方向、速度、時間戳

- **上報頻率優化**：
  - **閒置狀態**：較低頻率（如 30 秒）
  - **接單中**：中等頻率（如 10 秒）
  - **行程中**：高頻率（如 4 秒）

- **數據壓縮**：
  - 使用差分編碼（只上報與上次位置的差值）
  - 減少數據傳輸量

#### 位置儲存

- **熱數據**：
  - 司機當前位置儲存在 Redis
  - 使用 Redis Geo 資料結構：
    - `GEOADD`：添加司機位置
    - `GEORADIUS`：查詢範圍內的司機
  - 設置過期時間（如 60 秒），自動清理離線司機

- **歷史軌跡**：
  - 行程中的位置點儲存到時序資料庫（如 InfluxDB、TimescaleDB）
  - 用於糾紛處理、路線回溯、數據分析

#### 地理柵格（Geohash）

- **原理**：
  - 將地球劃分為網格，每個網格有唯一編碼
  - 相鄰的網格編碼相似
  - 編碼長度越長，精度越高

- **應用**：
  - 將經緯度轉換為 Geohash 編碼
  - 查詢附近司機時，先查詢相同 Geohash 前綴的司機
  - 再計算精確距離

- **範例**：
  - Geohash 長度 5：約 5km 精度
  - Geohash 長度 6：約 1.2km 精度
  - Geohash 長度 7：約 150m 精度

### 3. 匹配系統設計

#### 匹配策略

- **最近距離優先**：
  - 選擇距離乘客最近的司機
  - 簡單直觀，但可能不是最優

- **預估到達時間（ETA）優先**：
  - 考慮交通狀況、道路限制
  - 選擇 ETA 最短的司機
  - 更符合用戶需求

- **綜合評分**：
  - 距離：權重 40%
  - ETA：權重 30%
  - 司機評分：權重 20%
  - 接單率：權重 10%

#### 匹配流程

1. **範圍查詢**：
   - 使用 Redis Geo 查詢 3km 範圍內的司機
   - 如果司機不足，擴大範圍到 5km、10km

2. **過濾條件**：
   - 司機狀態為「空閒」
   - 車型符合要求
   - 司機評分 > 閾值

3. **排序**：
   - 根據綜合評分排序
   - 選擇前 N 名司機（如 5 名）

4. **推送訂單**：
   - 依序向司機推送訂單
   - 每個司機 15 秒響應時間
   - 若不接單，推送給下一個

5. **並行推送（可選）**：
   - 同時向多個司機推送
   - 第一個接單的司機獲得訂單
   - 其他司機收到取消通知

#### 供需平衡

- **動態定價（Surge Pricing）**：
  - 需求 > 供給時，提高價格
  - 吸引更多司機上線
  - 調節供需平衡

- **區域調度**：
  - 識別高需求區域
  - 引導司機前往該區域
  - 提供獎勵機制

### 4. 路線規劃

#### 導航服務

- **第三方地圖 API**：
  - Google Maps API
  - 高德地圖 API
  - 提供路線規劃、導航、交通狀況

- **自建地圖服務**：
  - 使用 OpenStreetMap 數據
  - 自行實現路線規劃算法（如 A*、Dijkstra）
  - 降低成本，但需要大量投入

#### 路線計算

- **多路線選擇**：
  - 計算多條可行路線（最短距離、最快時間、少收費）
  - 展示給司機選擇

- **實時路況**：
  - 整合實時交通數據
  - 動態調整路線
  - 避開擁堵路段

- **預估時間（ETA）**：
  - 基於歷史數據和實時路況
  - 使用機器學習模型預測
  - 考慮時段、天氣、節假日等因素

#### 費用計算

- **計費規則**：
  - **基礎費用**：起步價
  - **距離費用**：每公里單價
  - **時長費用**：每分鐘單價（低速行駛或等待時）
  - **動態調價**：尖峰時段加價
  - **跨區費用**：跨城市加價

- **計算公式**：
  ```
  總費用 = 起步價 + 距離 × 距離單價 + 時長 × 時長單價 + 動態調價 + 其他費用
  ```

- **費用預估**：
  - 叫車時根據起終點預估費用
  - 實際費用根據實際行駛距離和時長計算

### 5. 實時通訊

#### WebSocket 長連接

- **用途**：
  - 司機位置實時更新
  - 訂單狀態變化通知
  - 乘客和司機之間的消息

- **連接管理**：
  - 每個客戶端維持一個 WebSocket 連接
  - 連接斷開時自動重連
  - 使用心跳保活

#### 推送服務

- **訂單推送**：
  - 向特定司機推送訂單資訊
  - 使用 WebSocket 或推送通知（APNs、FCM）

- **狀態同步**：
  - 司機接單後，通知乘客
  - 司機到達後，通知乘客
  - 行程狀態變化實時同步

#### 消息隊列

- **非同步處理**：
  - 位置上報後非同步更新資料庫
  - 訂單完成後非同步計算費用、發送通知

- **削峰填谷**：
  - 尖峰時段將請求放入隊列
  - 平滑處理，避免系統過載

### 6. 數據模型設計

#### 核心資料表

- **用戶表（Users）**：
  - `user_id`、`name`、`phone`、`email`
  - `user_type`：乘客、司機
  - `rating`：評分
  - `status`：帳戶狀態

- **司機表（Drivers）**：
  - `driver_id`、`user_id`
  - `license_number`：駕照號碼
  - `vehicle_id`：車輛 ID
  - `status`：空閒、接單中、行程中、離線
  - `current_location`：當前位置（緯度、經度）

- **訂單表（Orders）**：
  - `order_id`：訂單 ID
  - `passenger_id`：乘客 ID
  - `driver_id`：司機 ID
  - `pickup_location`：上車地點
  - `dropoff_location`：下車地點
  - `status`：待接單、已接單、行程中、已完成、已取消
  - `fare`：費用
  - `created_at`、`started_at`、`completed_at`

- **行程軌跡表（Trips）**：
  - `trip_id`、`order_id`
  - `latitude`、`longitude`
  - `timestamp`
  - 用於記錄行程中的位置點

#### 索引設計

- **地理空間索引**：
  - 在 `current_location` 上建立地理空間索引
  - 支援範圍查詢

- **複合索引**：
  - `(status, current_location)`：查詢空閒司機
  - `(passenger_id, created_at)`：查詢用戶訂單歷史

### 7. 高併發架構

#### 分區分片

- **地理分區**：
  - 按城市或區域劃分服務
  - 每個城市獨立部署一套系統
  - 降低單個系統的負載

- **數據分片**：
  - 訂單表按 `order_id` 雜湊分片
  - 用戶表按 `user_id` 分片
  - 司機表按 `driver_id` 分片

#### 快取策略

- **司機位置快取**：
  - Redis Geo 儲存司機實時位置
  - 設置過期時間，自動清理

- **熱點數據快取**：
  - 用戶資訊、司機資訊快取
  - 訂單狀態快取

- **地圖數據快取**：
  - 路線規劃結果快取
  - 相同起終點的路線可重用

#### 負載均衡

- **Gateway 負載均衡**：
  - 根據地理位置路由到最近的服務器
  - 使用 GeoDNS 或 CDN

- **服務負載均衡**：
  - 匹配服務、定位服務使用獨立的服務集群
  - 根據負載動態擴縮容

### 8. 安全與隱私

#### 位置隱私

- **模糊化處理**：
  - 顯示給乘客的司機位置稍作偏移（100-200 米）
  - 保護司機隱私

- **僅在必要時追蹤**：
  - 只在訂單進行中追蹤詳細位置
  - 訂單完成後停止追蹤

#### 身份驗證

- **司機認證**：
  - 駕照驗證
  - 背景調查
  - 車輛註冊資訊

- **乘客認證**：
  - 手機號驗證
  - 實名認證（部分地區要求）

#### 安全功能

- **緊急求助**：
  - 一鍵報警功能
  - 自動分享行程給緊急聯絡人

- **行程分享**：
  - 乘客可分享行程連結給朋友
  - 朋友可實時追蹤位置

- **錄音錄影**：
  - 行程中自動錄音（部分地區）
  - 用於糾紛處理和安全保障

### 9. 支付與結算

#### 支付流程

- **預授權**：
  - 行程開始前凍結預估費用
  - 行程結束後實際扣款
  - 剩餘金額解凍

- **多種支付方式**：
  - 信用卡、簽帳卡
  - 電子錢包（支付寶、微信支付）
  - 現金支付

#### 司機結算

- **計算收入**：
  - 訂單費用 - 平台抽成
  - 獎勵和補貼

- **結算週期**：
  - 每週或每日結算
  - 提現到銀行帳戶

- **對帳**：
  - 定期與支付平台對帳
  - 確保收入準確

### 10. 數據分析與優化

#### 關鍵指標

- **業務指標**：
  - 訂單量、成交率、取消率
  - 司機在線時長、訂單數
  - 乘客留存率

- **性能指標**：
  - 匹配成功率
  - 平均匹配時間
  - 平均到達時間（ETA 準確度）

#### 熱力圖分析

- **需求熱力圖**：
  - 分析不同時段、區域的叫車需求
  - 指導司機調度

- **供給熱力圖**：
  - 分析司機分佈
  - 識別供需不平衡區域

#### 機器學習應用

- **需求預測**：
  - 預測未來一小時的叫車需求
  - 提前調度司機

- **動態定價**：
  - 根據供需預測調整價格
  - 最大化平台收益和用戶滿意度

- **路線優化**：
  - 學習歷史路線數據
  - 推薦最優路線

### 11. 拼車功能

#### 拼車匹配

- **同向路線匹配**：
  - 尋找起點、終點相近的訂單
  - 計算繞路距離和時間
  - 只有繞路不超過閾值時才拼車

- **動態拼單**：
  - 行程中動態接入新乘客
  - 實時重新規劃路線

#### 費用分攤

- **拼車折扣**：
  - 拼車乘客享受折扣（如 7 折）
  - 司機收入不減少（平台補貼）

- **公平計費**：
  - 根據各自的行駛距離分攤費用
  - 避免某一方支付過多

### 12. 全球化部署

#### 多地域支援

- **區域獨立部署**：
  - 每個國家或城市獨立部署
  - 數據不跨境傳輸（合規要求）

- **地圖服務適配**：
  - 不同地區使用不同地圖服務
  - 中國：高德、百度
  - 國際：Google Maps

#### 多語言多貨幣

- **國際化（i18n）**：
  - 支援多語言界面
  - 自動檢測用戶語言偏好

- **多貨幣結算**：
  - 支援當地貨幣支付
  - 匯率自動轉換

## 架構總結

一個完整的打車系統架構包含：

1. **客戶端層**：乘客 App、司機 App、Web 管理後台
2. **接入層**：API Gateway、WebSocket Gateway、負載均衡
3. **業務層**：
   - 訂單服務：訂單創建、狀態管理
   - 匹配服務：司機匹配、推送
   - 定位服務：位置上報、查詢
   - 路線服務：路線規劃、導航
   - 支付服務：支付、結算
   - 通知服務：推送、簡訊
4. **數據層**：
   - MySQL：訂單、用戶、司機資料
   - Redis：實時位置、快取
   - 時序資料庫：行程軌跡
5. **地圖服務**：第三方地圖 API 或自建地圖
6. **大數據平台**：數據分析、機器學習

打車系統是一個典型的 **O2O（Online to Offline）** 系統，融合了實時定位、複雜匹配、路線規劃等多個技術挑戰。設計時需要重點關注**實時性**、**準確性**和**用戶體驗**，同時保證**安全**和**隱私**。
