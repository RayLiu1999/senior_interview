# 如何設計新聞推送系統？

- **難度**: 8
- **重要程度**: 5
- **標籤**: `System Design`, `Push Notification`, `Personalization`, `Recommendation`

## 問題詳述

設計一個新聞推送系統，支援向數千萬使用者推送個性化新聞內容。系統需要根據使用者興趣進行內容推薦，支援多種推送渠道（App Push、簡訊、Email），並控制推送頻率避免打擾使用者。

## 核心理論與詳解

### 1. 系統特點與挑戰分析

#### 1.1 業務特點

**大規模使用者**：
- 日活使用者：1 億
- 訂閱推送使用者：5000 萬
- 每日推送總量：2 億次

**個性化需求**：
- 每個使用者的興趣不同
- 需要推薦不同的新聞內容
- 點擊率直接影響使用者留存

**多渠道推送**：
- App Push Notification（主要）
- SMS 簡訊（重要通知）
- Email（日報/週報）
- Web Push（瀏覽器）

**時機敏感性**：
- 突發新聞：需即時推送
- 定時推送：早報（8:00）、晚報（20:00）
- 個性化推送：使用者活躍時段

#### 1.2 核心挑戰

**挑戰一：如何做好個性化推薦**
- 使用者興趣如何建模？
- 內容如何標籤化？
- 如何平衡探索與利用（Exploration vs Exploitation）？

**挑戰二：如何控制推送頻率**
- 推送過多：使用者關閉通知
- 推送過少：使用者流失
- 不同使用者的容忍度不同

**挑戰三：如何保證推送到達率**
- 渠道穩定性（FCM、APNs 可能失敗）
- 設備離線問題
- 失敗重試機制

**挑戰四：如何處理瞬時高並發**
- 突發新聞需要同時推送給百萬使用者
- 如何在 1 分鐘內完成推送？

### 2. 整體架構設計

#### 2.1 系統架構圖

```
┌──────────────────────────────────────────┐
│      新聞發布系統（CMS）                   │
│  - 編輯發布新聞                            │
│  - 打標籤（科技、體育、娛樂等）             │
│  - 設定推送策略                            │
└────────────┬─────────────────────────────┘
             │
             ↓ 發布新聞事件
┌────────────▼─────────────────────────────┐
│      消息隊列（Kafka）                     │
│  Topic: news.published                    │
└────────────┬─────────────────────────────┘
             │
     ┌───────┼───────┐
     ↓       ↓       ↓
┌────▼───┐ ┌──▼───┐ ┌──▼───┐
│內容    │ │內容  │ │內容  │
│標籤    │ │標籤  │ │標籤  │
│Worker  │ │Worker│ │Worker│
└────┬───┘ └──┬───┘ └──┬───┘
     └───────┼───────┘
             ↓ 標籤提取完成
┌────────────▼─────────────────────────────┐
│      推薦引擎                              │
│  - 使用者興趣匹配                          │
│  - 計算推送分數                            │
│  - 使用者分群                              │
└────────────┬─────────────────────────────┘
             │
     ┌───────┼───────┐
     ↓       ↓       ↓
┌────▼───┐ ┌──▼───┐ ┌──▼───┐
│ App    │ │ SMS  │ │Email │
│ Push   │ │ 推送  │ │ 推送 │
│ 服務   │ │ 服務  │ │ 服務 │
└────┬───┘ └──┬───┘ └──┬───┘
     └───────┼───────┘
             ↓
┌────────────▼─────────────────────────────┐
│      第三方推送服務                        │
│  - Firebase FCM（Android）                │
│  - Apple APNs（iOS）                      │
│  - Twilio（SMS）                          │
│  - SendGrid（Email）                      │
└──────────────────────────────────────────┘
```

#### 2.2 數據存儲設計

**Redis**：
- 使用者興趣標籤：`user:interests:{user_id}` → Sorted Set（標籤 + 權重）
- 使用者偏好設定：`user:preferences:{user_id}` → Hash
- 推送頻率控制：`push:count:{user_id}:{date}` → Counter

**MongoDB**：
- 新聞內容：支援靈活的文檔結構
- 新聞標籤索引：支援多標籤查詢

**MySQL**：
- 使用者基本資訊
- 推送記錄（用於統計和審計）
- 訂閱關係

### 3. 使用者興趣建模（個性化核心）

這是推送系統的核心，決定了推送的精準度。

#### 3.1 興趣標籤採集策略

**顯性興趣（使用者主動行為）**：

| 行為 | 權重 | 說明 |
|------|------|------|
| 訂閱主題 | 10 | 最強興趣信號 |
| 分享新聞 | 5 | 強興趣信號 |
| 點擊閱讀 | 1 | 基礎興趣信號 |
| 收藏新聞 | 3 | 中等興趣信號 |

**隱性興趣（系統推斷）**：

| 行為 | 權重 | 說明 |
|------|------|------|
| 閱讀時長 > 30s | 2 | 深度閱讀 |
| 滑動瀏覽（未點擊） | 0.1 | 輕微興趣 |
| 快速劃過 | 0 | 無興趣 |
| 點擊後立即退出 | -1 | 負向信號 |

**數據結構選擇**：
```
Redis Sorted Set：
  Key: user:interests:{user_id}
  Score: 興趣權重（累計分數）
  Member: 標籤 ID

示例：
  user:interests:12345
    - "tech": 50.5
    - "sports": 30.2
    - "finance": 20.8
```

**為什麼選擇 Sorted Set**：
- ✅ 支援權重排序（ZREVRANGE 獲取 Top N 興趣）
- ✅ 支援分數累加（ZINCRBY 增加權重）
- ✅ 性能高（O(log N) 操作）

#### 3.2 興趣衰減機制

**為什麼需要衰減**：
- 使用者興趣會隨時間變化
- 舊的興趣標籤不應永久影響推薦
- 需要給新興趣騰出空間

**衰減策略**：
```
每日衰減任務：
1. 獲取所有使用者的興趣標籤
2. 對每個標籤的權重 × 0.99（衰減 1%）
3. 移除權重 < 1 的標籤

效果：
- 100 天後，不更新的標籤權重衰減到原來的 37%
- 保持興趣標籤的時效性
```

### 4. 內容推薦演算法

推送什麼內容給使用者？有多種策略可以結合使用。

#### 4.1 基於內容的推薦（Content-Based）

**原理**：根據使用者的興趣標籤，匹配新聞的標籤。

**流程**：
```
1. 獲取使用者的 Top 10 興趣標籤
   例如：["科技": 50, "AI": 30, "創業": 20]

2. 查詢包含這些標籤的最新新聞
   MongoDB 查詢：tags IN ["科技", "AI", "創業"] AND publish_time > 24h

3. 計算匹配分數
   分數 = Σ(標籤權重 × 標籤匹配度)

4. 排序返回 Top N
```

**優點**：
- ✅ 實現簡單
- ✅ 可解釋性強
- ✅ 適合冷啟動（新使用者）

**缺點**：
- ❌ 容易陷入「信息繭房」（只推薦相似內容）
- ❌ 無法發現新興趣

#### 4.2 協同過濾推薦（Collaborative Filtering）

**原理**：找到興趣相似的使用者，推薦他們喜歡的內容。

**流程**：
```
1. 計算使用者相似度
   用戶 A 興趣：[科技, 創業, 投資]
   用戶 B 興趣：[科技, 商業, 投資]
   相似度：2/3 = 0.67（餘弦相似度）

2. 找到 Top 10 相似使用者

3. 聚合他們最近閱讀的新聞

4. 過濾掉使用者已讀的，推薦剩餘的
```

**優點**：
- ✅ 能發現新興趣（探索）
- ✅ 基於真實使用者行為

**缺點**：
- ❌ 計算複雜度高
- ❌ 需要大量使用者數據
- ❌ 相似度計算需要離線預處理

#### 4.3 混合推薦策略（推薦）

**實踐中的最佳方案**：結合多種策略。

**推薦比例**：
- 60% 基於內容推薦（利用已知興趣）
- 30% 協同過濾推薦（探索新興趣）
- 10% 熱門新聞（避免信息繭房）

**為什麼這樣分配**：
- 大部分推送滿足使用者已知興趣（高點擊率）
- 適度探索新內容（保持新鮮感）
- 熱門新聞保證不錯過重要事件

### 5. 推送頻率控制（避免打擾）

推送頻率是推送系統的生命線，控制不好會導致使用者卸載 App。

#### 5.1 使用者分層策略

根據使用者活躍度分層，不同層級不同策略。

| 使用者類型 | 定義 | 推送頻率 | 說明 |
|-----------|------|---------|------|
| **高活躍** | 每天打開 5+ 次 | 6 次/天 | 重度使用者，可多推 |
| **中活躍** | 每天打開 1-5 次 | 3 次/天 | 一般使用者 |
| **低活躍** | 一週打開 1 次 | 1 次/天 | 輕度使用者，少推 |
| **沉睡** | 7 天未打開 | 0 或喚醒推送 | 避免打擾，或嘗試喚醒 |

**為什麼要分層**：
- 高活躍使用者願意接受更多推送
- 低活躍使用者需要精打細算，推送最精準的內容
- 一刀切的策略會導致兩邊都不滿意

#### 5.2 推送限額控制

**每日限額**：
```
實現方式：
  Redis Key: push:count:{user_id}:{date}
  
  檢查邏輯：
  if redis.INCR(key) > limit:
      return "超過每日限額"
  redis.EXPIRE(key, 24h)
```

**推送間隔**：
```
最小間隔：2 小時

實現：
  Redis Key: push:last:{user_id}
  Value: 上次推送時間戳
  
  檢查邏輯：
  last_time = redis.GET(key)
  if now - last_time < 2h:
      return "間隔太短"
```

#### 5.3 靜默時段

**尊重使用者作息**：
```
預設靜默時段：23:00 - 08:00

使用者可自定義：
  user_preferences:
    quiet_start: "23:00"
    quiet_end: "08:00"

推送前檢查：
  if 當前時間 in 靜默時段:
      延遲到靜默時段結束
```

**例外情況**：
- 緊急新聞可突破靜默時段限制
- 使用者訂閱的特定事件更新

### 6. 推送優先級與渠道選擇

不是所有推送都一樣重要，需要設計優先級機制。

#### 6.1 優先級劃分

| 優先級 | 使用場景 | 處理方式 |
|-------|---------|---------|
| **緊急（Urgent）** | 突發新聞、災害預警 | 忽略所有限制，立即推送 |
| **高（High）** | 重要新聞、使用者訂閱事件 | 可突破推送間隔限制 |
| **普通（Normal）** | 日常推薦 | 嚴格遵守所有限制 |

**決策邏輯**：
```
function shouldPush(user, news, priority):
    if priority == Urgent:
        return true  // 無條件推送
    
    if 超過每日限額:
        return false
    
    if 在靜默時段 and priority != High:
        return false
    
    if 距離上次推送 < 2h and priority != High:
        return false
    
    return true
```

#### 6.2 多渠道策略

**渠道選擇邏輯**：
```
優先級 = Urgent：
  - App Push
  - SMS（雙渠道保證到達）

優先級 = High：
  - App Push
  - Email（作為備份）

優先級 = Normal：
  - App Push（僅此一個）
```

**為什麼不總是多渠道**：
- SMS 和 Email 有成本（每條 $0.01-0.1）
- 多渠道推送可能讓使用者煩躁
- 只在重要場景使用

### 7. 推送到達率優化

推送發出不等於推送送達，需要處理各種失敗場景。

#### 7.1 失敗重試機制

**失敗類型與處理**：

```
暫時性失敗（可重試）：
- 網絡超時
- 第三方服務限流
- 設備暫時離線

處理：指數退避重試
  - 第 1 次：立即
  - 第 2 次：1 秒後
  - 第 3 次：4 秒後
  - 第 4 次：16 秒後
  - 最多 3 次

永久性失敗（不重試）：
- 使用者卸載 App
- 使用者關閉通知權限
- 設備 Token 失效

處理：
  - 記錄失敗原因
  - 更新使用者狀態
  - 後續不再推送（直到狀態恢復）
```

#### 7.2 離線設備處理

**設備離線問題**：
- App 未打開，設備離線
- 推送服務會暫存消息（FCM 最多 4 週）
- 但太晚送達失去意義

**解決方案**：
```
新聞推送的時效性：
- < 1 小時：仍然有價值，正常送達
- 1-24 小時：價值降低，可以送達但降低優先級
- > 24 小時：過期，直接放棄

實現：
  設置 TTL（Time To Live）
  FCM: time_to_live: 3600  // 1 小時
  
  如果 1 小時內設備未上線，推送自動過期
```

### 8. 系統擴展性與性能優化

#### 8.1 水平擴展設計

**無狀態服務**：
- 所有推送 Worker 都是無狀態的
- 可以隨時增加或減少 Worker 數量
- 通過 Kafka 的 Consumer Group 自動負載均衡

**數據分片**：
```
使用者數據分片：
  - 按 user_id % 256 分片
  - 每個分片獨立的 Redis 實例
  - 避免單點瓶頸

新聞內容分片：
  - 按 news_id 分片（MongoDB 原生支援）
```

#### 8.2 批次處理優化

**為什麼需要批次**：
- 單個推送調用第三方 API 有網絡開銷
- 批次推送可以顯著提升效率

**批次策略**：
```
批次大小：1000 個使用者/批次

處理流程：
1. 累積 1000 個推送任務
2. 批次調用 FCM API
3. 處理返回結果（成功/失敗）

性能提升：
- 單次推送：1000 QPS
- 批次推送：100,000 QPS（提升 100 倍）
```

### 9. 監控與優化

#### 9.1 關鍵指標

**業務指標**：
- **送達率**：成功推送 / 總推送 × 100%（目標 > 95%）
- **點擊率（CTR）**：點擊數 / 送達數 × 100%（目標 > 5%）
- **取消訂閱率**：每日取消訂閱 / DAU（目標 < 0.5%）

**系統指標**：
- 推送延遲（P99 < 1 分鐘）
- Kafka 消費延遲（< 1000 消息）
- Redis 命中率（> 95%）

#### 9.2 A/B 測試

**持續優化推送策略**：
```
測試案例：
- 標題 A vs 標題 B（哪個點擊率更高？）
- 推送時間：8:00 vs 9:00（哪個更好？）
- 推送頻率：3 次/天 vs 5 次/天

實施：
- 將使用者隨機分為 A/B 組
- 收集 7 天數據
- 比較點擊率、取消訂閱率
- 選擇更好的策略全量上線
```

## 程式碼範例（可選）

僅展示核心的使用者興趣更新邏輯：

```go
// 使用者點擊新聞後更新興趣
func UpdateUserInterest(userID int64, newsID int64) {
    // 1. 獲取新聞標籤
    news := getNews(newsID)
    
    // 2. 更新使用者興趣權重
    for _, tag := range news.Tags {
        redis.ZIncrBy(
            fmt.Sprintf("user:interests:%d", userID),
            1.0,  // 點擊權重 +1
            tag,
        )
    }
}
```

## 總結

設計新聞推送系統的核心要點：

1. **個性化推薦**：使用者興趣建模（Sorted Set） + 混合推薦演算法（內容 + 協同）
2. **頻率控制**：使用者分層 + 每日限額 + 推送間隔 + 靜默時段
3. **優先級機制**：緊急/重要/普通三級，不同處理策略
4. **多渠道推送**：App Push（主） + SMS + Email（輔助）
5. **到達率優化**：重試機制 + 離線處理 + TTL 設置
6. **可擴展性**：無狀態服務 + 數據分片 + 批次處理

推送系統的核心挑戰是**平衡推送效果和使用者體驗**：推送太少使用者流失，推送太多使用者關閉通知。需要通過精準的個性化和智能的頻率控制找到最佳平衡點。
