# 如何設計新聞推薦系統？

- **難度**: 8
- **重要程度**: 5
- **標籤**: `System Design`, `Recommendation`, `Machine Learning`, `Personalization`

## 問題詳述

新聞推薦系統（如今日頭條、Google News）需要為用戶推薦個人化的新聞內容。請設計一個智能推薦系統，需要考慮：

1. **核心功能**：如何收集新聞、提取特徵、生成推薦？
2. **個人化**：如何根據用戶興趣進行個人化推薦？
3. **實時性**：如何快速推薦最新的熱門新聞？
4. **多樣性**：如何避免推薦結果過於單一（資訊繭房）？
5. **冷啟動**：如何為新用戶或新內容進行推薦？

## 核心理論與詳解

新聞推薦系統結合了內容理解、用戶建模、推薦演算法、大數據處理等多個技術領域，是典型的個人化推薦應用。

### 1. 系統架構概覽

#### 核心模組

- **內容採集**：從各新聞源抓取內容
- **內容處理**：去重、分類、提取特徵
- **用戶建模**：分析用戶行為，建立興趣畫像
- **推薦引擎**：生成個人化推薦列表
- **排序服務**：根據多個因素重新排序
- **A/B 測試**：實驗不同推薦策略

#### 數據流

```
新聞源 → 爬蟲 → 內容處理 → 索引庫
                              ↓
用戶 → 行為收集 → 用戶畫像 → 推薦引擎 → 排序 → 用戶展示
                              ↑
                          特徵工程
```

### 2. 內容採集與處理

#### 新聞抓取

- **新聞源類型**：
  - **RSS Feed**：結構化數據，易於解析
  - **新聞網站爬蟲**：定期抓取網頁內容
  - **API 接口**：部分新聞平台提供 API
  - **內容合作**：與媒體直接合作

- **抓取頻率**：
  - 熱門源：每 5-15 分鐘抓取一次
  - 一般源：每 30 分鐘或 1 小時
  - 長尾源：每天抓取一次

- **增量抓取**：
  - 只抓取新增或更新的內容
  - 使用 ETag、Last-Modified 等機制
  - 減少頻寬和計算資源

#### 內容去重

新聞內容常有轉載和相似報導，需要去重。

- **文本指紋**：
  - 使用 SimHash 或 MinHash 算法
  - 將文本轉換為定長雜湊值
  - 相似文本的雜湊值漢明距離小

- **標題相似度**：
  - 計算標題的編輯距離或餘弦相似度
  - 相似度 > 閾值（如 0.8）視為重複

- **內容相似度**：
  - 使用 TF-IDF 或 BERT 提取文本特徵
  - 計算向量相似度
  - 聚類相似新聞

#### 內容分類與標籤

- **分類體系**：
  - **一級分類**：政治、經濟、科技、娛樂、體育等
  - **二級分類**：科技 → AI、區塊鏈、手機等
  - **標籤**：關鍵詞標籤（如「iPhone」、「馬斯克」）

- **自動分類**：
  - **傳統方法**：基於關鍵詞匹配或分類器（SVM、Naive Bayes）
  - **深度學習**：使用 BERT、GPT 等預訓練模型
  - **混合方法**：規則 + 機器學習

- **實體識別（NER）**：
  - 識別人名、地名、機構名
  - 提取關鍵實體作為標籤

#### 質量評估

- **內容質量指標**：
  - 文章長度（過短可能是廣告）
  - 圖片數量和質量
  - 來源可信度
  - 點擊誘餌檢測（Clickbait Detection）

- **過濾低質量內容**：
  - 廣告軟文
  - 標題黨
  - 虛假新聞

### 3. 用戶建模

#### 用戶行為收集

- **顯性反饋**：
  - 點讚、收藏、分享
  - 評論、關注
  - 主動訂閱某個分類或作者

- **隱性反饋**：
  - **點擊（Click）**：用戶點開文章（最常見）
  - **停留時間（Dwell Time）**：閱讀時長（更準確反映興趣）
  - **滑動行為**：快速滑過表示不感興趣
  - **完讀率**：是否讀完全文

- **負反饋**：
  - 點擊「不感興趣」
  - 舉報
  - 頻繁跳過某類內容

#### 用戶畫像構建

- **基礎屬性**：
  - 年齡、性別、地理位置
  - 設備類型、操作系統
  - 註冊時間、活躍度

- **興趣標籤**：
  - 根據閱讀歷史提取興趣標籤
  - 使用 TF-IDF 計算標籤權重
  - 範例：科技（0.8）、體育（0.3）、娛樂（0.1）

- **興趣衰減**：
  - 興趣會隨時間變化
  - 使用時間衰減函數降低舊興趣的權重
  - 公式：`weight = weight * exp(-λ * days)`

- **多維度畫像**：
  - **短期興趣**：最近 7 天的閱讀偏好
  - **長期興趣**：過去 90 天的穩定偏好
  - **實時興趣**：當前會話的即時興趣

#### 用戶分群

- **活躍度分群**：
  - 高活躍用戶（每天閱讀 > 10 篇）
  - 中活躍用戶（每週閱讀 3-10 篇）
  - 低活躍用戶（偶爾使用）

- **興趣廣度分群**：
  - 泛興趣用戶（閱讀各類內容）
  - 專業興趣用戶（只關注特定領域）

### 4. 推薦演算法

#### 召回階段（Recall）

從海量內容中快速篩選出候選集（如 500-1000 篇）。

**基於內容的召回（Content-Based）**：
- 根據用戶興趣標籤匹配新聞
- 用戶喜歡「科技」→ 召回所有科技類新聞
- 優點：簡單高效，解釋性強
- 缺點：無法發現新興趣

**協同過濾召回（Collaborative Filtering）**：
- **User-Based**：找相似用戶喜歡的內容
  - 用戶 A 和用戶 B 閱讀偏好相似
  - 推薦 B 喜歡但 A 未讀的內容
- **Item-Based**：找相似內容
  - 用戶讀過文章 X
  - 推薦與 X 相似的文章 Y
- 優點：能發現新興趣
- 缺點：冷啟動問題

**熱門召回（Trending）**：
- 召回近期熱門新聞
- 基於點擊率、分享數等指標
- 適合所有用戶

**地域召回（Geo-Based）**：
- 根據用戶位置推薦本地新聞
- 如台北用戶推薦台北新聞

**實時召回**：
- 突發事件的即時新聞
- 用戶當前會話的即時興趣

#### 排序階段（Ranking）

對召回的候選集進行精細排序，選出 Top-N 展示給用戶。

**特徵工程**：

- **用戶特徵**：
  - 興趣標籤及權重
  - 歷史點擊率、停留時長
  - 活躍時段、設備類型

- **內容特徵**：
  - 分類、標籤
  - 發布時間、來源
  - 文章長度、圖片數量
  - 歷史 CTR（點擊率）

- **交叉特徵**：
  - 用戶興趣與內容分類匹配度
  - 用戶歷史與內容來源的交互
  - 時段與內容類型的匹配（如早上推資訊，晚上推娛樂）

**排序模型**：

- **傳統模型**：
  - **邏輯迴歸（LR）**：簡單快速，可解釋性強
  - **GBDT**：處理非線性特徵，效果好

- **深度學習模型**：
  - **Wide & Deep**：結合記憶和泛化能力
  - **DeepFM**：自動學習特徵交互
  - **DIN（Deep Interest Network）**：建模用戶興趣演化
  - **Transformer**：捕捉序列依賴

- **多目標優化**：
  - 不僅優化點擊率（CTR）
  - 還優化停留時長（Dwell Time）、分享率等
  - 使用多任務學習（Multi-Task Learning）

#### 重排序階段（Re-ranking）

在排序結果基礎上調整，確保多樣性和業務規則。

**多樣性**：
- 避免連續推薦同一分類
- 打散相同來源的新聞
- 插入不同時效性的內容（最新 + 熱門 + 長青）

**業務規則**：
- 置頂合作媒體內容
- 過濾敏感或違規內容
- 控制廣告位置和頻率

**探索與利用（Exploration & Exploitation）**：
- **Exploitation**：推薦已知用戶喜歡的內容（高點擊率）
- **Exploration**：嘗試推薦用戶未接觸的內容（發現新興趣）
- 使用 ε-greedy、Thompson Sampling 等策略平衡

### 5. 實時推薦

#### 實時特徵計算

- **流式計算**：
  - 使用 Flink 或 Spark Streaming
  - 實時統計新聞的點擊量、CTR
  - 更新用戶的即時興趣

- **特徵快取**：
  - 將實時特徵快取在 Redis
  - 推薦時快速讀取

#### 在線學習（Online Learning）

- **增量更新模型**：
  - 不重新訓練整個模型
  - 使用新數據增量更新權重
  - 快速適應用戶興趣變化

- **A/B 測試**：
  - 同時運行多個模型版本
  - 實時比較效果
  - 選擇最優模型

### 6. 冷啟動問題

#### 新用戶冷啟動

- **熱門推薦**：
  - 推薦當前熱門新聞
  - 覆蓋多個分類，測試用戶興趣

- **引導註冊**：
  - 註冊時讓用戶選擇感興趣的主題
  - 快速建立初步畫像

- **利用設備信息**：
  - 根據地理位置推薦本地新聞
  - 根據時段推薦適合的內容

#### 新內容冷啟動

- **內容特徵**：
  - 基於標題、分類、標籤推薦
  - 不依賴歷史點擊數據

- **小流量試探**：
  - 新內容先推給少量用戶
  - 根據初期反饋決定是否擴大推送

- **遷移學習**：
  - 利用相似內容的歷史數據
  - 預測新內容的表現

### 7. 評估指標

#### 在線指標（Online Metrics）

- **點擊率（CTR）**：
  - 點擊數 / 曝光數
  - 最常用但不夠全面

- **停留時長（Dwell Time）**：
  - 用戶閱讀文章的時間
  - 更能反映內容質量

- **完讀率**：
  - 讀完全文的比例
  - 衡量內容吸引力

- **用戶留存**：
  - 次日留存率、7 日留存率
  - 衡量產品黏性

- **人均閱讀量**：
  - 每個用戶平均閱讀篇數
  - 衡量用戶活躍度

#### 離線指標（Offline Metrics）

- **AUC（Area Under Curve）**：
  - 衡量模型區分能力
  - 預測點擊的準確性

- **NDCG（Normalized Discounted Cumulative Gain）**：
  - 衡量排序質量
  - 考慮位置因素

- **覆蓋率（Coverage）**：
  - 被推薦的內容比例
  - 避免馬太效應

- **多樣性（Diversity）**：
  - 推薦列表的分類分散度
  - 避免資訊繭房

### 8. 架構設計

#### 離線計算層

- **特徵工程**：
  - 每天批次處理歷史數據
  - 生成用戶畫像和內容特徵
  - 儲存到特徵庫（如 Hive、HBase）

- **模型訓練**：
  - 使用大規模數據訓練模型
  - 定期更新模型（如每天訓練一次）
  - 使用分散式訓練框架（TensorFlow、PyTorch）

#### 近線計算層

- **準實時特徵**：
  - 使用 Spark Streaming 或 Flink
  - 計算小時級別的特徵更新
  - 如新聞的最近 1 小時點擊量

#### 在線服務層

- **推薦服務**：
  - 接收用戶請求
  - 調用召回、排序、重排序模組
  - 返回推薦列表

- **特徵服務**：
  - 提供實時特徵查詢
  - 快取熱點特徵

- **模型服務**：
  - 部署線上預測模型
  - 使用 TensorFlow Serving、TorchServe

#### 數據儲存

- **內容庫**：
  - Elasticsearch：全文檢索
  - MongoDB：儲存新聞詳情

- **用戶數據**：
  - MySQL：用戶基礎資訊
  - HBase：用戶行為日誌

- **特徵庫**：
  - Redis：實時特徵快取
  - HBase：離線特徵儲存

### 9. 內容安全

#### 敏感內容過濾

- **關鍵詞過濾**：
  - 維護敏感詞庫
  - 過濾暴力、色情、政治敏感內容

- **圖片審核**：
  - 使用 AI 識別不當圖片
  - 人工複審

#### 虛假新聞檢測

- **來源可信度**：
  - 評估新聞源的權威性
  - 降低不可靠源的權重

- **事實核查**：
  - 與多個來源交叉驗證
  - 標記未經證實的資訊

- **用戶舉報**：
  - 提供舉報功能
  - 快速響應處理

### 10. 優化與挑戰

#### 資訊繭房（Filter Bubble）

- **問題**：
  - 過度個人化導致用戶只看到相似內容
  - 視野狹窄，缺乏多元觀點

- **解決方案**：
  - 引入隨機推薦（Serendipity）
  - 定期推薦不同分類的內容
  - 提供「發現」頻道展示多元內容

#### 標題黨與低質量內容

- **問題**：
  - 標題黨騙取點擊但內容質量低
  - 影響用戶體驗

- **解決方案**：
  - 不僅優化 CTR，還優化停留時長
  - 檢測標題與內容的一致性
  - 懲罰低停留時長的高點擊內容

#### 時效性與長尾內容

- **問題**：
  - 新聞時效性強，舊新聞價值下降
  - 但部分長青內容（Evergreen Content）仍有價值

- **解決方案**：
  - 時間衰減函數降低舊新聞權重
  - 識別長青內容（教程、百科類），不進行時間衰減

#### 計算成本

- **問題**：
  - 深度學習模型推理成本高
  - 億級用戶的實時推薦挑戰大

- **解決方案**：
  - 模型壓縮（剪枝、量化、蒸餾）
  - 使用級聯模型（簡單模型先篩選，複雜模型再精排）
  - GPU 加速推理

## 架構總結

一個完整的新聞推薦系統架構包含：

1. **內容層**：爬蟲、內容處理、去重、分類、索引
2. **數據層**：用戶行為收集、日誌儲存、數據倉庫
3. **計算層**：
   - 離線：特徵工程、模型訓練、用戶畫像
   - 近線：流式計算、準實時特徵
   - 在線：推薦服務、排序服務
4. **服務層**：API Gateway、推薦 API、內容 API
5. **展示層**：客戶端 App、Web、小程序

新聞推薦系統是**機器學習在實際產品中的典型應用**，涉及內容理解、用戶建模、推薦演算法、大數據處理等多個領域。設計時需要平衡**個人化**與**多樣性**、**點擊率**與**內容質量**、**實時性**與**計算成本**，持續優化以提供更好的用戶體驗。
