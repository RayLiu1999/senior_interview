# 如何設計支付系統？

- **難度**: 9
- **重要程度**: 5
- **標籤**: `System Design`, `Payment`, `Transaction`, `Security`

## 問題詳述

支付系統是電商、金融科技的核心基礎設施，需要處理資金流轉、保證交易安全、滿足監管要求。請設計一個可靠、安全的支付系統，需要考慮：

1. **核心功能**：如何實現充值、提現、轉帳、支付等功能？
2. **資金安全**：如何確保資金不丟失、不重複扣款？
3. **一致性**：如何保證分散式環境下的帳務一致性？
4. **風控**：如何防範欺詐、洗錢等風險？
5. **合規性**：如何滿足金融監管要求？

## 核心理論與詳解

支付系統是對可靠性、安全性、一致性要求最高的系統之一，任何錯誤都可能造成直接的財務損失。

### 1. 核心概念與業務流程

#### 支付系統的角色

- **用戶（User）**：發起支付的個人或商戶
- **商戶（Merchant）**：接受支付的賣家
- **支付平台（Payment Platform）**：提供支付服務的中間平台
- **支付網關（Payment Gateway）**：連接支付平台和銀行/第三方支付
- **銀行/第三方支付**：實際的資金清算機構
- **監管機構**：金融監管部門

#### 典型支付流程

以電商購物為例：

1. **下單**：用戶選擇商品，創建訂單
2. **發起支付**：用戶選擇支付方式（信用卡、支付寶等）
3. **路由**：支付網關將請求路由到對應的支付渠道
4. **扣款**：支付渠道從用戶帳戶扣款
5. **通知**：支付渠道非同步通知支付結果
6. **確認**：支付平台確認支付成功，通知商戶發貨
7. **清算**：定期與支付渠道對帳和清算

### 2. 核心功能設計

#### 充值（Deposit）

用戶將資金從銀行帳戶轉入平台帳戶。

- **流程**：
  1. 用戶發起充值請求，選擇金額和支付方式
  2. 系統創建充值訂單（狀態：待支付）
  3. 跳轉到支付網關頁面
  4. 用戶完成支付
  5. 支付網關非同步通知充值結果
  6. 系統更新訂單狀態，增加用戶餘額

- **關鍵點**：
  - 訂單冪等性：防止重複充值
  - 非同步回調處理：可靠接收支付結果
  - 帳戶變動記錄：記錄每筆帳變

#### 提現（Withdrawal）

用戶將資金從平台帳戶轉出到銀行帳戶。

- **流程**：
  1. 用戶發起提現請求
  2. 系統驗證餘額、提現限額、身份認證
  3. 凍結用戶餘額（扣減可用餘額，增加凍結餘額）
  4. 創建提現訂單，提交到提現隊列
  5. 後台任務處理提現（調用銀行 API 轉帳）
  6. 轉帳成功：扣減凍結餘額，記錄帳變
  7. 轉帳失敗：解凍餘額，更新訂單狀態

- **關鍵點**：
  - 餘額凍結：防止重複提現
  - 非同步處理：提現可能耗時較長
  - 失敗重試：網路問題需要重試機制
  - T+N 到帳：提現通常不是即時到帳

#### 支付（Payment）

用戶向商戶支付資金。

- **流程**：
  1. 商戶創建支付訂單
  2. 用戶選擇支付方式並確認
  3. 系統扣減用戶餘額或調用第三方支付
  4. 增加商戶帳戶餘額（或標記待清算）
  5. 通知商戶支付成功
  6. 記錄交易流水

- **支付方式**：
  - **餘額支付**：直接扣減平台內餘額
  - **第三方支付**：支付寶、微信支付、PayPal
  - **銀行卡支付**：信用卡、簽帳卡
  - **組合支付**：餘額 + 第三方支付

#### 退款（Refund）

將已支付的資金退回給用戶。

- **流程**：
  1. 商戶或用戶發起退款請求
  2. 系統驗證訂單狀態和退款金額
  3. 扣減商戶餘額（或從待清算金額扣除）
  4. 增加用戶餘額或原路退回
  5. 更新訂單狀態，記錄退款流水

- **退款類型**：
  - **全額退款**：退回全部金額
  - **部分退款**：退回部分金額
  - **原路退回**：退回到原支付方式
  - **退到餘額**：退回到平台餘額

### 3. 帳戶系統設計

#### 帳戶模型

- **用戶帳戶表**：
  - `user_id`：用戶 ID
  - `balance`：可用餘額
  - `frozen_balance`：凍結餘額（提現中、爭議中）
  - `total_balance`：總餘額（balance + frozen_balance）
  - `version`：樂觀鎖版本號

- **帳變記錄表**：
  - `log_id`：流水號（全域唯一）
  - `user_id`：用戶 ID
  - `amount`：變動金額（正數為增加，負數為扣減）
  - `balance_before`：變動前餘額
  - `balance_after`：變動後餘額
  - `type`：變動類型（充值、提現、支付、退款）
  - `order_id`：關聯訂單 ID
  - `timestamp`：時間戳

#### 餘額更新策略

- **樂觀鎖**：
  ```
  UPDATE accounts 
  SET balance = balance - ?, version = version + 1 
  WHERE user_id = ? AND version = ? AND balance >= ?
  ```
  - 檢查版本號和餘額充足性
  - 更新失敗則重試

- **悲觀鎖**：
  ```
  SELECT * FROM accounts WHERE user_id = ? FOR UPDATE
  ```
  - 鎖定帳戶記錄後再更新
  - 適合衝突較多的場景

#### 帳戶一致性保證

- **借貸平衡**：
  - 所有交易必須符合複式記帳原則
  - 每筆交易都有借方和貸方，金額相等
  - 系統總資金量守恆

- **帳實相符**：
  - 帳戶餘額 = 初始餘額 + 所有帳變記錄之和
  - 定期對帳驗證一致性

### 4. 訂單與流水

#### 訂單表設計

- **支付訂單表**：
  - `order_id`：訂單號（全域唯一）
  - `user_id`：用戶 ID
  - `merchant_id`：商戶 ID
  - `amount`：訂單金額
  - `status`：訂單狀態（待支付、支付中、成功、失敗、已退款）
  - `payment_method`：支付方式
  - `payment_channel`：支付渠道
  - `external_order_id`：第三方訂單號
  - `created_at`：創建時間
  - `paid_at`：支付完成時間

#### 狀態機設計

支付訂單的狀態流轉：

- **待支付（Pending）** → 支付中（Processing）
- **支付中** → 支付成功（Success）
- **支付中** → 支付失敗（Failed）
- **支付成功** → 已退款（Refunded）
- **待支付** → 已取消（Cancelled）

#### 流水記錄

- **交易流水表**：
  - 記錄每筆資金流動
  - 包含訂單 ID、金額、時間、類型等
  - 用於對帳和審計

- **不可篡改性**：
  - 流水記錄只能新增，不能修改或刪除
  - 使用區塊鏈技術進一步保證不可篡改

### 5. 分散式事務處理

支付涉及多個系統（訂單、帳戶、庫存），需要保證事務一致性。

#### 本地消息表模式

- **實現**：
  1. 在本地資料庫事務中同時寫入業務數據和消息表
  2. 事務提交後，消息表記錄可見
  3. 後台任務掃描消息表，發送消息到 MQ
  4. 消費者處理消息，更新其他系統狀態
  5. 處理成功後刪除或標記消息

- **優勢**：
  - 利用本地事務保證消息一定發送
  - 最終一致性

#### TCC（Try-Confirm-Cancel）

- **三階段**：
  - **Try**：預留資源（如凍結餘額）
  - **Confirm**：確認操作（如扣減凍結餘額）
  - **Cancel**：取消操作（如解凍餘額）

- **適用場景**：
  - 需要強一致性的場景
  - 如支付 + 扣庫存

#### Saga 模式

- **長事務拆分**：
  - 將長事務拆分為多個本地短事務
  - 每個事務有對應的補償事務
  - 一個事務失敗則執行之前所有事務的補償

- **範例**：
  - 支付 → 扣庫存 → 創建訂單
  - 失敗時：取消訂單 → 恢復庫存 → 退款

### 6. 冪等性設計

支付系統必須保證冪等性，防止重複扣款。

#### 冪等鍵

- **訂單 ID 作為冪等鍵**：
  - 相同訂單 ID 的請求只處理一次
  - 使用 Redis 或資料庫唯一索引保證

- **實現**：
  ```
  1. 檢查訂單是否已處理
  2. 如果已處理，直接返回之前的結果
  3. 如果未處理，處理請求並記錄結果
  ```

#### 防重複提交

- **前端防重**：
  - 提交按鈕點擊後立即禁用
  - 使用 Token 機制（一次性 Token）

- **後端防重**：
  - 使用分散式鎖（Redis）
  - 設置請求處理窗口期（如 1 分鐘內相同請求視為重複）

### 7. 非同步通知處理

第三方支付通常透過 Webhook 非同步通知結果。

#### 通知接收

- **驗證簽名**：
  - 驗證請求來自合法的支付渠道
  - 使用 HMAC 或 RSA 簽名驗證

- **冪等處理**：
  - 同一筆訂單可能收到多次通知
  - 使用訂單 ID 保證冪等性

- **快速響應**：
  - 接收通知後立即返回 200 OK
  - 非同步處理業務邏輯（消息隊列）

#### 通知重試

- **主動查詢**：
  - 如果長時間未收到通知，主動查詢支付狀態
  - 定時任務掃描「支付中」的訂單

- **對帳補償**：
  - 定期與支付渠道對帳
  - 發現不一致時進行補償處理

### 8. 風控系統

#### 實時風控

- **規則引擎**：
  - 大額交易告警（單筆 > X 元）
  - 高頻交易限制（N 秒內 M 筆）
  - 異常時段交易（凌晨交易）
  - IP 地址異常（頻繁更換、境外 IP）

- **機器學習模型**：
  - 根據歷史行為建模
  - 識別異常交易模式
  - 評估欺詐風險分數

#### 風險處理

- **交易攔截**：
  - 高風險交易直接拒絕
  - 中風險交易要求二次驗證（簡訊、人臉識別）

- **帳戶凍結**：
  - 可疑帳戶臨時凍結
  - 人工審核後決定是否解凍

- **黑名單管理**：
  - 維護欺詐用戶、設備、IP 黑名單
  - 黑名單用戶無法進行交易

### 9. 對帳系統

#### 對帳類型

- **內部對帳**：
  - 訂單金額 vs. 帳變金額
  - 帳戶餘額 vs. 帳變記錄累計
  - 發現不一致時告警

- **外部對帳**：
  - 與支付渠道對帳
  - 比對交易筆數和金額
  - 定期（如每日）進行對帳

#### 對帳流程

1. **獲取對帳文件**：
   - 從支付渠道下載對帳文件（CSV、Excel）
   - 解析文件獲取交易明細

2. **比對**：
   - 將平台訂單與對帳文件逐筆比對
   - 檢查訂單號、金額、狀態是否一致

3. **差異處理**：
   - **長款**：對帳文件有，平台沒有（可能通知丟失）
   - **短款**：平台有，對帳文件沒有（可能支付失敗）
   - **金額不符**：訂單金額與實際支付金額不一致

4. **補償**：
   - 根據差異類型進行補償處理
   - 記錄對帳日誌供審計

### 10. 安全設計

#### 資料加密

- **敏感資訊加密**：
  - 銀行卡號、密碼使用 AES 加密儲存
  - 使用 HTTPS 傳輸

- **密鑰管理**：
  - 使用 KMS（Key Management Service）管理密鑰
  - 定期輪換密鑰

#### 身份認證

- **多因素認證（MFA）**：
  - 密碼 + 簡訊驗證碼
  - 生物識別（指紋、人臉）

- **支付密碼**：
  - 獨立的支付密碼或 PIN
  - 連續錯誤後鎖定

#### 防範攻擊

- **SQL 注入**：使用參數化查詢
- **XSS 攻擊**：輸入驗證和輸出轉義
- **CSRF 攻擊**：使用 CSRF Token
- **重放攻擊**：使用時間戳和 Nonce
- **中間人攻擊**：強制使用 HTTPS

### 11. 合規與審計

#### 金融監管

- **反洗錢（AML）**：
  - 大額交易報告
  - 可疑交易監控
  - 客戶身份識別（KYC）

- **資料留存**：
  - 交易記錄至少保存 5-10 年
  - 滿足監管機構查詢需求

#### 審計日誌

- **操作日誌**：
  - 記錄所有關鍵操作（誰、何時、做了什麼）
  - 支援審計追溯

- **不可篡改**：
  - 日誌只能追加，不能修改
  - 使用區塊鏈或默克爾樹保證完整性

### 12. 高可用架構

#### 多機房部署

- **同城雙活**：
  - 兩個機房同時提供服務
  - 資料庫雙向同步
  - 任一機房故障，流量切換到另一機房

- **異地災備**：
  - 遠距離機房作為災備
  - 定期備份和演練

#### 限流降級

- **限流**：
  - API 級別的限流（QPS 限制）
  - 用戶級別的限流（防刷單）

- **降級**：
  - 非核心功能降級（如推薦、統計）
  - 核心功能（支付）優先保證

#### 資料備份

- **實時備份**：
  - 資料庫主從複製
  - Binlog 備份

- **定期備份**：
  - 每日全量備份
  - 增量備份

### 13. 性能優化

#### 資料庫優化

- **讀寫分離**：
  - 寫入走主庫
  - 查詢走從庫

- **分庫分表**：
  - 按用戶 ID 分表
  - 按時間歸檔歷史數據

#### 快取使用

- **帳戶餘額快取**：
  - 熱點帳戶快取在 Redis
  - 快取失效時從資料庫讀取

- **訂單狀態快取**：
  - 快取訂單狀態，減少資料庫查詢

#### 非同步處理

- **消息隊列**：
  - 非核心操作非同步處理（如發送通知）
  - 削峰填谷

## 架構總結

一個完整的支付系統架構包含：

1. **接入層**：API Gateway、負載均衡、防火牆
2. **業務層**：支付服務、帳戶服務、訂單服務、風控服務
3. **路由層**：支付網關、渠道路由
4. **資料層**：訂單資料庫、帳戶資料庫、流水資料庫
5. **快取層**：Redis（餘額快取、分散式鎖）
6. **消息隊列**：Kafka（非同步通知、對帳任務）
7. **第三方對接**：支付渠道（支付寶、微信、銀行）
8. **輔助系統**：風控系統、對帳系統、監控告警

支付系統的設計核心是**資金安全**和**資料一致性**。透過冪等性設計、分散式事務、對帳機制、風控系統等多層保障，確保每一筆交易都準確無誤，這是支付系統最基本也是最重要的要求。
