# 什麼是服務發現？它在微服務架構中有哪些模式？

- **難度**: 7
- **重要程度**: 4
- **標籤**: `Microservice`, `Service Discovery`, `System Design`

## 問題詳述

在動態的微服務環境中，服務的實例（IP 位址和埠號）是經常變動的。請解釋什麼是「服務發現」，並描述幾種常見的服務發現模式。

## 核心理論與詳解

### 什麼是服務發現？

服務發現 (Service Discovery) 是微服務架構中的一個核心元件，它解決了一個基本問題：**一個服務（客戶端或 API Gateway）如何找到另一個服務的網路位址（IP 和埠號）？**

在傳統的單體應用或靜態環境中，服務的位址通常是固定的，可以寫在設定檔裡。但在微服務環境中，由於自動擴展 (Auto-scaling)、故障轉移 (Failover) 和滾動更新 (Rolling updates)，服務實例會被動態地建立和銷毀，導致其網路位址頻繁變動。因此，硬編碼位址的方式不再可行。

服務發現機制提供了一個中央化的「目錄」或「註冊表」（Service Registry），用於追蹤所有可用服務實例的即時狀態和位址。

其工作流程通常包含兩個階段：

1. **服務註冊 (Service Registration)**: 當一個新的服務實例啟動時，它會主動將自己的位址（IP、埠號）以及一些元資料（如服務名稱、版本號）註冊到服務註冊表中。實例也需要定期發送「心跳」(Heartbeat) 來表明自己仍然存活。
2. **服務查詢 (Service Query/Discovery)**: 當一個客戶端服務需要與另一個目標服務通訊時，它會向服務註冊表查詢目標服務的可用實例列表，然後從中選擇一個（通常會結合負載平衡策略）來發送請求。

![服務發現流程](https://i.imgur.com/y3jB2fA.png)

### 常見的服務發現模式

主要有兩種服務發現的模式：**客戶端發現**和**伺服器端發現**。

#### 1. 客戶端發現模式 (Client-Side Discovery)

在這種模式下，客戶端服務直接負責與服務註冊表進行互動。

- **流程**:
  1. 客戶端向服務註冊表發起查詢，請求目標服務（例如 "Order-Service"）的所有可用實例列表。
  2. 服務註冊表返回一個包含多個 `IP:Port` 的列表。
  3. 客戶端內建的負載平衡器 (Load Balancer) 根據某種策略（如輪詢 Round Robin、隨機、最少連接等）從列表中選擇一個實例。
  4. 客戶端直接向選定的服務實例發起請求。

- **圖示**:
  ![客戶端發現](https://i.imgur.com/L6g3e4c.png)

- **優點**:
  - **架構簡單**: 客戶端直接與註冊表通訊，中間環節少。
  - **智慧負載平衡**: 客戶端可以根據自身需求和對後端服務的了解，實現更智慧的負載平衡策略（例如，基於延遲或負載的策略）。

- **缺點**:
  - **客戶端耦合**: 需要為每種程式語言和框架都實作一套服務發現的邏輯，導致客戶端程式碼與服務發現基礎設施緊密耦合。
  - **維護成本高**: 如果服務發現的邏輯需要更新，所有客戶端都需要同步更新。

- **範例**: Netflix Eureka（在其 1.x 版本中廣泛使用此模式）、gRPC 的 Name Resolver。

#### 2. 伺服器端發現模式 (Server-Side Discovery)

在這種模式下，客戶端將服務發現的任務交給了一個中介元件，通常是負載平衡器或 API Gateway。

- **流程**:
  1. 客戶端向一個固定的中介（如負載平衡器）的端點發送請求。它只需要知道這個中介的位址，而不需要知道後端具體服務的位址。
  2. 該中介（負載平衡器）負責查詢服務註冊表，獲取目標服務的可用實例列表。
  3. 中介根據其內建的負載平衡演算法，從列表中選擇一個實例。
  4. 中介將請求轉發到選定的服務實例。

- **圖示**:
  ![伺服器端發現](https://i.imgur.com/3hJb8fG.png)

- **優點**:
  - **客戶端解耦**: 客戶端程式碼變得非常簡單，它不需要關心任何服務發現的細節，就像呼叫一個普通的遠端服務一樣。
  - **集中管理**: 服務發現和負載平衡的邏輯都集中在中介元件中，易於管理和升級。
  - **語言無關**: 對客戶端使用的程式語言沒有任何限制。

- **缺點**:
  - **額外的網路跳躍**: 請求需要先經過中介，可能會增加一點網路延遲。
  - **中介的可用性**: 該中介元件成為了另一個需要保證高可用的關鍵節點。

- **範例**: AWS Elastic Load Balancer (ELB)、Kubernetes (K8s) 的 Service 機制（通過 Kube-proxy 和 DNS 實現）、硬體負載平衡器（如 F5）。

## 總結

| 特性 | 客戶端發現模式 | 伺服器端發現模式 |
| :--- | :--- | :--- |
| **核心思想** | 客戶端自己查詢註冊表並選擇實例 | 客戶端通過一個中介來呼叫服務 |
| **負載平衡位置** | 客戶端內部 | 路由器或負載平衡器上 |
| **優點** | 架構簡單、可實現智慧負載平衡 | 客戶端無感知、集中管理、語言無關 |
| **缺點** | 與客戶端程式碼耦合、維護成本高 | 增加網路跳躍、中介需要高可用 |
| **適用場景** | 內部服務間呼叫，對效能和靈活性要求高 | 對外暴露服務，或在多語言環境中 |

在現代的雲原生環境中，**伺服器端發現模式**更為普遍，特別是在像 Kubernetes 這樣的容器編排平臺中，其內建的 Service 和 DNS 機制為應用提供了透明的服務發現能力，極大地簡化了開發者的工作。

常見的服務註冊表實作包括：Consul, etcd, Zookeeper, 和 Kubernetes DNS。
