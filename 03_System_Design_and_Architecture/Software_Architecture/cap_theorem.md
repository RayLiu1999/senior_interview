# CAP 定理

- **難度**: 7
- **重要性**: 5
- **標籤**: `Distributed Systems`, `System Design`, `CAP Theorem`

## 問題詳述

請解釋什麼是 CAP 定理。在一個分散式系統中，這三個屬性（一致性、可用性、分區容錯性）的含義是什麼？為什麼在實際系統中，我們通常需要在一致性 (C) 和可用性 (A) 之間做出權衡？

## 核心理論與詳解

CAP 定理，由電腦科學家 Eric Brewer 提出，是分散式系統設計中最基礎也是最重要的理論之一。它指出，任何一個分散式系統**最多只能同時滿足以下三個屬性中的兩個**：

1.  **一致性 (Consistency)**
2.  **可用性 (Availability)**
3.  **分區容錯性 (Partition Tolerance)**

---

### CAP 三大屬性詳解

#### 1. 一致性 (Consistency)

-   **定義**: 這裡的一致性指的是**強一致性 (Strong Consistency)** 或**線性一致性 (Linearizability)**。它要求在任何時間點，所有節點上的資料副本都是一樣的。當一次寫入操作完成後，任何後續的讀取請求（無論發送到哪個節點）都必須返回這個最新的值。
-   **表現**: 對於使用者來說，系統就像只有一個單一的、永遠保持最新的資料副本。

#### 2. 可用性 (Availability)

-   **定義**: 它要求系統中的每個**非故障節點**對於收到的任何請求，都必須在有限的時間內給出回應（不能是錯誤或超時）。
-   **表現**: 只要系統還在運行，它就必須對使用者的操作做出反應。它不保證返回的資料是最新版本，但保證一定會有回應。

#### 3. 分區容錯性 (Partition Tolerance)

-   **定義**: 這是分散式系統的**基本要求**。它指的是系統必須能夠在網路發生分區（即節點之間的通訊中斷）的情況下，仍然能夠繼續運行。
-   **表現**: 即使部分節點因為網路問題而彼此失聯，整個系統仍然不會因此而完全崩潰。

### 為什麼必須在 C 和 A 之間做出選擇？

在一個分散式系統中，網路故障是不可避免的，因此**分區容錯性 (P) 是一個必須滿足的前提**，而不是一個可選項。如果系統不具備分區容錯性，那它就不是一個真正的分散式系統。

因此，當網路分區 (P) 發生時，我們必須在一致性 (C) 和可用性 (A) 之間做出艱難的選擇。

讓我們用一個簡單的例子來說明：一個包含兩個節點（N1 和 N2）的分散式資料庫。

1.  **初始狀態**: N1 和 N2 之間通訊正常，它們都儲存著 `value = v0`。
2.  **網路分區發生**: N1 和 N2 之間的網路中斷，它們無法再互相通訊。
3.  **寫入請求**: 此時，一個寫入請求 `update(value = v1)` 到達了節點 N1。

現在，節點 N1 面臨一個抉擇：

-   **選擇一致性 (C)，放棄可用性 (A) -> CP 系統**:
    -   為了保證強一致性，N1 必須將 `v1` 這個更新同步到 N2。但由於網路分區，N1 無法聯繫到 N2。
    -   為了不破壞一致性，N1 只能**拒絕**這個寫入請求，或者讓請求無限期等待，直到網路恢復。
    -   在這種情況下，系統雖然保持了資料的一致性（因為沒有新資料被寫入），但它卻失去了**可用性**，因為它無法對寫入請求做出成功的回應。
    -   **常見系統**: 傳統的關聯式資料庫（如 MySQL Cluster）、ZooKeeper、HBase。

-   **選擇可用性 (A)，放棄一致性 (C) -> AP 系統**:
    -   為了保證可用性，N1 必須對寫入請求做出回應。因此，N1 在本地更新了 `value = v1`，並向客戶端返回「成功」。
    -   此時，N1 的資料是 `v1`，而 N2 的資料仍然是 `v0`。系統出現了**資料不一致**。
    -   在這種情況下，系統雖然保持了可用性，但它犧牲了強一致性。它只能承諾在未來某個時間點（當網路分區恢復後）透過某種機制（如資料同步）來解決這個衝突，最終達到**最終一致性 (Eventual Consistency)**。
    -   **常見系統**: 大多數 NoSQL 資料庫，如 Cassandra, DynamoDB, CouchDB。

### 現實世界中的 CAP

-   **CA 系統？**: 理論上，如果一個系統不需要考慮網路分區（例如，一個單機資料庫），那麼它可以同時滿足 C 和 A。但在分散式系統的範疇內，CA 系統幾乎沒有實際意義。

-   **BASE 理論**: 作為對 AP 系統的補充，BASE 理論（Basically Available, Soft state, Eventual consistency）描述了這類系統的特性，即犧牲強一致性來換取高可用性。

### 結論

CAP 定理為分散式系統的設計提供了根本性的指導。它迫使架構師在設計系統時必須明確：當網路不可靠時，我們的系統是優先保證資料的絕對一致，還是優先保證服務的持續可用。

-   對於需要強烈資料一致性的場景（如金融交易、銀行帳戶），通常會選擇 **CP** 架構。
-   對於追求高可用性和可擴展性的場景（如社交網路的動態、電商的商品評論），通常會選擇 **AP** 架構，並接受最終一致性。

理解這個權衡是設計和評估任何一個分散式系統的第一步。
