# NATS 的 Core NATS 和 JetStream 有什麼區別？

- **難度**: 4
- **重要程度**: 5
- **標籤**: `NATS`, `JetStream`, `Message Queue`

## 問題詳述

NATS 提供了兩種主要的訊息傳遞模式：核心的 NATS (Core NATS) 和 JetStream。請詳細比較這兩者在功能、傳遞保證、效能和適用場景上的主要區別。

## 核心理論與詳解

Core NATS 和 JetStream 是 NATS 系統中兩個不同層級的功能集，它們共同構成了一個靈活且強大的訊息平台。理解它們的區別對於正確選擇和使用 NATS 至關重要。

### Core NATS：輕量、高速的「即發即忘」模型

Core NATS 是 NATS 的基礎，提供了一個極其高效能、低延遲的訊息傳遞層。它的核心特性可以總結為「即發即忘」(Fire-and-Forget)。

- **傳遞保證**:
  - **At-Most-Once (最多一次)**: 這是 Core NATS 的唯一傳遞保證。系統會盡最大努力將訊息傳遞給訂閱者，但如果訂閱者離線、網路中斷或處理緩慢，訊息 **可能會丟失**。它不保證訊息一定會到達。

- **持久化**:
  - **無持久化**: 訊息是純粹的「空中飛人」(in-flight)。一旦發布，如果沒有任何在線的訂閱者，訊息就會立即消失。伺服器不會為了稍後的傳遞而儲存訊息。

- **效能**:
  - **極致效能**: 由於其簡單的協議和無持久化的設計，Core NATS 的吞吐量極高，延遲極低（通常在微秒級）。

- **核心功能**:
  - **發布-訂閱 (Pub-Sub)**: 一個發布者，多個訂閱者。
  - **請求-回覆 (Request-Reply)**: 點對點或與佇列群組的通訊。
  - **佇列群組 (Queue Groups)**: 多個訂閱者訂閱同一個主題，但只有一個成員會隨機收到訊息，從而實現負載平衡。

- **適用場景**:
  - **高效能的即時通訊**: 如物聯網感測器資料採集、金融市場資料分發、線上遊戲狀態同步等。
  - **服務發現與心跳檢測**: 微服務之間互相發現或發送健康檢查信號。
  - **可容忍訊息丟失的場景**: 當最新資料比歷史資料更重要時，例如每秒都在更新的儀表板資料。
  - **命令與控制系統**: 向大量設備廣播指令。

### NATS JetStream：可靠、持久化的「串流」模型

JetStream 是建立在 Core NATS 之上的持久化層，它為 NATS 增加了更強的傳遞保證和更豐富的功能，使其能夠與 Kafka、RabbitMQ 等傳統訊息佇列競爭。

- **傳遞保證**:
  - **At-Least-Once (至少一次)**: 系統保證訊息至少會被傳遞一次。消費者需要對收到的訊息進行「確認 (Acknowledge)」。如果在確認超時前沒有收到確認，JetStream 會重新發送該訊息。這可能導致重複消費，應用程式需要具備冪等性。
  - **Exactly-Once (恰好一次)**: 在特定條件下（如使用具有唯一 ID 的訊息），JetStream 可以提供恰好一次的傳遞語義，防止重複處理。

- **持久化**:
  - **訊息串流 (Streams)**: JetStream 將訊息儲存在稱為「串流」的持久化結構中。串流可以配置為基於檔案 (File-based) 或基於記憶體 (Memory-based)。
  - **保留策略 (Retention Policies)**: 可以定義訊息在串流中保留多久，例如基於訊息數量、總大小或時間。

- **效能**:
  - **高效能**: 雖然增加了持久化和確認機制，JetStream 的效能依然非常出色，但相較於 Core NATS，延遲會更高，吞吐量會因磁碟 I/O 而有所降低。

- **核心功能**:
  - **訊息串流 (Streams)**: 持久化的、可重播的訊息日誌。
  - **消費者 (Consumers)**:
    - **Push Consumers**: JetStream 主動將訊息推送給消費者。
    - **Pull Consumers**: 消費者按需從串流中拉取訊息。
    - 消費者是持久化的，可以追蹤自己的消費進度。
  - **時間旅行 (Time Travel)**: 消費者可以從串流的任意位置（如按序列號或時間戳）開始消費，實現訊息重播。
  - **Key-Value Store & Object Store**: JetStream 在其串流的基礎上，還提供了鍵值儲存和物件儲存的抽象，擴展了其應用場景。

- **適用場景**:
  - **關鍵業務事件處理**: 如訂單處理、支付系統、庫存變更等不允許訊息丟失的場景。
  - **事件溯源 (Event Sourcing)**: 將所有狀態變更作為事件記錄在持久化的串流中。
  - **資料整合與 ETL**: 在不同系統之間可靠地傳輸資料。
  - **需要訊息重播的分析系統**: 當新的分析服務上線時，可以從頭開始消費歷史資料。

### 總結比較表

| 特性 | Core NATS | NATS JetStream |
| :--- | :--- | :--- |
| **核心模型** | 即發即忘 (Fire-and-Forget) | 日誌串流 (Log-based Stream) |
| **傳遞保證** | 最多一次 (At-Most-Once) | 至少一次 (At-Least-Once), 恰好一次 |
| **持久化** | 否 (In-Memory) | 是 (Memory 或 File) |
| **訊息重播** | 不支援 | 支援 (時間旅行) |
| **消費者模型** | 簡單訂閱 | 持久化消費者 (Push/Pull) |
| **效能** | 極高吞吐量，極低延遲 | 高吞吐量，較低延遲 |
| **主要用途** | 高速、短暫的訊息傳遞 | 可靠、持久的事件串流 |

**簡單來說**:

- 如果你需要一個 **極其快速、輕量** 的通訊骨幹，並且可以接受在極端情況下 **丟失少量訊息**，那麼 **Core NATS** 是你的不二之選。
- 如果你需要 **可靠的訊息傳遞**、**資料持久化** 和 **訊息重播** 能力，那麼你應該使用 **NATS JetStream**。

在實際應用中，兩者經常結合使用。例如，使用 Core NATS 進行頻繁的狀態更新和心跳檢測，同時使用 JetStream 處理關鍵的業務交易。這正是 NATS 設計的優雅之處。
