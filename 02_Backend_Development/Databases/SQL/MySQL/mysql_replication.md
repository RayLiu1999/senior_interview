# 請解釋 MySQL 的主從複製 (Replication) 機制及其主要用途

- **難度**: 7
- **標籤**: `MySQL`, `Replication`, `High Availability`, `Scalability`

## 問題詳述

MySQL 的主從複製是構建高可用、可擴展資料庫架構的基礎。請詳細解釋主從複製的工作原理，包括其涉及的核心執行緒和日誌檔案，並說明其常見的應用場景。

## 核心理論與詳解

主從複製 (Master-Slave Replication) 是指將一台 MySQL 伺服器（稱為主庫，Master）的資料變更，非同步地複製到另一台或多台 MySQL 伺服器（稱為從庫，Slave）的過程。這個過程使得從庫能夠擁有與主庫幾乎即時同步的資料副本。

### 主從複製的核心原理

MySQL 的主從複製主要依賴於三個核心執行緒和一個關鍵的日誌檔案——二進位日誌 (Binary Log, binlog)。

#### 關鍵元件

1. **二進位日誌 (Binary Log)**:
    - 這是主庫上的一個日誌檔案，它以「事件 (Event)」的形式記錄了所有會修改資料庫的 DDL (資料定義語言) 和 DML (資料操作語言) 操作。
    - `SELECT` 等不修改資料的操作不會被記錄。
    - Binlog 是主從複製的資料來源和基礎。主庫將資料變更寫入 Binlog，從庫則通過讀取和重放 (Replay) Binlog 來實現資料同步。
    - Binlog 有三種格式：
      - **`STATEMENT`**: 記錄原始的 SQL 語句。優點是日誌量小，缺點是某些情況下可能導致主從資料不一致（例如，使用了 `UUID()`、`NOW()` 等不確定性函數）。
      - **`ROW`**: 記錄每一行資料被修改的具體細節。優點是能保證絕對的資料一致性，缺點是日誌量較大。**這是目前推薦和預設的格式**。
      - **`MIXED`**: 混合模式，MySQL 會根據 SQL 語句的類型自動選擇使用 `STATEMENT` 或 `ROW` 格式。

2. **主庫執行緒 (Master Threads)**:
    - **Binlog Dump Thread**: 當從庫連接到主庫時，主庫會為其創建一個 Binlog Dump 執行緒。這個執行緒負責讀取主庫的 Binlog 事件，並將其發送給從庫。

3. **從庫執行緒 (Slave Threads)**:
    - **I/O Thread**: 從庫上的 I/O 執行緒會連接到主庫的 Binlog Dump 執行緒，接收主庫發送過來的 Binlog 事件，並將其寫入到從庫本地的一個稱為「中繼日誌 (Relay Log)」的檔案中。
    - **SQL Thread**: 從庫上的 SQL 執行緒會讀取中繼日誌 (Relay Log) 中的事件，並在從庫的資料庫中「重放」這些事件，從而將變更應用到從庫的資料上。

#### 複製過程的三個步驟

1. **主庫寫入 Binlog**: 主庫在執行完一個寫操作後，會將該操作的事件記錄到 Binlog 中。
2. **從庫拉取並寫入 Relay Log**: 從庫的 I/O 執行緒連接主庫，請求從指定位置開始的 Binlog，並將獲取到的事件寫入到本地的 Relay Log。
3. **從庫重放 Relay Log**: 從庫的 SQL 執行緒讀取 Relay Log 中的事件，並在本地資料庫中執行，完成資料同步。

這個過程是 **非同步** 的，這意味著在主庫完成一個操作和從庫應用該操作之間，存在一個時間延遲，稱為 **複製延遲 (Replication Lag)**。

### 主從複製的主要用途

1. **讀寫分離 (Read/Write Splitting)**:
    - 這是主從複製最經典的應用場景。在一個讀多寫少的應用中，可以將所有的寫操作（`INSERT`, `UPDATE`, `DELETE`）都指向主庫，而將所有的讀操作（`SELECT`）負載均衡地分散到多個從庫上。
    - **優點**:
      - 極大地分散了讀取壓力，提高了整個系統的查詢效能和吞吐量。
      - 使得主庫可以專注於處理寫操作，減少鎖競爭。
    - **挑戰**: 需要處理複製延遲導致的資料不一致問題。例如，剛在主庫寫入一條資料後，立即去從庫讀取，可能會讀不到。

2. **資料備份 (Data Backup)**:
    - 可以利用從庫作為一個熱備份 (Hot Backup)。我們可以在不影響主庫運行的情況下，在從庫上執行備份操作（例如使用 `mysqldump`）。
    - 這種方式比直接在主庫上進行備份的風險和影響要小得多。

3. **高可用性 (High Availability, HA)**:
    - 當主庫發生故障時，可以手動或自動地將一個從庫提升 (Promote) 為新的主庫，從而快速恢復服務。
    - 這是構建資料庫高可用性方案的基礎。通常會結合一些高可用性套件（如 MHA, Orchestrator, 或 Keepalived）來實現自動故障轉移 (Failover)。

4. **異地災備 (Disaster Recovery)**:
    - 可以在不同地理位置的資料中心部署從庫。當主資料中心因自然災害等原因完全不可用時，可以切換到異地的從庫，保證業務的連續性。

### 複製模式

- **非同步複製 (Asynchronous)**: 預設模式。主庫執行完操作並寫入 Binlog 後，無需等待從庫的回應即可返回成功給客戶端。效能最高，但極端情況下（如主庫寫完 Binlog 後立即宕機）可能導致資料遺失。
- **半同步複製 (Semi-Synchronous)**: 主庫執行完操作後，會等待 **至少一個** 從庫接收到 Binlog 事件並寫入其 Relay Log 後，才返回成功給客戶端。這在效能和資料一致性之間提供了一個很好的平衡，大大降低了資料遺失的風險。
- **全同步複製 (Fully-Synchronous)**: 需要所有從庫都確認應用了變更後，主庫才返回成功。效能極低，MySQL 原生不支援，通常由第三方叢集方案（如 Galera Cluster）提供。
