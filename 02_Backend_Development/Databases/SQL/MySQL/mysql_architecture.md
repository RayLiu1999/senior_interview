# MySQL 架構深度解析 (MySQL Architecture)

- **難度**: 6
- **重要程度**: 4
- **標籤**: `MySQL`, `架構`, `連接層`, `查詢優化器`, `InnoDB`, `插件式存儲引擎`

## 問題詳述

深入理解 MySQL 的分層架構是診斷效能問題、理解鎖機制和事務邏輯的基礎。MySQL 採用**插件式存儲引擎架構**，將 Server 層與存儲引擎層分離，這是 InnoDB 能夠提供強大事務支持的設計基礎。

## 核心理論與詳解

### MySQL 三層架構

```
┌─────────────────────────────────────────┐
│            客戶端 (Client)              │
└─────────────────────────────────────────┘
                     ↕ TCP/IP or Unix Socket
┌─────────────────────────────────────────┐
│          連接層 (Connection Layer)       │
│  • 連接池管理                            │
│  • 身份認證 (用戶名/密碼/Host)            │
│  • TLS 握手                             │
│  • 為每個連接分配線程                     │
└─────────────────────────────────────────┘
                     ↕
┌─────────────────────────────────────────┐
│          Server 層 / SQL Layer          │
│  ┌────────┐ ┌───────────┐ ┌──────────┐ │
│  │ Parser │→│ Optimizer │→│Executor  │ │
│  │(解析器)│  │(查詢優化器)│  │(執行器) │ │
│  └────────┘ └───────────┘ └──────────┘ │
│  • SQL 解析、語法/語義檢查                │
│  • 查詢緩存（8.0 已移除）               │
│  • 生成執行計劃（EXPLAIN 顯示的結果）    │
│  • Binlog（二進制日誌）                  │
└─────────────────────────────────────────┘
                     ↕ 存儲引擎 API（抽象接口）
┌─────────────────────────────────────────┐
│     存儲引擎層 (Storage Engine Layer)    │
│  ┌───────────────┐  ┌───────────┐       │
│  │    InnoDB     │  │  MyISAM  │  ...  │
│  │ • 事務        │  │ • 無事務  │       │
│  │ • 行級鎖      │  │ • 表鎖   │       │
│  │ • Redo Log   │  │ • 快速讀  │       │
│  │ • Undo Log   │  │           │       │
│  │ • MVCC       │  │           │       │
│  └───────────────┘  └───────────┘       │
└─────────────────────────────────────────┘
                     ↕
                 文件系統 / 磁碟
```

### 連接層詳解

**線程池模型**：MySQL 默認為每個連接分配一個獨立的 OS 線程（Thread-per-connection 模型）。

**關鍵影響**：
- `max_connections`：最大連接數（默認 151），超過後新連接被拒絕
- 每個線程消耗約 1-2 MB 記憶體（棧空間等），1000 並發連接 = 1-2 GB
- 使用連接池（應用側）減少連接建立/關閉的開銷（`gorm` 的 `SetMaxOpenConns`）

**企業版 Thread Pool**：一個 Pool 的線程服務多個連接，適合高並發場景。

---

### Parser（解析器）

執行 SQL 的兩個語法解析步驟：
1. **詞法分析（Lexical Analysis）**：將 SQL 字符串切分為 Token（`SELECT`、`users`、`WHERE` 等）
2. **語法分析（Syntax Analysis）**：按照 SQL 語法規則構建 AST（抽象語法樹），檢查語法是否合法
3. **語義分析**：檢查表名、列名是否存在，用戶是否有訪問權限

---

### Query Optimizer（查詢優化器）

MySQL 使用**基於成本（Cost-Based）的優化器**（CBO），對同一個查詢可能有多個執行計劃，優化器選擇估計代價最小的：

**優化的主要決策**：
- **索引選擇**：選用哪個索引（或全表掃描）
- **Join 算法**：Nested-Loop Join 的驅動表順序
- **子查詢優化**：是否將子查詢展開為 Join
- **謂詞下推（Predicate Pushdown）**：WHERE 條件盡早過濾

**EXPLAIN 的重要字段**：

| 字段 | 含義 |
|------|------|
| `type` | 訪問類型：`system > const > eq_ref > ref > range > index > ALL`（越靠前越優） |
| `key` | 實際使用的索引 |
| `rows` | 估計掃描的行數 |
| `Extra` | 額外信息：`Using index`（覆蓋索引）、`Using filesort`（文件排序，需關注）、`Using where` |

---

### Storage Engine Layer（存儲引擎層）

**插件式設計**：Server 層通過統一的存儲引擎 API 與底層引擎交互，可插拔替換。

**InnoDB vs MyISAM 核心區別**：

| 特性 | InnoDB | MyISAM |
|------|--------|--------|
| 事務 | ✅ 支援（ACID） | ❌ |
| 行級鎖 | ✅ | ❌（只有表鎖） |
| 外鍵 | ✅ | ❌ |
| 崩潰恢復 | ✅（Redo Log） | ❌（需 REPAIR） |
| 全文索引 | ✅（5.6+） | ✅ |
| 適用場景 | 交易系統、一般業務 | 只讀報表（MySQL 8.0 後少用） |

**MySQL 8.0 重要變更**：
- 查詢緩存（Query Cache）**完全移除**（該特性常是紙面優化，實際是高並發寫瓶頸）
- 默認字符集改為 `utf8mb4`（支援 Emoji）
- InnoDB 成為唯一支持的 DDL 原子性的引擎（Atomic DDL）
