# PostgreSQL 的串流複製 (Streaming Replication) 和邏輯複製 (Logical Replication) 有何不同？

- **難度**: 8
- **重要程度**: 4
- **標籤**: `PostgreSQL`, `Replication`, `High Availability`, `Scaling`

## 問題詳述

資料庫複製是實現高可用性 (High Availability)、讀取擴展 (Read Scaling) 和災難恢復 (Disaster Recovery) 的關鍵技術。PostgreSQL 提供了兩種主要的內建複製方法：串流複製和邏輯複製。請詳細解釋這兩種複製技術的工作原理、它們之間的根本區別、各自的優缺點以及適用場景。

## 核心理論與詳解

串流複製和邏輯複製都用於將資料從一個 PostgreSQL 伺服器（主庫, Primary）傳輸到另一個（備庫, Standby/Replica），但它們在不同的層級上運作，導致了截然不同的特性和用途。

### 1. 串流複製 (Streaming Replication)

串流複製是一種 **物理複製** 技術。它在資料庫的物理層面，即 WAL (Write-Ahead Logging) 記錄層面進行操作。

- **工作原理**:
  1. 在主庫上，所有的資料變更（`INSERT`, `UPDATE`, `DELETE`, `CREATE TABLE` 等）都會以 WAL 記錄的形式寫入到預寫日誌檔案中。
  2. 主庫上有一個特殊的 `walsender` 程序，負責將這些 WAL 記錄通過網路即時地「串流」到備庫。
  3. 備庫上有一個 `walreceiver` 程序接收這些 WAL 記錄，並將它們應用（重放, replay）到自己的資料檔案上。
  4. 這個過程使得備庫成為主庫的一個 **逐位元組 (byte-for-byte) 的精確副本**。備庫的磁碟內容與主庫幾乎完全相同。

- **優點**:
  - **簡單高效**: 由於是物理層的複製，不需要解析 SQL，開銷較低，延遲極小。
  - **完整性高**: 複製了整個資料庫叢集的所有內容，包括所有資料庫、使用者、角色以及 DDL 操作（如 `CREATE TABLE`, `ALTER TABLE`）。
  - **配置簡單**: 設置相對直接，是構建標準主備高可用架構的首選。
  - **支援熱備 (Hot Standby)**: 備庫在接收和應用 WAL 的同時，可以處於唯讀模式，對外提供讀取查詢服務，從而實現讀取擴展。

- **缺點**:
  - **靈活性差**:
    - **全量複製**: 無法選擇只複製某個資料庫、某個 schema 或某個表。必須複製整個叢集。
    - **版本和平台鎖定**: 主備伺服器必須具有相同的 PostgreSQL 主版本號，並且通常要求作業系統和硬體架構也相同。
  - **寫入限制**: 備庫是嚴格的唯讀副本，不能進行任何寫入操作。
  - **DDL 限制**: 在備庫上無法執行 DDL，所有結構變更必須在主庫上進行。

- **適用場景**:
  - **高可用性 (HA)**: 當主庫故障時，可以快速將一個備庫提升 (promote) 為新的主庫，實現故障轉移。
  - **讀取擴展 (Read Scaling)**: 將讀取負載分散到多個唯讀的備庫上。
  - **災難恢復 (DR)**: 在遠程位置部署一個備庫，用於數據的異地備份。

### 2. 邏輯複製 (Logical Replication)

邏輯複製是一種 **邏輯層面** 的複製技術。它基於「發布-訂閱 (Publish-Subscribe)」模型，複製的是資料變更的邏輯表示，而不是物理的 WAL 記錄。

- **工作原理**:
  1. 在主庫（發布方, Publisher）上，將 WAL 記錄解碼成一種易於理解的邏輯變更格式（例如，`INSERT` 了哪一行，具體值是什麼）。
  2. 主庫根據定義好的「發布 (Publication)」規則，決定哪些資料表（或所有資料表）的變更需要發送。
  3. 在備庫（訂閱方, Subscriber）上，定義一個「訂閱 (Subscription)」，連接到主庫的發布。
  4. 訂閱方接收到這些邏輯變更後，將它們轉換為對應的 DML 語句（`INSERT`, `UPDATE`, `DELETE`）在本地執行，從而將變更應用到自己的資料表上。

- **優點**:
  - **高度靈活**:
    - **選擇性複製**: 可以精確控制只複製特定的資料表，甚至可以只複製 `INSERT` 操作而忽略 `DELETE`。
    - **跨版本/平台**: 由於複製的是邏輯資料，主備伺服器可以運行不同主版本的 PostgreSQL，甚至可以是不同的作業系統或硬體架構。
    - **資料轉換**: 可以在訂閱方對接收到的資料進行一定程度的轉換和整合。
  - **備庫可寫**: 訂閱方的資料表可以像普通表一樣進行讀寫。這意味著你可以在訂閱方擁有主庫沒有的額外資料表、索引或觸發器。
  - **多對一/一對多**: 可以將多個主庫的資料變更匯總到一個訂閱方，或將一個主庫的變更分發到多個訂閱方。

- **缺點**:
  - **複雜性高**: 配置比串流複製複雜，需要單獨定義發布和訂閱。
  - **效能開銷較大**: WAL 解碼和在訂閱方重新執行 DML 的過程比物理重放有更高的 CPU 開銷和延遲。
  - **不複製 DDL**: **邏輯複製不處理 DDL**。如果在主庫上 `ALTER TABLE` 添加了一個欄位，這個變更不會自動傳播到訂閱方，必須手動在訂閱方執行相同的 DDL。
  - **初始資料同步**: 需要手動或通過工具進行初始的資料拷貝。
  - **不複製序列和大型物件**: 序列的當前值不會被複製，需要手動同步。

- **適用場景**:
  - **資料庫升級**: 實現零停機或近零停機的 PostgreSQL 主版本升級。
  - **資料整合**: 將多個不同資料庫的資料匯總到一個中央資料倉儲中。
  - **資料分發**: 將一個中央資料庫的資料子集分發到多個邊緣節點。
  - **在雲服務商之間遷移資料**。
  - **構建讀寫分離，且備庫需要有自訂索引或額外資料的場景**。

### 總結比較

| 特性 | 串流複製 (物理) | 邏輯複製 (邏輯) |
| :--- | :--- | :--- |
| **複製層級** | 物理層 (WAL 記錄) | 邏輯層 (DML 變更) |
| **複製內容** | 整個資料庫叢集 | 可選擇的特定資料表 |
| **備庫狀態** | 嚴格唯讀 (Hot Standby) | 可讀寫 |
| **DDL 複製** | 自動複製所有 DDL | **不複製**，需手動同步 |
| **版本/平台要求** | 嚴格，要求主版本和平台一致 | 靈活，可跨版本、跨平台 |
| **效能/延遲** | 高效能，低延遲 | 開銷較大，延遲較高 |
| **配置複雜度** | 相對簡單 | 較複雜 (發布/訂閱模型) |
| **主要用途** | 高可用性、讀寫分離、災難恢復 | 零停機升級、資料整合、選擇性複製 |

**簡單來說**: 如果你需要一個與主庫一模一樣的鏡像副本來實現高可用和讀取擴展，請選擇 **串流複製**。如果你需要在資料複製上有更大的靈活性，例如只想複製幾個表、在不同 PostgreSQL 版本間同步、或者需要將多個資料庫的資料聚合，那麼 **邏輯複製** 是更合適的工具。
