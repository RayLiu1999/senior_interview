# PostgreSQL 有哪些主要的索引類型？請比較 B-Tree、Hash、GiST 和 GIN 的使用場景

- **難度**: 7
- **標籤**: `PostgreSQL`, `Indexing`, `B-Tree`, `Hash`, `GiST`, `GIN`

## 問題詳述

索引是資料庫效能最佳化的關鍵。PostgreSQL 提供了多種索引類型以適應不同的查詢需求。請詳細介紹 PostgreSQL 中最主要的幾種索引類型，並重點比較 B-Tree、Hash、GiST 和 GIN 索引各自的適用場景、優點和限制。

## 核心理論與詳解

PostgreSQL 擁有一個強大的索引框架，允許擴展並創建新的索引類型。以下是幾種最核心和常用的索引類型。

### 1. B-Tree (平衡樹) 索引

B-Tree 是最常用、也是預設的索引類型。當你執行 `CREATE INDEX` 而不指定索引類型時，建立的就是 B-Tree 索引。

- **工作原理**: B-Tree 將所有索引項按照排序順序存儲在一個平衡的樹狀結構中。這使得查找、插入、刪除和順序掃描都非常高效。
- **適用操作**:
  - 等值查詢 (`=`)
  - 範圍查詢 (`<`, `>`, `<=`, `>=`)
  - 排序 (`ORDER BY`)
  - 模式匹配 (`LIKE 'prefix%'`)，但僅限於前綴匹配。
- **優點**:
  - 用途最廣泛，效能穩定且可預測。
  - 支援多種比較操作符。
  - 支援 `ORDER BY` 和 `GROUP BY`，避免額外的排序步驟。
- **限制**:
  - 對於非前綴的模式匹配 (`LIKE '%suffix'`) 無法有效利用索引。
  - 不適用於集合類型（如 Array 或 JSON）的「包含」查詢。
- **使用場景**: 幾乎所有常規的純量資料類型（如 `INTEGER`, `VARCHAR`, `TEXT`, `TIMESTAMP`）都可以使用 B-Tree 索引。它是大多數情況下的首選。

### 2. Hash (雜湊) 索引

Hash 索引只能處理簡單的等值查詢。

- **工作原理**: Hash 索引通過計算索引欄位的雜湊值來定位資料。它將雜湊值與指向資料行的指標存儲起來。
- **適用操作**:
  - 僅限於等值查詢 (`=`)。
- **優點**:
  - 對於等值查詢，當索引可以完全載入記憶體時，其查詢速度可能比 B-Tree 更快，因為它避免了樹的遍歷。
- **限制**:
  - **不支援範圍查詢**: 雜湊值是無序的，無法用於 `<` 或 `>` 等操作。
  - **不支援排序**: 無法避免排序操作。
  - 在 PostgreSQL 10 之前，Hash 索引不是 WAL (Write-Ahead Logging) 安全的，意味著在資料庫崩潰後需要手動重建。這個問題在 10 及以後的版本中得到了解決。
- **使用場景**: 僅當你確定某個欄位只會進行等值查詢，並且對查詢速度有極致要求時，才考慮使用 Hash 索引。在現代 PostgreSQL 中，B-Tree 的效能已經非常出色，使得 Hash 索引的使用場景相對較少。

### 3. GiST (Generalized Search Tree) 索引

GiST 是一種通用的索引框架，它允許為許多不同的資料類型和查詢策略實現索引。它本身不是一種具體的索引，而是一個模板。

- **工作原理**: GiST 將索引項組織成一個層次結構的樹，其中父節點「包含」其所有子節點。這個「包含」的定義非常靈活，可以是幾何上的包含，也可以是集合的包含。
- **適用操作**:
  - **幾何/地理資料查詢**: 例如，查找一個點是否在一個多邊形內 (`<@`)，或者兩個矩形是否重疊 (`&&`)。這是 PostGIS 擴展的核心索引。
  - **全文搜索**: 查找一個詞組是否匹配一段文本。
  - **範圍類型查詢**: 查找一個時間範圍是否與另一個重疊。
- **優點**:
  - **高度可擴展**: 可以為複雜的自訂資料類型創建索引。
  - 適用於「這個東西是否與那個東西有關」這類模糊的查詢。
- **限制**:
  - **可能有損 (Lossy)**: GiST 索引可以是「有損」的，這意味著索引查找可能會返回一些誤報 (false positives)。資料庫引擎需要對這些返回的行進行二次檢查（稱為 "recheck"），確認它們是否真的滿足查詢條件。這會帶來一些額外的 I/O 開銷。
  - 索引大小和構建速度通常劣於 GIN。
- **使用場景**: 主要用於二維或多維資料類型、幾何資料和全文搜索。

### 4. GIN (Generalized Inverted Index) 索引

GIN 索引是「倒排索引」的一種實現，它特別適合處理包含多個元素的複合值，例如陣列、JSONB 或全文搜索中的詞彙。

- **工作原理**: GIN 索引為複合值中的 **每一個元素** 創建一個索引條目，該條目指向所有包含這個元素的行。例如，對於 `'{a, b, c}'` 這一行，GIN 會為 `a`、`b` 和 `c` 分別創建索引，並都指向這一行。
- **適用操作**:
  - **陣列查詢**: 查找包含某個特定元素的陣列 (`@>`)。
  - **JSONB 查詢**: 查找包含特定鍵 (`?`) 或鍵值對 (`@>`) 的 JSONB 文件。
  - **全文搜索**: 查找包含特定詞彙的文件。
- **優點**:
  - **查找速度極快**: 對於「集合中是否包含某個元素」的查詢，GIN 的速度通常遠超 GiST，因為它直接定位，無需 recheck。
- **限制**:
  - **索引構建較慢**: 因為它需要為每個元素創建索引條目，所以 GIN 索引的構建時間和更新成本通常比 GiST 更高。
  - **索引體積較大**: GIN 索引通常比 GiST 索引更大。
- **使用場景**: 當你的資料是複合類型（如 `ARRAY`, `JSONB`, `tsvector`），並且主要查詢是檢查其中是否包含特定值時，GIN 是最佳選擇。

### 總結與比較

| 特性 | B-Tree | Hash | GiST (通用搜索樹) | GIN (倒排索引) |
| :--- | :--- | :--- | :--- | :--- |
| **核心思想** | 有序的平衡樹 | 雜湊表 | 可擴展的層次化「包含」樹 | 倒排索引，元素指向行 |
| **主要優勢** | 通用、高效、支援排序 | 極快的等值查詢 | 靈活，支援複雜類型（地理、全文） | 極快的「包含」查詢 |
| **適用操作** | `=`, `>`, `<`, `>=`, `LIKE 'prefix%'`, `ORDER BY` | 僅 `=` | 包含、重疊、相鄰等 | 包含 (`@>`), 存在 (`?`) |
| **適用資料類型** | 所有可排序的純量類型 | 所有可雜湊的類型 | 幾何、範圍、`tsvector` | `ARRAY`, `JSONB`, `tsvector` |
| **索引更新速度** | 快 | 快 | 中等 | 慢 |
| **索引大小** | 中等 | 中等 | 較大 | 大 |
| **查詢速度** | 快 | 非常快 (僅等值) | 中等 (可能有損，需 recheck) | 非常快 (無損) |
| **選擇時機** | **預設選擇**。用於大多數常規查詢。 | 幾乎不用，除非只有等值查詢。 | 用於地理資訊、複雜範圍和全文搜索，且更新頻繁。 | 用於陣列、JSONB 和全文搜索，且讀取遠多於寫入。 |

**經驗法則**:

- 從 **B-Tree** 開始。
- 如果你的欄位是 `ARRAY` 或 `JSONB`，並且查詢條件是檢查其內部元素，請使用 **GIN**。
- 如果你正在使用 PostGIS 處理地理資料，或者你的更新操作非常頻繁，可以考慮使用 **GiST**。
- 除非有非常特殊的理由，否則可以忽略 **Hash** 索引。
