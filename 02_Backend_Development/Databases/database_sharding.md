# 資料庫分片 (Database Sharding)

- **難度**: 8
- **重要性**: 4
- **標籤**: `Databases`, `Sharding`, `Scalability`, `System Design`

## 問題詳述

什麼是資料庫分片 (Sharding)？為什麼需要分片？請解釋幾種常見的分片策略（如範圍分片、雜湊分片）及其優缺點。分片會帶來哪些複雜性？

## 核心理論與詳解

### 什麼是資料庫分片？

資料庫分片是一種**水平擴展 (Horizontal Scaling)** 資料庫的技術，也稱為**水平分區 (Horizontal Partitioning)**。它將一個大型的資料庫表中的數據，根據某個規則（稱為 **分片鍵, Shard Key**）分散到多個獨立的、更小的資料庫實例（稱為 **分片, Shard**）上。

與**垂直分區 (Vertical Partitioning)**（將一個表的不同欄位拆分到不同表中）不同，水平分片是將**表的行**進行拆分。每個分片都擁有相同的資料庫綱要 (Schema)，但只儲存整體數據的一部分。

### 為什麼需要分片？

當單一資料庫伺服器（即使是頂級硬體）遇到效能瓶頸時，就需要考慮分片。這通常發生在以下情況：

1. **儲存容量極限**: 數據量大到單一伺服器的磁碟無法容納。
2. **寫入吞吐量瓶頸**: 單一伺服器的寫入 I/O、CPU 或網路資源達到飽和，無法處理更多的寫入請求。
3. **讀取吞吐量瓶頸**: 雖然可以透過增加讀取副本 (Read Replicas) 來擴展讀取能力，但主庫的寫入壓力依然存在，且副本的延遲可能影響業務。
4. **資源競爭**: 大量的併發查詢和交易在單一資料庫上互相競爭鎖和資源，導致效能下降。

分片透過將負載分散到多台伺服器上，使得整個資料庫系統能夠處理更大的數據量和更高的吞吐量。

### 常見的分片策略

選擇合適的分片鍵 (Shard Key) 和分片策略至關重要，它直接影響到數據的均衡性、查詢效率和系統的複雜度。

#### 1. 範圍分片 (Range-based Sharding)

- **策略**: 根據分片鍵的**連續範圍**來劃分數據。例如，使用者 ID 1-1,000,000 在分片 A，1,000,001-2,000,000 在分片 B，以此類推。
- **優點**:
  - **範圍查詢友好**: 查詢一個範圍內的數據（如查詢某個月份的訂單）非常高效，因為請求可能只需要路由到一個或少數幾個分片。
  - **實現簡單**: 邏輯直觀，容易實現。
- **缺點**:
  - **數據傾斜 (Hotspots)**: 如果分片鍵的寫入不是均勻分佈的，很容易產生熱點。例如，新註冊的使用者 ID 持續增長，會導致所有新的寫入請求都集中在最後一個分片上，使其成為瓶頸。
  - **擴展不易**: 增加新的分片時，可能需要對現有範圍進行拆分和數據遷移。

#### 2. 雜湊分片 (Hash-based Sharding)

- **策略**: 計算分片鍵的**雜湊值 (Hash)**，然後根據雜湊值將數據分配到不同的分片中（例如，`hash(key) % N`，其中 N 是分片數量）。
- **優點**:
  - **數據分佈均勻**: 只要雜湊函數設計得好，數據可以非常均勻地分佈到各個分片上，有效避免熱點問題。
- **缺點**:
  - **範圍查詢不友好**: 由於連續的鍵值（如 ID 100 和 101）經過雜湊後會被分配到完全不同的分片，範圍查詢會變得非常低效，需要向所有分片發送查詢請求，然後在應用層聚合結果。
  - **擴展複雜**: 當分片數量 N 發生變化時（例如從 4 個增加到 5 個），幾乎所有數據的 `hash(key) % N` 結果都會改變，導致大規模的數據遷移。這個問題可以透過**一致性雜湊 (Consistent Hashing)** 來緩解。

#### 3. 目錄分片 (Directory-based Sharding)

- **策略**: 維護一個**查詢表 (Lookup Table)** 或目錄服務，該服務儲存了每個分片鍵到其對應分片的映射關係。
- **優點**:
  - **靈活性極高**: 可以自由地將任何鍵映射到任何分片，方便實現數據的動態遷移和負載均衡。
  - **策略解耦**: 分片邏輯與應用程式解耦，由目錄服務集中管理。
- **缺點**:
  - **單點故障風險**: 目錄服務本身成為了系統的關鍵路徑和潛在的單點故障。需要對其進行高可用設計。
  - **查詢延遲**: 每次查詢都需要先訪問目錄服務來確定目標分片，增加了一次網路往返的延遲。

### 分片帶來的挑戰與複雜性

雖然分片是解決擴展性問題的強大武器，但它也引入了巨大的系統複雜性：

1. **查詢路由**: 應用程式或中間件需要知道如何根據查詢條件將請求路由到正確的分片。對於跨分片的查詢，情況更加複雜。
2. **跨分片交易**: 維持跨越多個分片的交易的 ACID 特性非常困難。這通常需要使用**兩階段提交 (Two-Phase Commit, 2PC)** 或 **Saga 模式**等分佈式交易協議，這些協議會顯著增加系統的複雜性和延遲。
3. **數據重新平衡 (Rebalancing)**: 當增加或刪除分片時，需要遷移數據以保持分片間的負載均衡。這個過程必須在線進行，且不能影響服務的可用性。
4. **唯一 ID 生成**: 在分片環境中，不能再依賴資料庫的自增 ID 來保證全域唯一。需要引入獨立的 ID 生成服務（如 Snowflake 演算法）。
5. **數據聚合**: 很多查詢（如 `GROUP BY`, `ORDER BY`）如果沒有命中單一分片，就需要從多個分片獲取數據，然後在應用層或代理層進行合併和處理。
6. **運維複雜性**: 管理和監控一個由數十甚至數百個資料庫實例組成的集群，遠比管理單一資料庫要複雜得多。

### 結論

資料庫分片是構建大規模、高吞吐量系統的關鍵技術。它不是一個簡單的解決方案，而是一個複雜的架構決策，需要在不同的分片策略之間進行權衡。在決定分片之前，應首先窮盡其他優化手段，如 SQL 優化、索引、快取和垂直擴展。一旦決定分片，就需要仔細設計分片鍵和策略，並準備好應對隨之而來的分佈式系統的各種挑戰。
