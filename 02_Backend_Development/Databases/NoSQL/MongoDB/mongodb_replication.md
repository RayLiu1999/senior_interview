# Replication in MongoDB

- **難度**: 7
- **重要性**: 5
- **標籤**: `MongoDB`, `Replication`, `High Availability`

## 問題詳述

請解釋 MongoDB 的複製集 (Replica Set) 是什麼，它的主要作用是什麼？請描述一個典型的複製集架構，以及主節點 (Primary) 和從節點 (Secondary) 之間的資料同步過程。

## 核心理論與詳解

**複製集 (Replica Set)** 是 MongoDB 用於實現**高可用性 (High Availability)** 和**資料備援 (Data Redundancy)** 的核心機制。一個複製集是由多個 `mongod` 實例組成的叢集，它們儲存著完全相同的資料集。

**主要作用**:
1.  **高可用性**: 當主節點發生故障或無法訪問時，複製集能夠自動進行**故障轉移 (Failover)**，從剩餘的從節點中選舉出一個新的主節點來接管服務。這確保了資料庫服務不會因為單點故障而中斷。
2.  **資料備援**: 資料在多個伺服器上儲存了副本，即使某個節點的硬碟損壞或資料遺失，也可以從其他節點恢復，大大提高了資料的持久性和安全性。
3.  **讀取擴展 (Read Scaling)**: 應用程式可以將讀取請求分散到從節點上，從而分擔主節點的讀取壓力。這被稱為**讀寫分離**。

---

### 複製集架構

一個典型的複製集通常由以下幾種角色的節點組成：

#### 1. 主節點 (Primary)

-   **角色**: 複製集中**唯一**可以接收**寫入操作**的節點。
-   **職責**:
    -   處理所有來自客戶端的寫入請求。
    -   將所有的資料變更記錄到一個特殊的 Capped Collection 中，稱為 **Oplog (Operations Log)**。
    -   從節點透過監聽 Oplog 來同步資料。
-   **心跳**: 主節點會定期向所有從節點發送心跳訊息，以確認它們的健康狀態。

#### 2. 從節點 (Secondary)

-   **角色**: 複製和維護主節點資料副本的節點。
-   **職責**:
    -   非同步地從主節點的 Oplog 中拉取資料變更，並在本地重放 (apply) 這些操作，以保持與主節點的資料同步。
    -   參與主節點的選舉投票。
    -   預設情況下，客戶端**不能**從從節點讀取資料，但可以透過設定**讀取偏好 (Read Preference)** 來開啟從節點讀取。

#### 3. 仲裁者 (Arbiter) (可選)

-   **角色**: 一個特殊的、**不儲存任何資料**的 `mongod` 實例。
-   **職責**: 它的唯一作用就是在選舉中**投票**。
-   **使用場景**: 當複製集成員數量為偶數時，可以加入一個仲裁者來湊成奇數，以避免在選舉中出現票數相等無法選出主節點的情況。仲裁者資源消耗極低，可以用於節省成本。
-   **注意**: 一個複製集最多只能有一個仲裁者。

**推薦架構**: 一個標準的生產環境複製集至少應包含**三個儲存資料的成員**（例如，一個 Primary 和兩個 Secondary），以在一個節點故障時，仍能保證資料的冗餘和故障轉移能力。

---

### 資料同步過程 (Replication Process)

複製的核心是 **Oplog**。

1.  **寫入操作**: 當客戶端向主節點發送一個寫入操作（如 `insert`, `update`, `delete`）時，主節點首先將這個操作應用到自己的資料集上。

2.  **記錄 Oplog**: 緊接著，主節點會將這個操作的詳細資訊記錄到它的 Oplog 中。Oplog 中的每一條記錄都是**冪等 (idempotent)** 的，這意味著即使一個操作被重複應用多次，其結果也和只應用一次相同。這保證了同步過程的健壯性。

3.  **從節點拉取**: 每個從節點都維護著一個指向主節點 Oplog 的游標，記錄著自己上次同步到的位置。從節點會定期查詢主節點 Oplog 中在該位置之後的新記錄。

4.  **重放 Oplog**: 當從節點獲取到新的 Oplog 記錄後，它會在自己的資料集上**重放**這些操作，從而使自己的資料狀態與主節點保持一致。

5.  **心跳與狀態**: 同時，所有成員之間會不斷地發送心跳訊息（預設每 2 秒一次）。這不僅是為了監測健康狀態，也是為了交換各自 Oplog 的最新時間戳等資訊。

這個過程是非同步的，因此從節點的資料相對於主節點會有一個微小的延遲，稱為**複製延遲 (Replication Lag)**。

### 故障轉移與選舉 (Failover and Election)

當從節點在一定時間內（預設 10 秒）沒有收到主節點的心跳時，它會認為主節點已宕機，並觸發一次選舉。

1.  **觸發選舉**: 一個或多個從節點會發起選舉，提名自己成為新的主節點。
2.  **投票**: 複製集中的其他成員會根據一系列規則進行投票。主要的評判標準是哪個節點擁有**最新、最完整**的 Oplog 記錄。
3.  **成為主節點**: 獲得**大多數**（`(N/2) + 1`，其中 N 是複製集總成員數）選票的節點將成為新的主節點。
4.  **角色轉換**: 新的主節點開始接受寫入操作，而舊的主節點（如果恢復）會降級為從節點，並開始從新的主節點同步資料。

這就是為什麼複製集成員數通常是**奇數**的原因：它可以確保在任何時候都能有一個明確的「大多數」來做出決策，避免腦裂 (Split-Brain) 問題。

### 結論

複製集是 MongoDB 提供資料庫高可用性和持久性的基石。它透過 Oplog 機制實現了高效的非同步資料複製，並透過自動化的故障轉移和選舉過程，最大限度地減少了因單點故障導致的停機時間。在任何生產環境中部署 MongoDB，都應使用複製集架構。
