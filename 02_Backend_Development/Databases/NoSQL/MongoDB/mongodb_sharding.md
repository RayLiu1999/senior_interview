# Sharding in MongoDB

- **難度**: 8
- **重要性**: 4
- **標籤**: `MongoDB`, `Sharding`, `Scalability`, `System Design`

## 問題詳述

請解釋 MongoDB 中的分片 (Sharding) 是什麼，以及它為什麼對於大規模應用如此重要。請描述一個 MongoDB 分片叢集 (Sharded Cluster) 的主要組件，並討論選擇分片鍵 (Shard Key) 時需要考慮的因素。

## 核心理論與詳解

**分片 (Sharding)** 是 MongoDB 用於實現**水平擴展 (Horizontal Scaling / Scale-Out)** 的核心機制。當單一伺服器的硬體資源（CPU、RAM、磁碟 I/O）無法滿足應用的讀寫負載，或者資料量大到單一伺服器無法儲存時，分片就成為了必要的解決方案。

與垂直擴展（升級單一伺服器硬體）相比，水平擴展透過將資料分散到多個相對廉價的伺服器上，提供了近乎無限的擴展能力和更高的成本效益。

---

### 分片叢集的主要組件

一個 MongoDB 分片叢集由以下三個主要組件構成：

#### 1. 分片 (Shard)

-   **作用**: 每個分片都是一個獨立的 MongoDB 實例，負責儲存整個資料集的一個子集（一個或多個 **Chunk**）。
-   **架構**: 為了保證高可用性，在生產環境中，每個分片本身都應該是一個**複製集 (Replica Set)**，而不是單一的 `mongod` 實例。這樣即使分片中的主節點故障，也能自動進行故障轉移，保證服務的連續性。

#### 2. 查詢路由器 (Query Router / `mongos`)

-   **作用**: 這是應用程式與分片叢集互動的唯一入口。`mongos` 是一個輕量級的無狀態代理，它本身不儲存任何資料。
-   **核心職責**:
    1.  接收來自應用程式的查詢請求。
    2.  從設定伺服器獲取關於資料分佈的**元資料 (Metadata)**。
    3.  根據元資料，判斷這個查詢應該被路由到哪個（或哪些）分片。
    4.  將查詢發送到目標分片。
    5.  從分片收集結果，合併後返回給應用程式。
-   **透明性**: 整個路由過程對應用程式是完全透明的。應用程式就像在與一個單一的 MongoDB 實例通訊。

#### 3. 設定伺服器 (Config Server)

-   **作用**: 這是整個叢集的「大腦」，負責儲存叢集的元資料。
-   **元資料內容**:
    -   **分片鍵 (Shard Key)** 的定義。
    -   資料塊 **(Chunks)** 在各個分片上的分佈對應關係。一個 Chunk 是一個基於分片鍵的連續資料範圍。
-   **架構**: 設定伺服器也必須以**複製集**的形式部署，以確保元資料的高可用性。一旦設定伺服器不可用，整個叢集將變為「唯讀」狀態，無法進行任何資料塊的遷移或分裂。

---

### 分片鍵 (Shard Key) 的選擇

分片鍵是你在一個集合中選擇的、用於決定資料如何在各個分片之間分佈的一或多個欄位。**選擇一個好的分片鍵是分片策略中最關鍵的決策**，它直接影響到叢集的效能、擴展性和效率。

一個理想的分片鍵應具備以下特質：

#### 1. 高基數 (High Cardinality)

-   **定義**: 分片鍵應該有大量可能的值。
-   **原因**: 基數越高，MongoDB 才能創建出更多數量的 Chunks，從而更均勻地將資料分散到更多的分片上。如果基數很低（例如，一個只有「男」、「女」兩個值的 `gender` 欄位），那麼資料最多只能被分散到兩個分片上，無法實現良好的擴展性。

#### 2. 均勻分佈 (Evenly Distributed)

-   **定義**: 寫入操作應該盡可能均勻地分佈到所有的分片上，避免產生**熱點 (Hotspot)**。
-   **原因**: 如果所有或大部分的寫入請求都集中在單一分片上，那麼這個分片就會成為整個叢集的效能瓶頸，其他分片則處於閒置狀態，這就違背了水平擴展的初衷。
-   **反例**: 使用一個單調遞增的欄位（如預設的 `_id` 或時間戳）作為分片鍵，會導致所有新的寫入操作都集中在擁有最新資料範圍的那個分片上，形成嚴重的寫入熱點。

#### 3. 查詢隔離 (Query Isolation)

-   **定義**: 大部分的查詢應該能夠被路由到單一分片，而不是廣播到所有分片。這種查詢被稱為**目標查詢 (Targeted Query)**。
-   **原因**: 如果一個查詢不包含分片鍵，`mongos` 就無法確定資料在哪個分片上，只能將查詢**廣播 (Broadcast)** 到叢集中的所有分片，然後等待所有分片的回應並合併結果。這種「分散-聚集」(Scatter-Gather) 式的查詢效率極低。
-   **策略**: 選擇應用程式中最常見查詢所使用的欄位作為分片鍵的一部分。

### 常見的分片策略

#### 1. 範圍分片 (Ranged Sharding)

-   **原理**: 根據分片鍵的值範圍來劃分 Chunks。
-   **優點**: 對於基於範圍的查詢（例如，查找某個日期範圍內的所有日誌）非常高效，因為 `mongos` 可以直接將查詢路由到包含該資料範圍的分片。
-   **缺點**: 容易產生熱點，特別是當分片鍵是單調遞增時。

#### 2. 雜湊分片 (Hashed Sharding)

-   **原理**: MongoDB 會先計算分片鍵值的雜湊值 (Hash)，然後根據這個雜湊值來劃分 Chunks。
-   **優點**: 能夠確保寫入操作在所有分片上實現非常均勻的分佈，有效避免寫入熱點。
-   **缺點**: 犧牲了範圍查詢的效能。因為兩個在原始值上相近的分片鍵（例如 `100` 和 `101`），它們的雜湊值可能相差很遠，導致它們的資料被存放在不同的分片上。因此，一個範圍查詢很可能需要廣播到所有分片。

#### 3. 區域分片 (Zoned Sharding)

-   **原理**: 允許你定義分片的「區域」(Zone)，並將特定範圍的資料固定到特定的分片上。
-   **用途**:
    -   **地理分佈**: 將位於歐洲的用戶資料存放在歐洲的資料中心（分片），將亞洲的用戶資料存放在亞洲的資料中心，以降低延遲。
    -   **資料分層**: 將不常訪問的歷史資料存放在較慢、較便宜的硬碟分片上，將熱點資料存放在高效能的 SSD 分片上。

### 結論

分片是 MongoDB 應對海量資料和高併發負載的「銀彈」。然而，它的效能高度依賴於一個精心設計的分片鍵。一個好的分片鍵需要在高基數、寫入均勻性和查詢隔離性之間做出權衡。在選擇分片鍵之前，必須深入分析應用的資料模型和查詢模式。一旦集合被分片，修改分片鍵將會非常困難。
