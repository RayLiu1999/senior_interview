# Indexing in MongoDB

- **難度**: 6
- **重要性**: 5
- **標籤**: `MongoDB`, `Indexing`, `Performance`

## 問題詳述

請解釋 MongoDB 中索引的作用和重要性。MongoDB 支援哪些主要的索引類型？並請說明複合索引 (Compound Index) 中欄位順序的影響。

## 核心理論與詳解

在 MongoDB 中，索引是一種特殊的資料結構，它以易於遍歷的形式儲存了集合中一小部分資料。如果沒有索引，MongoDB 在執行查詢時必須執行**集合掃描 (Collection Scan)**，即逐一檢查集合中的每一個文件，以找出符合查詢條件的結果。對於大型集合，這會導致極低的查詢效率。

索引的作用就是為了避免全集合掃描，它提供了一條快速定位資料的路徑，使得資料庫可以**直接跳轉**到符合條件的文件，從而極大地提升查詢效能。

---

### 主要索引類型

MongoDB 提供了多種索引類型以適應不同的查詢需求。

#### 1. 單欄位索引 (Single Field Index)

這是最基本的索引類型，針對單一欄位建立。

-   **升序/降序**: 你可以為索引指定 `1` (升序) 或 `-1` (降序)。對於單欄位索引，這個順序對於查詢效能影響不大，但在複合索引和排序操作中至關重要。
-   **範例**: `db.collection.createIndex({ "username": 1 })`
    -   這個索引會加速對 `username` 欄位的查詢。

#### 2. 複合索引 (Compound Index)

在多個欄位上建立的索引。複合索引中欄位的**順序**非常重要。

-   **欄位順序的影響**:
    一個在 `{ "author": 1, "score": -1 }` 上建立的複合索引，可以同時支援以下查詢：
    1.  對 `author` 欄位的查詢。
    2.  對 `author` 和 `score` 兩個欄位的查詢。

    但是，它**無法**單獨有效地支援**僅對 `score` 欄位的查詢**。這是因為索引是按照「author -> score」的順序組織的。如果查詢條件中不包含索引的前綴欄位 (`author`)，MongoDB 就無法有效利用這個索引來縮小搜尋範圍。

-   **排序操作**: 複合索引的排序順序 (`1` 或 `-1`) 對於 `sort()` 操作有直接影響。如果查詢的排序順序與索引的排序順序完全一致或完全相反，MongoDB 就可以避免在記憶體中進行額外的排序步驟。
    -   例如，索引 `{ "author": 1, "score": -1 }` 可以直接支援 `sort({ "author": 1, "score": -1 })` 和 `sort({ "author": -1, "score": 1 })`。

#### 3. 多鍵索引 (Multikey Index)

當索引欄位包含**陣列**值時，MongoDB 會自動建立多鍵索引。它會為陣列中的**每一個元素**建立一個索引條目。

-   **範例**: 如果一個文件是 `{ "tags": ["nosql", "database", "mongodb"] }`，在 `tags` 欄位上建立的索引就是一個多鍵索引。
-   **作用**: 這使得你可以高效地查詢那些 `tags` 陣列中包含特定元素的文件，例如 `db.collection.find({ "tags": "nosql" })`。

#### 4. 地理空間索引 (Geospatial Index)

專為地理位置資料設計，支援地理空間查詢。

-   **`2dsphere` 索引**: 用於計算在類似地球的球面上的幾何形狀。支援點、線和多邊形。這是目前推薦的地理空間索引類型。
    -   **範例**: `db.collection.createIndex({ "location": "2dsphere" })`
    -   **查詢**: 可以執行「尋找某個點附近的所有地點」、「某個區域內的所有地點」等查詢。
-   **`2d` 索引**: 用於在二維平面上計算距離，較舊且功能有限。

#### 5. 全文索引 (Text Index)

支援在字串內容上進行文字搜尋。一個集合只能有一個全文索引。

-   **範例**: `db.collection.createIndex({ "content": "text" })`
-   **查詢**: 使用 `$text` 和 `$search` 運算子來執行關鍵字搜尋。它支援多種語言的詞幹提取和停用詞過濾。

#### 6. 唯一索引 (Unique Index)

確保索引欄位的值在集合中是唯一的。如果嘗試插入或更新一個會導致重複值的操作，MongoDB 會拒絕該操作。

-   **範例**: `db.collection.createIndex({ "email": 1 }, { "unique": true })`
    -   常用於使用者註冊時的 email 或 username 欄位，以防止重複。

#### 7. TTL 索引 (Time-To-Live Index)

一種特殊的單欄位索引，可以讓 MongoDB 在指定時間後自動刪除集合中的文件。

-   **要求**: 索引欄位必須是**日期類型**。
-   **範例**: `db.collection.createIndex({ "createdAt": 1 }, { "expireAfterSeconds": 3600 })`
    -   這會讓 `createdAt` 欄位創建時間超過一小時的文件自動被刪除。非常適合儲存日誌、會話等有時效性的資料。

### 複合索引的 ESR 法則

一個經驗法則是 **ESR (Equality, Sort, Range)**，它指導如何設計高效的複合索引：

1.  **等值查詢 (Equality)**: 將用於精確匹配的欄位放在索引的最前面。
2.  **排序 (Sort)**: 接著是查詢中用於排序的欄位。
3.  **範圍查詢 (Range)**: 最後是進行範圍查詢（如 `$gt`, `$lt`）的欄位。

遵循這個順序可以最大化索引的效用。

### 結論

索引是 MongoDB 效能優化的基石。沒有合適的索引，查詢效能會隨著資料量的增長而急劇下降。理解不同索引類型的適用場景，特別是複合索引中欄位順序的重要性，是每個 MongoDB 開發者和管理員的必備技能。透過 `explain()` 方法分析查詢計劃，可以幫助我們驗證查詢是否有效利用了索引，並進行針對性的優化。
