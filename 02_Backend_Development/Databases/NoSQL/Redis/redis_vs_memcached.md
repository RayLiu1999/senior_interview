# Redis 和 Memcached 有什麼核心區別？

- **難度**: 3
- **標籤**: `Redis`, `Memcached`, `Caching`, `NoSQL`

## 問題詳述

請比較 Redis 和 Memcached 這兩個流行的記憶體快取系統，並闡述它們在核心功能、資料結構、持久化和效能模型上的主要區別。

## 核心理論與詳解

Redis 和 Memcached 都是高效能的記憶體鍵值儲存系統，廣泛應用於分散式系統中以加速資料存取。儘管它們的目標相似，但在設計哲學和功能集上有顯著的差異，導致它們適用於不同的場景。

以下是兩者之間的核心區別：

### 1. 支援的資料結構

- **Memcached**:
  - 只支援簡單的 **字串 (String)** 鍵值對。
  - 對於複雜的資料 (如 JSON 物件)，必須在客戶端進行序列化和反序列化，然後以字串形式儲存。這增加了客戶端的處理負擔和網路開銷。

- **Redis**:
  - 被稱為「資料結構伺服器」，除了字串外，原生支援 **List, Hash, Set, Sorted Set** 等多種複雜資料結構。
  - 這允許在伺服器端直接對資料進行原子操作 (例如，向列表中添加元素、增加 Hash 中的計數器)，極大地簡化了應用程式邏輯，並減少了不必要的資料傳輸。

**權衡**: 如果您的應用只需要簡單的鍵值快取，Memcached 足夠輕量和高效。但如果需要處理更複雜的資料關係，如排行榜、訊息佇列或使用者屬性存儲，Redis 的原生資料結構提供了巨大的便利性和效能優勢。

### 2. 資料持久化

- **Memcached**:
  - **不支援**任何形式的資料持久化。所有資料都儲存在記憶體中。
  - 一旦伺服器重啟或崩潰，所有快取資料將會遺失。它是一個純粹的、易失性的 (volatile) 快取系統。

- **Redis**:
  - **支援**兩種主要的持久化機制，確保資料在伺服器重啟後能夠恢復：
    - **RDB (Redis Database)**: 在指定的時間間隔內生成資料集的快照 (snapshot)，將某一時刻的記憶體資料完整寫入磁碟。
    - **AOF (Append-Only File)**: 將所有寫入操作以日誌的形式追加到檔案中。當 Redis 重啟時，會重新執行 AOF 檔案中的所有指令來恢復資料集。
  - 這使得 Redis 不僅能作為快取，還能作為一個可靠的 NoSQL 資料庫使用。

**權衡**: 如果資料遺失是可接受的 (例如，快取可以從後端資料庫重新生成)，Memcached 的設計更為簡單。如果需要保證資料的持久性，Redis 是唯一的選擇。

### 3. 效能與執行緒模型

- **Memcached**:
  - 採用 **多執行緒** 模型。
  - 它可以利用伺服器的多個 CPU 核心來並行處理客戶端請求。在純粹的、高並發的 get/set 操作場景下，其吞吐量可能略高於 Redis。
  - 然而，多執行緒也帶來了執行緒切換和鎖競爭的開銷，尤其是在資料結構變得更複雜時 (雖然 Memcached 本身不支援)。

- **Redis**:
  - 核心網路模型採用 **單執行緒** (在 Redis 6.0 之後，I/O 部分引入了多執行緒以提高網路處理能力，但核心指令執行仍然是單執行緒)。
  - **優點**:
    - 避免了鎖競爭和上下文切換的開銷，使得指令執行是原子性的，實現簡單。
    - 結合 I/O 多路複用技術 (如 epoll)，單執行緒也能高效處理大量並發連接。
  - **限制**: 因為指令是順序執行的，如果某個指令執行時間過長 (例如，對一個巨大的 Set 進行複雜計算)，會阻塞後續所有請求。

**權衡**: 對於簡單的讀寫負載，Memcached 的多執行緒模型在多核 CPU 上可能表現出更高的原始吞吐量。然而，Redis 的單執行緒模型簡化了設計，保證了操作的原子性，並且在絕大多數真實世界的複雜應用中表現得足夠出色。

### 4. 高可用性與分散式支援

- **Memcached**:
  - **本身不提供**高可用性或分散式叢集功能。
  - 分散式部署完全依賴於 **客戶端** 實現。客戶端透過一致性雜湊 (Consistent Hashing) 等演算法來決定將某個 key 儲存到哪個 Memcached 節點。
  - 節點之間互不通信，故障轉移和擴展需要客戶端庫的支援。

- **Redis**:
  - **原生提供**完整的解決方案：
    - **Redis Sentinel (哨兵)**: 一個用於監控主從 (Master-Slave) 架構的系統，可以實現自動故障轉移 (Automatic Failover)。當主節點失效時，哨兵會從從節點中選舉一個新的主節點。
    - **Redis Cluster**: 一個去中心化的分散式叢集方案，提供資料分片 (Sharding)、高可用性和水平擴展能力。節點之間會相互通信以維護叢集狀態。

**權衡**: Memcached 的分散式方案更簡單，但功能有限且依賴客戶端。Redis 提供了更強大、更完整的伺服器端解決方案，簡化了高可用和可擴展架構的部署與維護。

### 總結對照表

| 特性 | Memcached | Redis |
| :--- | :--- | :--- |
| **資料結構** | 僅字串 | 字串, 列表, 雜湊, 集合, 有序集合等 |
| **持久化** | 不支援 | 支援 (RDB, AOF) |
| **執行緒模型** | 多執行緒 | 單執行緒 (核心指令) + I/O 執行緒 (Redis 6+) |
| **高可用性** | 依賴客戶端 | 原生支援 (Sentinel, Cluster) |
| **應用場景** | 純粹的快取 | 快取, 資料庫, 訊息佇列, 分散式鎖等 |
| **網路模型** | I/O 多路複用 | I/O 多路複用 |
