# Elasticsearch 分片與副本機制

- **難度**: 7
- **重要性**: 5
- **標籤**: `Elasticsearch`, `Sharding`, `Replica`, `Distributed`

## 問題詳述

請解釋 Elasticsearch 的分片 (Shard) 和副本 (Replica) 機制，以及如何根據業務需求設計合適的分片策略。

## 核心理論與詳解

### 分片 (Shard) 概念

分片是 Elasticsearch 分散式架構的基礎。一個索引可以被分割成多個分片，每個分片是一個獨立的 Lucene 索引。

#### 分片類型

| 類型 | 說明 | 特點 |
|------|------|------|
| **主分片 (Primary Shard)** | 存放原始資料 | 數量建立後不可變更 |
| **副本分片 (Replica Shard)** | 主分片的完整拷貝 | 數量可動態調整 |

#### 為何需要分片

1. **水平擴展**：
   - 單個節點的儲存和處理能力有限
   - 分片允許資料分散到多個節點

2. **並行處理**：
   - 搜尋請求可以並行在多個分片上執行
   - 提高查詢吞吐量

3. **容錯能力**：
   - 副本分片提供高可用性
   - 節點故障時可自動恢復

### 分片工作原理

#### 文件路由

當索引一個文件時，Elasticsearch 使用以下公式決定文件存放在哪個分片：

```
shard = hash(routing) % number_of_primary_shards
```

- `routing` 預設是文件的 `_id`
- 可以自訂 routing 實現相關資料同分片

#### 搜尋流程

```
1. 客戶端請求 → 協調節點 (Coordinating Node)
2. 協調節點將請求廣播到所有相關分片
3. 每個分片本地執行查詢，返回結果
4. 協調節點合併結果，返回給客戶端
```

這個過程稱為 **Scatter-Gather** 模式。

### 副本機制

#### 副本的作用

1. **高可用性 (High Availability)**：
   - 主分片所在節點故障時，副本可提升為主分片
   - 確保服務不中斷

2. **提升讀取吞吐量**：
   - 搜尋請求可以在主分片或副本分片上執行
   - 更多副本 = 更高的讀取並行度

#### 副本分配規則

- 主分片和其副本 **不能** 在同一節點上
- 確保節點故障時至少有一個完整拷貝存活

### 分片策略設計

#### 分片數量規劃

**考量因素**：

| 因素 | 影響 |
|------|------|
| 資料總量 | 單分片建議 10-50GB |
| 節點數量 | 分片數應能均勻分佈 |
| 查詢模式 | 更多分片可提高並行度 |
| 記憶體 | 每個分片消耗記憶體 |

**經驗法則**：
```
主分片數 = 節點數 × 1.5 ~ 3
單分片大小 = 10GB ~ 50GB
總分片數 = (預估資料量 / 單分片大小) × (1 + 副本數)
```

#### 常見配置模式

**小型叢集 (3 節點)**：
```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}
```
- 主分片：3 個（每節點 1 個）
- 總分片：6 個（3 主 + 3 副本）

**中型叢集 (6 節點)**：
```json
{
  "settings": {
    "number_of_shards": 6,
    "number_of_replicas": 1
  }
}
```

**大型叢集 (讀取密集)**：
```json
{
  "settings": {
    "number_of_shards": 12,
    "number_of_replicas": 2
  }
}
```

### 分片過多的問題

**Over-sharding 的影響**：

1. **記憶體開銷**：每個分片需要記憶體用於 Segment、快取
2. **協調開銷**：搜尋時需要協調更多分片
3. **叢集狀態膨脹**：每個分片的元數據都需要維護

**症狀**：
- 叢集狀態更新變慢
- 搜尋延遲增加
- 記憶體使用過高

### 最佳實踐

#### 1. 索引生命週期管理 (ILM)

對於時序資料（如日誌），使用 Rollover 策略：

```json
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "7d"
          }
        }
      },
      "delete": {
        "min_age": "30d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

#### 2. 使用索引模板

```json
{
  "index_patterns": ["logs-*"],
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}
```

#### 3. 自訂 Routing

將相關資料路由到同一分片，避免跨分片查詢：

```json
PUT /orders/_doc/1?routing=user_123
{
  "user_id": "user_123",
  "order_id": "order_001"
}
```

### 面試重點

1. **分片 vs 副本的區別**
2. **文件路由公式**：為何主分片數不可變
3. **分片數量設計**：如何根據資料量和節點數規劃
4. **Over-sharding 問題**：症狀和解決方案
5. **高可用機制**：副本如何保證可用性
