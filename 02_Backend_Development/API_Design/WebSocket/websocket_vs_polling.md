# WebSocket vs. HTTP Polling/Long-Polling

- **難度**: 6
- **重要性**: 5
- **標籤**: `WebSocket`, `HTTP`, `Polling`, `Real-time`

## 問題詳述

請比較 WebSocket 與傳統的 HTTP 輪詢 (Polling) 和長輪詢 (Long-Polling) 在實現即時通訊時的差異。它們各自的優缺點和適用場景是什麼？

## 核心理論與詳解

在 Web 應用中實現即時或近即時的雙向通訊，是現代 Web 開發的一個常見需求。WebSocket、輪詢和長輪詢是達成此目標的三種主要技術，但它們在效率、延遲和資源消耗上有著顯著的差異。

---

### 1. HTTP 輪詢 (Polling)

輪詢是最簡單、最傳統的實現方式。

- **工作原理**:
  1. 客戶端以固定的時間間隔（例如每 2 秒）向伺服器發送一個 HTTP 請求，詢問「有沒有新數據？」。
  2. 伺服器立即回應，無論有沒有新數據。如果有，就返回新數據；如果沒有，就返回一個空的或表示「無新數據」的回應。
  3. 客戶端在收到回應後，等待下一個時間間隔，然後重複第一步。

- **優點**:
  - **實現簡單**: 前後端實現都非常直觀。
  - **兼容性好**: 幾乎所有的瀏覽器和網路環境都支援。

- **缺點**:
  - **高延遲**: 數據更新的延遲最高可能等於輪詢間隔。如果設定間隔為 5 秒，那麼用戶最多需要等 5 秒才能看到新訊息。
  - **資源浪費**: 大部分請求都是無用的，因為伺服器通常沒有新數據。這會產生大量的 HTTP 請求標頭開銷，並消耗伺服器和網路資源來處理這些空請求。
  - **非真正的即時**: 數據的更新不是由伺服器主動推送的，而是客戶端被動拉取的，存在明顯的延遲。

- **適用場景**:
  - 對即時性要求不高的場景，例如顯示「在線用戶數」，每分鐘更新一次即可。
  - 預期數據更新非常頻繁，以至於每次輪詢幾乎都有新數據的特殊情況。

---

### 2. HTTP 長輪詢 (Long-Polling)

長輪詢是傳統輪詢的一種改良版，旨在減少無效請求並降低延遲。

- **工作原理**:
  1. 客戶端向伺服器發送一個請求，詢問「有沒有新數據？」。
  2. 伺服器**不會立即回應**。它會保持這個請求的連線打開，直到**有新數據**產生，或者連線**超時**。
  3. 一旦有新數據，伺服器會立即將數據作為回應發送給客戶端，並關閉該次連線。
  4. 客戶端收到回應後，**立即**發起下一個新的長輪詢請求，重複第一步。
  5. 如果連線因超時而關閉，客戶端也會立即發起新請求。

- **優點**:
  - **較低的延遲**: 一旦有數據，伺服器會立即推送，延遲遠低於傳統輪詢。
  - **減少無效請求**: 相比傳統輪詢，大大減少了沒有新數據時的空請求數量。

- **缺點**:
  - **伺服器資源消耗**: 維護大量打開的連線會消耗伺服器的記憶體和處理資源。
  - **請求開銷依然存在**: 每次數據交換後，都需要重新建立一個完整的 HTTP 連線，HTTP 標頭的開銷依然存在。
  - **訊息順序問題**: 在高併發下，可能存在多個回應同時到達客戶端，需要客戶端處理訊息的順序問題。

- **適用場景**:
  - 需要比傳統輪詢更低延遲的應用，如 Web IM 的早期實現、即時通知等。
  - 在不支援 WebSocket 的舊版瀏覽器或網路環境中，作為一種向下相容的方案。

---

### 3. WebSocket

WebSocket 是 HTML5 引入的一個全新的、獨立的協議，旨在提供真正的全雙工 (Full-duplex) 通訊。

- **工作原理**:
  1. 客戶端發起一個特殊的 HTTP "Upgrade" 請求，請求將連線從 HTTP 升級到 WebSocket。
  2. 伺服器同意後，這個 TCP 連線就不再是 HTTP 連線了，而是一個持久化的 WebSocket 連線。
  3. 在這個**單一的、持久化的連線**上，客戶端和伺服器可以**隨時、主動地**向對方發送數據。

- **優點**:
  - **真正的即時與雙向通訊**: 伺服器可以隨時主動向客戶端推送數據，延遲極低。
  - **低開銷**: 一旦連線建立，後續的數據交換都使用非常輕量級的數據幀，沒有重複的 HTTP 標頭開銷，極大地節省了頻寬。
  - **性能優越**: 一個單一的長連線避免了重複建立和銷毀連線的開銷，伺服器和客戶端的性能都更好。

- **缺點**:
  - **瀏覽器支援**: 現代瀏覽器都已支援，但一些非常古老的瀏覽器可能不支援。
  - **伺服器端實現更複雜**: 需要專門的伺服器來處理 WebSocket 協議，而不僅僅是標準的 HTTP 伺服器。
  - **防火牆/代理限制**: 某些企業或網路環境的防火牆可能不允許非標準的 HTTP 流量通過，導致 WebSocket 連線失敗。

- **適用場景**:
  - 所有對即時性有高要求的場景，如：線上多人遊戲、即時聊天應用、股票報價、協同編輯工具等。

### 總結對比

| 特性 | HTTP 輪詢 | HTTP 長輪詢 | WebSocket |
| :--- | :--- | :--- | :--- |
| **通訊模式** | 客戶端拉取 | 客戶端拉取 (伺服器保持) | 全雙工 (雙向推送) |
| **延遲** | 高 (取決於輪詢間隔) | 較低 | 極低 |
| **伺服器資源** | 較低 | 較高 (需維持連線) | 高 (需維持連線) |
| **網路開銷** | 非常高 (大量請求標頭) | 較高 (每次數據交換都需新請求) | 非常低 (只需一次握手) |
| **實現複雜度** | 非常簡單 | 簡單 | 較複雜 |
| **即時性** | 差 | 較好 | 最好 |

**結論**:
在現代 Web 開發中，當需要實現真正的即時通訊時，**WebSocket 是首選的標準解決方案**。長輪詢則作為一種在不支援 WebSocket 的環境下的有效降級方案。而傳統的輪詢由於其高延遲和資源浪費，其應用場景已經非常有限。
