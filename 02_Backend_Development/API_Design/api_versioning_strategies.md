# API 版本管理策略

- **難度**: 6
- **重要性**: 5
- **標籤**: `API Design`, `Versioning`

## 問題詳述

為什麼 API 需要進行版本管理？請比較幾種常見的 API 版本管理策略（URI Path, Query Parameter, Custom Header, Accept Header），並分析它們各自的優缺點。

## 核心理論與詳解

API 版本管理是確保 API 在不斷演進的過程中，不會破壞現有客戶端整合的關鍵實踐。當你需要對 API 進行**破壞性變更 (Breaking Change)**，例如修改資源結構、變更欄位名稱或移除端點時，就必須引入一個新版本。

### 為什麼需要版本管理？

1. **向後相容性**: 允許舊的客戶端在不更新的情況下繼續使用舊版本的 API。
2. **平滑過渡**: 為客戶端提供充足的時間從舊版本遷移到新版本。
3. **清晰的溝通**: 明確地告知開發者 API 的哪個版本是穩定的、哪個是即將廢棄的。
4. **獨立的開發與部署**: 允許新舊版本的 API 並行開發和部署。

### 常見的版本管理策略

#### 1. URI 路徑 (URI Path Versioning)

這是最常見、最直觀的方式。版本號直接作為 URI 的一部分。

- **範例**: `https://api.example.com/v1/users`
- **優點**:
  - **非常直觀**: 開發者可以從 URI 中一眼看出正在使用的 API 版本。
  - **易於實現**: 在伺服器端，可以很容易地根據路徑將請求路由到對應的處理邏輯。
  - **易於測試和除錯**: 可以直接在瀏覽器或 cURL 中測試不同版本的端點。
- **缺點**:
  - **違反 REST 原則**: URI 應該用來唯一標識資源，而版本號描述的是資源的表徵，而不是資源本身。`/v1/users/123` 和 `/v2/users/123` 指向的是同一個使用者，卻有不同的 URI。
  - **URI 污染**: 隨著版本增多，URI 會變得越來越長。

#### 2. 查詢參數 (Query Parameter Versioning)

版本號作為 URL 的查詢參數傳遞。

-   **範例**: `https://api.example.com/users?version=1` 或 `?api_version=1`
-   **優點**:
    -   **實現簡單**: 與 URI 路徑類似，在伺服器端容易解析。
    -   **URI 保持純淨**: 資源的 URI (`/users`) 保持不變。
    -   **可以設定預設版本**: 如果不提供 `version` 參數，可以輕鬆地導向到最新的或預設的版本。
-   **缺點**:
    -   **不如路徑直觀**: 版本資訊被隱藏在查詢字串中。
    -   **快取問題**: 某些快取代理可能不會根據查詢參數來快取回應。

#### 3. 自訂標頭 (Custom Header Versioning)

版本號透過一個自訂的 HTTP 標頭來傳遞。

-   **範例**: `curl -H "X-Api-Version: 1" https://api.example.com/users`
-   **優點**:
    -   **URI 保持純淨**: 這是它相對於路徑版本管理的主要優勢。
    -   **不會污染查詢參數**。
-   **缺點**:
    -   **可視性差**: 版本資訊完全隱藏在 HTTP 標頭中，無法透過瀏覽器直接存取。
    -   **客戶端不便**: 客戶端必須記住每次請求都要加上這個特定的標頭。
    -   **沒有廣泛接受的標準**: 標頭名稱（如 `X-Api-Version`, `Api-Version`）沒有統一規範。

#### 4. Accept 標頭 (Accept Header Versioning / Content Negotiation)

版本號作為媒體類型 (Media Type) 的一部分，放在 `Accept` 標頭中。這通常被認為是**最符合 REST 理念**的方式。

- **範例**: `GET /users HTTP/1.1` `Host: api.example.com` `Accept: application/vnd.example.v1+json`
- **優點**:
  - **保持 URI 純淨**: 這是最符合 REST 理念的方式之一，因為 URI 保持不變，僅透過標頭來區分不同版本的資源表徵。
  - **靈活性高**: 可以為每個請求單獨指定版本。
- **缺點**:
  - **可見性差**: 版本資訊隱藏在標頭中，不如放在 URI 中直觀。
  - **測試不便**: 無法直接在瀏覽器中測試，需要使用 cURL 或 Postman 等工具來設定自訂標頭。
  - **快取複雜性**: 如果使用 HTTP 快取，需要確保快取伺服器（如 Varnish 或 CDN）能夠正確處理 `Accept` 標頭，將不同版本的快取分開。

### 總結與建議

| 策略 | 優點 | 缺點 | 推薦度 |
| :--- | :--- | :--- | :--- |
| **URI 路徑** | 直觀，易於實現和測試 | 違反 REST 原則，污染 URI | ⭐⭐⭐⭐⭐ (最實用) |
| **查詢參數** | 實現簡單，可設定預設版本 | 不如路徑直觀，可能影響快取 | ⭐⭐⭐ |
| **自訂標頭** | URI 純淨 | 可視性差，客戶端不便 | ⭐⭐ |
| **Accept 標頭** | 最符合 REST 理念，URI 純淨 | 複雜，不直觀，測試不便 | ⭐⭐⭐⭐ (理論上最好) |

**實用建議**:

- 對於大多數**內部或小型公開 API**，**URI 路徑版本管理** (`/v1/`) 是最實用、最清晰的選擇。它的優點（直觀、易用）遠遠超過了其理論上的缺點。
- 對於需要嚴格遵循 REST 原則的**大型、長生命週期的公開 API**（例如 GitHub API），可以考慮使用 **Accept 標頭**。
- **查詢參數**和**自訂標頭**相對較少被採用，除非有特殊的場景需求。

無論選擇哪種策略，最重要的是**保持一致性**，並在 API 文件中清晰地說明版本管理的方法。
