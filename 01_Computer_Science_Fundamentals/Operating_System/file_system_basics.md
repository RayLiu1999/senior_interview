# 文件系統原理

- **難度**: 5
- **重要程度**: 4
- **標籤**: `inode`, `目錄`, `文件描述符`, `硬鏈接`, `軟鏈接`

## 問題詳述

解釋文件系統的基本原理，包括 inode、目錄結構、文件描述符、硬鏈接與軟鏈接的區別，以及常見文件系統（ext4、XFS、Btrfs）的特點。

## 核心理論與詳解

### 1. 文件系統架構

#### 分層結構

```
應用層
    ↓ open(), read(), write()
VFS (虛擬文件系統層)
    ↓ 統一接口
具體文件系統 (ext4, XFS, NFS...)
    ↓
塊層 (Block Layer)
    ↓
磁盤驅動
    ↓
物理磁盤
```

**VFS 的作用**：
- 為應用提供統一接口
- 支持多種文件系統
- 實現文件系統無關的邏輯

### 2. inode（索引節點）

#### 概念

**inode** 存儲文件的元數據（metadata）：

```
inode 內容：
├─ 文件類型（普通文件、目錄、符號鏈接...）
├─ 權限（rwx）
├─ 所有者（UID、GID）
├─ 大小
├─ 時間戳
│   ├─ atime（訪問時間）
│   ├─ mtime（修改時間）
│   └─ ctime（inode 變更時間）
├─ 硬鏈接計數
└─ 數據塊指針
```

**重點**：
- 文件名**不存儲**在 inode 中
- 文件名存儲在目錄中
- inode 號唯一標識文件

#### 數據塊指針

```
inode 數據塊指針結構（ext4）：
├─ 12 個直接指針 → 直接指向數據塊
├─ 1 個一級間接指針 → 指向間接塊 → 數據塊
├─ 1 個二級間接指針 → 指向間接塊 → 間接塊 → 數據塊
└─ 1 個三級間接指針 → ...

假設塊大小 4KB，指針 4 字節：
- 直接塊：12 × 4KB = 48KB
- 一級間接：(4KB/4B) × 4KB = 4MB
- 二級間接：(4KB/4B)² × 4KB = 4GB
- 三級間接：(4KB/4B)³ × 4KB = 4TB

最大文件大小：4TB+
```

**查看 inode**：
```bash
# 查看文件 inode 號
ls -i file.txt
# 123456 file.txt

# 查看 inode 詳細信息
stat file.txt
```

### 3. 目錄

#### 目錄的本質

**目錄是特殊的文件**，內容是「文件名 → inode 號」的映射表：

```
目錄 /home/user：
┌───────────┬────────┐
│ 文件名    │ inode  │
├───────────┼────────┤
│ .         │ 67890  │ ← 當前目錄
│ ..        │ 2      │ ← 父目錄
│ file.txt  │ 123456 │
│ photo.jpg │ 789012 │
└───────────┴────────┘
```

#### 路徑解析

```
打開文件 /home/user/file.txt：

1. 從根目錄 inode (固定為 2) 開始
2. 讀取根目錄內容，查找 "home" → inode 100
3. 讀取 inode 100（/home 目錄），查找 "user" → inode 200
4. 讀取 inode 200（/home/user 目錄），查找 "file.txt" → inode 123456
5. 讀取 inode 123456，獲取文件元數據和數據塊位置
6. 讀取數據塊
```

**優化**：目錄緩存（Dentry Cache）加速路徑解析

### 4. 文件描述符

#### 三層結構

```
進程A                  系統級
fd 3 ─────┐
fd 4 ─────┼───→ [文件表項] ──→ inode 123456
          │         ├─ 文件偏移量
進程B     │         ├─ 打開模式（R/W）
fd 5 ─────┘         └─ 引用計數

每個進程的文件描述符表 → 全局文件表 → inode
```

**多次打開同一文件**：
```go
fd1 := open("file.txt", O_RDONLY)
fd2 := open("file.txt", O_RDONLY)

// 兩個獨立的文件表項
// 各自的文件偏移量
// 但指向同一個 inode
```

**fork() 後**：
```go
fd := open("file.txt", O_RDONLY)
if fork() == 0 {
    // 子進程
    read(fd, ...)  // 與父進程共享文件表項和偏移量
}
```

### 5. 硬鏈接 vs 軟鏈接

#### 硬鏈接（Hard Link）

```bash
ln file.txt hardlink.txt

# 文件系統結構：
目錄項1: "file.txt" → inode 123456 (鏈接計數=2)
目錄項2: "hardlink.txt" → inode 123456 (同一個inode)

# 刪除任一文件名，inode 不會被釋放（計數-1）
# 只有計數=0 時才釋放
```

**特點**：
- 指向同一個 inode
- 無法跨文件系統
- 無法鏈接目錄（避免循環）
- 與原文件完全平等

#### 軟鏈接（Symbolic Link）

```bash
ln -s file.txt symlink.txt

# 文件系統結構：
目錄項1: "file.txt" → inode 123456 (普通文件)
目錄項2: "symlink.txt" → inode 789012 (符號鏈接)
                            └─ 內容: "file.txt"

# symlink 是一個新文件，內容是路徑字符串
```

**特點**：
- 創建新的 inode
- 可以跨文件系統
- 可以鏈接目錄
- 原文件刪除後變為懸空鏈接

| 特性 | 硬鏈接 | 軟鏈接 |
|------|--------|--------|
| inode | 相同 | 不同 |
| 跨文件系統 | ✗ | ✓ |
| 鏈接目錄 | ✗ | ✓ |
| 原文件刪除 | 仍可訪問 | 變為懸空 |
| 空間佔用 | 無額外開銷 | 存儲路徑字符串 |

### 6. 文件系統類型

#### ext4（第四代擴展文件系統）

**特點**：
- Linux 最常用
- 日誌功能（Journal）
- 支持大文件（16TB）和大卷（1EB）
- 延遲分配（Delayed Allocation）
- 多塊分配（Multiblock Allocation）

**適用場景**：通用Linux系統

#### XFS

**特點**：
- 高性能，大文件處理優秀
- 支持更大文件（8EB）
- 在線調整大小
- 並行 I/O 性能好

**適用場景**：大文件、高吞吐量（視頻、數據庫）

#### Btrfs（B-tree FS）

**特點**：
- 寫時複製（Copy-on-Write）
- 快照（Snapshot）
- 在線碎片整理
- 透明壓縮
- RAID 支持

**適用場景**：需要快照、數據完整性要求高

### 7. 文件操作性能

#### 順序 vs 隨機 I/O

```
順序讀寫：
[塊1][塊2][塊3][塊4] ← 連續訪問，快

隨機讀寫：
[塊1]...[塊100]...[塊50]...[塊200] ← 跳躍訪問，慢（HDD）
```

**優化**：
- 預分配連續空間（fallocate）
- 減少碎片化
- SSD 上隨機 I/O 性能更好

## 實際應用場景

### 1. 數據庫
- InnoDB: 使用 tablespace 文件，避免文件系統開銷
- 使用 Direct I/O 繞過頁緩存

### 2. 容器
- Docker: 使用聯合文件系統（UnionFS）
- 分層存儲，共享基礎鏡像

### 3. 備份系統
- rsync: 使用硬鏈接節省空間
- 時間機器（macOS）: 使用硬鏈接

## 總結

### 核心概念

- **inode**: 存儲文件元數據
- **目錄**: 文件名到 inode 的映射
- **文件描述符**: 進程打開文件的引用
- **硬鏈接**: 多個文件名指向同一inode
- **軟鏈接**: 文件內容是路徑字符串

### 資深工程師需掌握

- 理解文件系統的分層架構
- 選擇合適的文件系統類型
- 優化文件 I/O 性能
- 處理硬鏈接和軟鏈接
- 理解文件系統日誌和恢復機制
