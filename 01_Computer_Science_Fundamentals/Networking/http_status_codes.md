# HTTP 狀態碼完整解析 (HTTP Status Codes)

- **難度**: 3
- **重要程度**: 5
- **標籤**: `HTTP`, `狀態碼`, `REST API`, `錯誤處理`

## 問題詳述

HTTP 狀態碼是伺服器回應請求時，傳遞處理結果語義的標準方式。正確理解並使用狀態碼是 REST API 設計的基礎，也是後端工程師日常排查問題和設計介面的必備知識。

## 核心理論與詳解

### 狀態碼分類

HTTP 狀態碼分為 5 大類，以首位數字區分：

| 類別 | 範圍 | 語義 |
|------|------|------|
| 1xx | 100-199 | 資訊性（Informational）：請求已收到，繼續處理 |
| 2xx | 200-299 | 成功（Success）：請求已成功接收、理解並處理 |
| 3xx | 300-399 | 重定向（Redirection）：需要進一步操作以完成請求 |
| 4xx | 400-499 | 客戶端錯誤（Client Error）：請求包含錯誤，伺服器無法處理 |
| 5xx | 500-599 | 伺服器錯誤（Server Error）：伺服器處理請求時發生錯誤 |

### 1xx 資訊性

- **100 Continue**：客戶端應繼續發送請求體（用於 `Expect: 100-continue` 頭部）
- **101 Switching Protocols**：伺服器同意切換協定，常用於 WebSocket 升級握手

### 2xx 成功

| 狀態碼 | 名稱 | 適用場景 |
|--------|------|---------|
| **200 OK** | 成功 | 標準成功回應，GET/PUT/PATCH 請求成功 |
| **201 Created** | 已創建 | POST 請求成功創建資源，回應 Location 頭部指向新資源 |
| **204 No Content** | 無內容 | DELETE 或 PUT 成功，無需回傳內容 |
| **206 Partial Content** | 部分內容 | 分片下載（Range 請求），支援斷點續傳 |

### 3xx 重定向

| 狀態碼 | 名稱 | 關鍵差異 |
|--------|------|---------|
| **301 Moved Permanently** | 永久重定向 | 瀏覽器快取新 URL，POST 請求可能被改為 GET |
| **302 Found** | 臨時重定向 | 不快取，每次都請求原 URL，POST 可能變 GET |
| **303 See Other** | 查看其他 | POST 後重定向到 GET，常用於 PRG 模式 |
| **304 Not Modified** | 未修改 | 協商快取命中，客戶端使用本地快取即可 |
| **307 Temporary Redirect** | 臨時重定向 | 同 302，但**保證不改變 HTTP 方法和請求體** |
| **308 Permanent Redirect** | 永久重定向 | 同 301，但**保證不改變 HTTP 方法和請求體** |

> **301 vs 307 vs 302 的核心差別**：301/302 可能將 POST 改為 GET；307/308 嚴格保留原始 HTTP 方法。

### 4xx 客戶端錯誤

| 狀態碼 | 名稱 | 適用場景 |
|--------|------|---------|
| **400 Bad Request** | 請求無效 | 請求格式錯誤、參數驗證失敗、JSON 解析錯誤 |
| **401 Unauthorized** | 未認證 | 缺少或無效的認證憑據（Token 過期、未登入） |
| **403 Forbidden** | 禁止訪問 | 已認證但無權限（已登入但無管理員權限） |
| **404 Not Found** | 未找到 | 資源不存在（也可用於隱藏資源，防止資訊洩露） |
| **405 Method Not Allowed** | 方法不允許 | 對端點使用了不支援的 HTTP 方法 |
| **409 Conflict** | 衝突 | 資源狀態衝突（如用戶名已存在、版本衝突） |
| **410 Gone** | 已刪除 | 資源永久刪除（比 404 更明確） |
| **422 Unprocessable Entity** | 無法處理 | 請求格式正確但語義錯誤（業務驗證失敗） |
| **429 Too Many Requests** | 請求過多 | 觸發限流，回應 `Retry-After` 頭部 |

> **401 vs 403 的核心差別**：401 = 你是誰我不知道（未認證）；403 = 我知道你是誰，但你沒有權限（已認證但未授權）

### 5xx 伺服器錯誤

| 狀態碼 | 名稱 | 適用場景 |
|--------|------|---------|
| **500 Internal Server Error** | 內部錯誤 | 未預期的伺服器錯誤，程式崩潰、未捕獲例外 |
| **502 Bad Gateway** | 錯誤閘道 | 反向代理收到上游無效回應（上游服務崩潰） |
| **503 Service Unavailable** | 服務不可用 | 伺服器過載或維護中，可附帶 `Retry-After` |
| **504 Gateway Timeout** | 閘道超時 | 反向代理等待上游回應超時 |

> **502 vs 504**：502 = 上游回應了但內容無效（可能是協定問題）；504 = 上游根本沒回應（超時）

### API 設計中的狀態碼使用原則

1. **語義明確**：不要把所有錯誤都用 400 或 500，選擇最貼切的狀態碼
2. **錯誤詳情在 Body**：狀態碼表達類別，Body 的 JSON 提供具體錯誤資訊（錯誤碼、訊息、詳情）
3. **避免敏感資訊洩露**：用 404 而非 403 回應未授權資源，防止資源枚舉攻擊
4. **統一錯誤格式**：全域統一 `{ "code": "RESOURCE_NOT_FOUND", "message": "...", "details": {...} }`
