# DNS 解析流程與優化

- **難度**: 5
- **重要程度**: 4
- **標籤**: `DNS`, `域名解析`, `快取`, `遞迴查詢`, `效能優化`

## 問題詳述

解釋 DNS (Domain Name System) 的完整解析流程、快取機制，以及如何優化 DNS 查詢效能以降低網站訪問延遲。

## 核心理論與詳解

### 1. DNS 基本概念

**DNS (Domain Name System)** 是網際網路的「電話簿」，負責將人類可讀的域名（如 `www.example.com`）轉換為機器可識別的 IP 位址（如 `93.184.216.34`）。

#### 為什麼需要 DNS？

- **易記性**: 記憶域名比記憶 IP 位址容易
- **靈活性**: 可變更伺服器 IP 而不影響域名
- **負載均衡**: 同一域名可對應多個 IP
- **容錯性**: 主伺服器故障時自動切換

### 2. DNS 層級架構

DNS 採用**分層分散式架構**，從上到下分為：

```
                    . (根域名)
                    │
        ┌───────────┼───────────┐
        │           │           │
       com         org         net       (頂級域名 TLD)
        │           │           │
    ┌───┴───┐   ┌───┴───┐   ┌───┴───┐
 example google wikipedia        ...    (二級域名)
    │
 ┌──┴──┐
www   mail   api                        (子域名)
```

#### 域名結構

完整域名 (FQDN): `www.example.com.`

```
www.example.com.
│   │       │   │
│   │       │   └── 根域名 (通常省略)
│   │       └────── 頂級域名 (TLD, Top-Level Domain)
│   └────────────── 二級域名 (Second-Level Domain)
└────────────────── 子域名/主機名 (Subdomain/Hostname)
```

#### 域名類型

1. **通用頂級域名 (gTLD)**
   - `.com` - 商業
   - `.org` - 組織
   - `.net` - 網路
   - `.edu` - 教育
   - `.gov` - 政府

2. **國家和地區頂級域名 (ccTLD)**
   - `.tw` - 台灣
   - `.cn` - 中國
   - `.jp` - 日本
   - `.uk` - 英國

3. **新通用頂級域名**
   - `.app`, `.dev`, `.cloud`, `.tech` 等

### 3. DNS 記錄類型

| 記錄類型 | 全名 | 用途 | 範例 |
|---------|------|------|------|
| **A** | Address Record | 域名 → IPv4 位址 | `example.com → 93.184.216.34` |
| **AAAA** | IPv6 Address | 域名 → IPv6 位址 | `example.com → 2606:2800:220:1:...` |
| **CNAME** | Canonical Name | 域名別名 | `www.example.com → example.com` |
| **MX** | Mail Exchange | 郵件伺服器 | `example.com → mail.example.com (優先級 10)` |
| **TXT** | Text Record | 文字資訊 (SPF、DKIM) | `"v=spf1 include:_spf.google.com ~all"` |
| **NS** | Name Server | 權威名稱伺服器 | `example.com → ns1.example.com` |
| **SOA** | Start of Authority | 域名授權起始 | 包含主 DNS 伺服器、管理員郵箱等 |
| **PTR** | Pointer Record | IP → 域名 (反向解析) | `34.216.184.93.in-addr.arpa → example.com` |
| **SRV** | Service Record | 服務位置 | `_http._tcp.example.com → server.example.com:80` |
| **CAA** | Certification Authority Authorization | 限制 CA 簽發憑證 | `example.com → "0 issue letsencrypt.org"` |

#### 重要欄位

每筆 DNS 記錄包含：

```
域名 TTL 類別 類型 值

example.com. 3600 IN A 93.184.216.34
│            │    │  │ │
│            │    │  │ └─ 記錄值
│            │    │  └─── 記錄類型
│            │    └────── 類別 (通常是 IN = Internet)
│            └─────────── TTL (生存時間，秒)
└──────────────────────── 域名
```

**TTL (Time To Live)**: 記錄在快取中的有效時間
- 短 TTL (如 60 秒): 變更生效快，但查詢量大
- 長 TTL (如 86400 秒 = 1 天): 查詢量少，但變更生效慢

### 4. 完整的 DNS 解析流程

當用戶在瀏覽器輸入 `www.example.com` 時：

#### 第一步：檢查本地快取

```
1. 瀏覽器快取
   ├─ 檢查: 是否最近訪問過該域名？
   └─ 快取時間: 通常幾分鐘到幾小時

2. 作業系統快取
   ├─ 檢查: /etc/hosts 或系統 DNS 快取
   └─ 優先級: 高於遠端查詢

3. 路由器快取
   ├─ 檢查: 家用路由器的 DNS 快取
   └─ 範圍: 整個區域網路共用
```

**如果命中快取** → 直接返回 IP，**流程結束**

#### 第二步：遞迴查詢 (Recursive Query)

客戶端向 **遞迴解析器 (Recursive Resolver)** 發送查詢請求。

```
客戶端                                    遞迴解析器
  |                                           |
  | ──── 查詢: www.example.com ────────────> |
  |      (遞迴查詢，要求完整答案)               |
  |                                           |
  |                                      [檢查快取]
  |                                           |
  |                                      如果快取未命中
  |                                      開始迭代查詢...
```

**常見的遞迴解析器**:
- ISP 提供的 DNS (如 Hinet 168.95.1.1)
- 公共 DNS: Google (8.8.8.8), Cloudflare (1.1.1.1), Quad9 (9.9.9.9)

#### 第三步：迭代查詢 (Iterative Query)

遞迴解析器依序查詢 DNS 階層，從根域名開始：

```
                   [根 DNS 伺服器]
遞迴解析器              |
  |                    |
  | 1. 查詢: www.example.com 在哪？
  | ─────────────────> |
  |                    |
  | <───────────────── |
  | 2. 回應: 去問 .com 的 NS
  |    (返回 .com TLD 伺服器位址)
  |
  |              [.com TLD 伺服器]
  |                    |
  | 3. 查詢: www.example.com 在哪？
  | ─────────────────> |
  |                    |
  | <───────────────── |
  | 4. 回應: 去問 example.com 的 NS
  |    (返回權威 DNS 伺服器位址)
  |
  |          [example.com 權威 DNS]
  |                    |
  | 5. 查詢: www.example.com 的 A 記錄？
  | ─────────────────> |
  |                    |
  | <───────────────── |
  | 6. 回應: 93.184.216.34
  |    (最終答案)
```

**關鍵差異**:
- **遞迴查詢**: 客戶端只發送一次請求，解析器負責獲取完整答案
- **迭代查詢**: 解析器多次查詢不同伺服器，每次獲得下一步的線索

#### 第四步：返回結果並快取

```
遞迴解析器 ─────────────> 客戶端
  |                          |
  | 返回: 93.184.216.34      |
  |       TTL: 3600 秒       |
  |                          |
  | [快取該結果 3600 秒]     | [瀏覽器快取該結果]
```

### 5. DNS 查詢類型

#### 遞迴查詢 (Recursive Query)

- **發起者**: 客戶端 → 遞迴解析器
- **要求**: 必須返回最終答案或錯誤
- **負責方**: 遞迴解析器負責完成所有後續查詢

#### 迭代查詢 (Iterative Query)

- **發起者**: 遞迴解析器 → 各級 DNS 伺服器
- **回應**: 返回答案或下一步查詢的伺服器位址
- **負責方**: 查詢者自行進行下一步查詢

#### 非遞迴查詢 (Non-Recursive Query)

- **條件**: 解析器快取中已有答案
- **特點**: 直接返回結果，無需進一步查詢

### 6. DNS 快取機制

#### 多層快取架構

```
[瀏覽器快取] ← 最快，但容量小
     ↓
[作業系統快取] ← 所有應用共用
     ↓
[遞迴解析器快取] ← 大容量，服務多個用戶
     ↓
[權威 DNS] ← 最終資料來源
```

#### 快取更新策略

1. **基於 TTL 的被動過期**
   - 記錄超過 TTL 時自動失效
   - 下次查詢重新獲取

2. **主動刷新 (Pre-fetching)**
   - 在 TTL 即將過期時提前更新
   - 避免快取穿透

3. **負快取 (Negative Caching)**
   - 快取「域名不存在」的結果
   - 防止對不存在域名的重複查詢
   - TTL 通常較短 (如 5 分鐘)

#### 快取一致性問題

**問題**: 更新 DNS 記錄後，各層快取可能仍保留舊資料

**解決方案**:
1. **提前降低 TTL**: 變更前幾天將 TTL 降至 60 秒
2. **變更後等待**: 等待原 TTL 時間讓快取自然過期
3. **漸進式切換**: 使用多個 IP，逐步移除舊 IP

### 7. DNS 解析優化策略

#### 策略 1: 使用高效能 DNS 解析器

**公共 DNS 比較**:

| DNS 提供商 | 主 DNS | 次 DNS | 特點 |
|-----------|--------|--------|------|
| **Cloudflare** | 1.1.1.1 | 1.0.0.1 | 最快，注重隱私 |
| **Google** | 8.8.8.8 | 8.8.4.4 | 穩定，全球 Anycast |
| **Quad9** | 9.9.9.9 | 149.112.112.112 | 安全過濾惡意網站 |
| **OpenDNS** | 208.67.222.222 | 208.67.220.220 | 家長控制功能 |

**選擇建議**:
- 使用距離最近的 DNS
- 測試實際解析速度
- 考慮備援和可用性

#### 策略 2: DNS 預解析 (DNS Prefetch)

在 HTML 中提前解析即將使用的域名：

```html
<!-- 預解析靜態資源域名 -->
<link rel="dns-prefetch" href="//static.example.com">
<link rel="dns-prefetch" href="//api.example.com">
<link rel="dns-prefetch" href="//cdn.example.com">

<!-- 禁用隱式預解析 (HTTPS 頁面預設關閉) -->
<meta http-equiv="x-dns-prefetch-control" content="off">
```

**工作原理**:
- 瀏覽器在空閒時提前進行 DNS 查詢
- 當實際需要該域名時，已有快取可用

**注意事項**:
- 只對外部域名有效
- 過多預解析會增加 DNS 負載

#### 策略 3: 減少域名數量

**問題**: 過多子域名增加 DNS 查詢次數

**解決**:
1. **域名收斂**: 合併同類資源到同一域名
2. **使用路徑而非子域名**:
   - ❌ `blog.example.com`, `shop.example.com`
   - ✅ `example.com/blog`, `example.com/shop`

**權衡**: 
- HTTP/1.1 時代需要多域名突破瀏覽器併發限制
- HTTP/2 時代應減少域名，利用多路復用

#### 策略 4: 調整 TTL 值

**場景導向的 TTL 設定**:

| 場景 | 建議 TTL | 理由 |
|-----|---------|------|
| **穩定服務** | 86400 (1 天) | 減少查詢量，降低成本 |
| **即將變更** | 300 (5 分鐘) | 加快切換速度 |
| **高可用切換** | 60 (1 分鐘) | 快速故障轉移 |
| **開發環境** | 60 (1 分鐘) | 頻繁變更，快速生效 |
| **負載均衡** | 60-300 | 支援動態調整 |

#### 策略 5: 使用 DNS 負載均衡

**DNS 輪詢 (Round Robin)**:

```
# 同一域名配置多個 A 記錄
example.com.  60  IN  A  192.0.2.1
example.com.  60  IN  A  192.0.2.2
example.com.  60  IN  A  192.0.2.3
```

**工作原理**:
- DNS 伺服器每次返回不同順序的 IP 列表
- 客戶端通常使用第一個 IP

**限制**:
- 無健康檢查 (故障伺服器仍會返回)
- 無法考慮伺服器負載
- 快取會影響分配均勻性

#### 策略 6: GeoDNS (地理位置路由)

根據用戶地理位置返回最近的伺服器 IP：

```
用戶位置: 亞洲
example.com → 101.200.100.1 (亞洲伺服器)

用戶位置: 歐洲
example.com → 52.58.100.1 (歐洲伺服器)
```

**優勢**:
- 降低延遲
- 符合資料主權要求
- 改善用戶體驗

**提供商**: AWS Route 53, Cloudflare DNS, Azure Traffic Manager

#### 策略 7: EDNS Client Subnet (ECS)

解決遞迴解析器位置與用戶位置不一致的問題：

**問題**:
```
用戶 (台灣) → 遞迴解析器 (美國) → 權威 DNS
                                       ↓
                            返回美國伺服器 IP (不optimal)
```

**解決**: ECS 在查詢中包含客戶端子網資訊
```
遞迴解析器 → 權威 DNS (包含用戶所在地資訊)
                    ↓
          返回台灣伺服器 IP (optimal)
```

#### 策略 8: 使用 CDN

CDN 可大幅減少 DNS 查詢影響：

1. **Anycast**: 單一 IP 對應全球多個節點
2. **邊緣 DNS**: CDN 節點本身提供 DNS 解析
3. **智能路由**: 自動選擇最佳節點

### 8. DNS 安全

#### DNSSEC (DNS Security Extensions)

**目的**: 防止 DNS 欺騙和快取投毒攻擊

**工作原理**:
1. 使用公鑰加密技術對 DNS 記錄進行數位簽章
2. 驗證鏈從根域名延伸到目標域名
3. 確保 DNS 回應的真實性和完整性

**簽章驗證流程**:
```
. (根域名) 的簽章
    ↓ 驗證
.com 的簽章
    ↓ 驗證
example.com 的簽章
    ↓ 驗證
www.example.com 的記錄
```

**新增的 DNS 記錄類型**:
- **RRSIG**: 資源記錄簽章
- **DNSKEY**: 公鑰
- **DS**: 委派簽章者 (鏈接上下層)
- **NSEC/NSEC3**: 證明記錄不存在

**限制**:
- 增加回應大小 (可能需要 TCP)
- 額外的驗證開銷
- 部署複雜度較高

#### DNS over HTTPS (DoH) 和 DNS over TLS (DoT)

**問題**: 傳統 DNS 使用明文傳輸，可被竊聽和劫持

**解決方案**:

| 協定 | 傳輸層 | 預設埠號 | 特點 |
|-----|-------|---------|------|
| **DNS over TLS (DoT)** | TLS | 853 | 獨立埠號，易於識別和阻擋 |
| **DNS over HTTPS (DoH)** | HTTPS | 443 | 偽裝成普通 HTTPS 流量 |

**優勢**:
- 加密查詢內容，保護隱私
- 防止 ISP 監控和 DNS 劫持
- 確保 DNS 回應完整性

**支援情況**:
- Firefox, Chrome 已內建 DoH
- 主流公共 DNS 均支援 (Cloudflare, Google)

#### 防止 DNS 快取投毒

**攻擊手法**: 攻擊者偽造 DNS 回應，注入錯誤記錄到快取

**防護措施**:
1. **隨機查詢 ID**: 每次查詢使用隨機 Transaction ID
2. **隨機源埠號**: 增加猜測難度 (0x20 編碼)
3. **驗證回應來源**: 確認回應來自正確的 DNS 伺服器
4. **使用 DNSSEC**: 透過數位簽章驗證真實性
5. **限制快取時間**: 不信任異常長的 TTL

### 9. DNS 效能監控

#### 關鍵指標

1. **DNS 查詢時間**
   - 測量: 從發送查詢到收到回應的時間
   - 目標: < 50ms (公共 DNS), < 10ms (本地 DNS)

2. **DNS 快取命中率**
   - 計算: (快取命中次數 / 總查詢次數) × 100%
   - 目標: > 90%

3. **DNS 錯誤率**
   - NXDOMAIN (域名不存在)
   - SERVFAIL (伺服器失敗)
   - 超時 (Timeout)

4. **TTL 分布**
   - 追蹤不同記錄的 TTL 設定
   - 優化快取效率

#### 監控工具

- **dig**: 命令行 DNS 查詢工具
  ```bash
  # 查詢 A 記錄
  dig example.com A
  
  # 追蹤完整解析路徑
  dig +trace example.com
  
  # 查詢特定 DNS 伺服器
  dig @8.8.8.8 example.com
  
  # 測量查詢時間
  dig example.com | grep "Query time"
  ```

- **nslookup**: 跨平台 DNS 查詢工具
  ```bash
  nslookup example.com
  nslookup example.com 8.8.8.8
  ```

- **DNS Performance Test**: 測試不同 DNS 解析器速度
  ```bash
  # GRC DNS Benchmark (Windows)
  # namebench (跨平台)
  ```

- **真實用戶監控 (RUM)**
  - 在前端收集實際 DNS 解析時間
  - 使用 Navigation Timing API

### 10. 常見問題與陷阱

#### 問題 1: DNS 傳播延遲

**現象**: 更新 DNS 記錄後，部分用戶仍看到舊資料

**原因**:
- 各層快取的 TTL 尚未過期
- 部分 DNS 解析器不尊重 TTL

**解決**:
- 提前降低 TTL (如變更前 48 小時)
- 變更後等待原 TTL 時間
- 使用監控工具追蹤傳播進度

#### 問題 2: 公共 DNS 的隱私顧慮

**風險**: 公共 DNS 可追蹤用戶訪問的網站

**緩解**:
- 使用注重隱私的 DNS (如 Cloudflare 1.1.1.1)
- 啟用 DNS over HTTPS (DoH)
- 部署本地 DNS 解析器 (如 Unbound + DoH)

#### 問題 3: DNS 放大攻擊

**攻擊原理**: 偽造源 IP，向 DNS 伺服器查詢大記錄 (如 ANY)，回應轉向受害者

**防護**:
- 禁用遞迴查詢 (權威 DNS)
- 限制 ANY 查詢
- 實施速率限制 (Rate Limiting)
- 使用 Response Rate Limiting (RRL)

#### 問題 4: 域名劫持

**現象**: 用戶輸入正確域名，但被導向惡意網站

**原因**:
- 攻擊者控制註冊商帳號
- DNS 伺服器被入侵
- 中間人攻擊

**防護**:
- 啟用雙因素認證 (2FA)
- 鎖定域名 (Registry Lock)
- 使用 DNSSEC
- 監控 DNS 記錄變更

### 11. 實務最佳實踐

#### 域名配置清單

- [ ] 配置主要的 A/AAAA 記錄
- [ ] 設定 www 別名 (CNAME 或 A)
- [ ] 配置 MX 記錄 (郵件)
- [ ] 配置 TXT 記錄 (SPF, DKIM, DMARC)
- [ ] 設定 CAA 記錄 (限制 CA)
- [ ] 啟用 DNSSEC (可選但推薦)
- [ ] 配置多個 NS 記錄 (冗餘)
- [ ] 設定合理的 TTL 值
- [ ] 測試所有記錄的可達性

#### 效能優化清單

- [ ] 使用高效能的 DNS 解析器
- [ ] 實施 DNS 預解析 (關鍵域名)
- [ ] 減少不必要的子域名
- [ ] 配置 GeoDNS (多地區服務)
- [ ] 使用 CDN 加速
- [ ] 啟用 EDNS Client Subnet
- [ ] 監控 DNS 查詢時間
- [ ] 追蹤快取命中率

#### 安全加固清單

- [ ] 啟用 DNSSEC
- [ ] 使用 DNS over HTTPS (DoH)
- [ ] 鎖定重要域名 (Registry Lock)
- [ ] 啟用註冊商的 2FA
- [ ] 設定 CAA 記錄限制 CA
- [ ] 監控 DNS 查詢異常
- [ ] 定期審計 DNS 配置
- [ ] 建立 DNS 變更流程

## 總結

DNS 解析是 Web 請求的第一步，其效能直接影響用戶體驗：

1. **快取是關鍵**: 多層快取機制大幅減少查詢延遲
2. **TTL 需權衡**: 穩定性 vs 靈活性，根據場景調整
3. **安全不可忽視**: DNSSEC 和 DoH 保護隱私和完整性
4. **監控持續優化**: 追蹤關鍵指標，持續改進配置

作為資深後端工程師，你需要：
- 理解完整的 DNS 解析流程和快取機制
- 能夠根據業務需求優化 DNS 配置
- 掌握 DNS 安全最佳實踐
- 在效能、可用性和安全之間找到平衡
