# TCP ä¸‰æ¬¡æ¡æ‰‹èˆ‡å››æ¬¡æ®æ‰‹

- **é›£åº¦**: 5
- **é‡è¦ç¨‹åº¦**: 5
- **æ¨™ç±¤**: `TCP`, `é€£æ¥ç®¡ç†`, `ç‹€æ…‹æ©Ÿ`, `å¯é å‚³è¼¸`

## å•é¡Œè©³è¿°

TCP (Transmission Control Protocol) æ˜¯é¢å‘é€£æ¥çš„å¯é å‚³è¼¸å”å®š,åœ¨å»ºç«‹é€£æ¥æ™‚éœ€è¦é€²è¡Œ**ä¸‰æ¬¡æ¡æ‰‹** (Three-Way Handshake),åœ¨æ–·é–‹é€£æ¥æ™‚éœ€è¦é€²è¡Œ**å››æ¬¡æ®æ‰‹** (Four-Way Wavehand)ã€‚é€™æ˜¯å¾Œç«¯å·¥ç¨‹å¸«é¢è©¦ä¸­çš„å¿…è€ƒé¡Œ,éœ€è¦æ·±å…¥ç†è§£å…¶åŸç†ã€ç‹€æ…‹è½‰æ›ä»¥åŠå¯èƒ½é‡åˆ°çš„å•é¡Œã€‚

## æ ¸å¿ƒç†è«–èˆ‡è©³è§£

### 1. TCP ä¸‰æ¬¡æ¡æ‰‹ (Connection Establishment)

#### æ¡æ‰‹æµç¨‹

```
å®¢æˆ¶ç«¯ (Client)                       ä¼ºæœå™¨ (Server)
     â”‚                                      â”‚
     â”‚  â‘  SYN (seq=x)                       â”‚  LISTEN
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                      â”‚  SYN_RCVD
     â”‚                                      â”‚
     â”‚  â‘¡ SYN+ACK (seq=y, ack=x+1)          â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚  ESTABLISHED                         â”‚
     â”‚                                      â”‚
     â”‚  â‘¢ ACK (seq=x+1, ack=y+1)            â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                      â”‚  ESTABLISHED
     â”‚                                      â”‚
     â”‚  æ•¸æ“šå‚³è¼¸é–‹å§‹                         â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

#### è©³ç´°æ­¥é©Ÿè§£æ

**ç¬¬ä¸€æ¬¡æ¡æ‰‹ (SYN)**:
- **ç™¼é€æ–¹**: å®¢æˆ¶ç«¯
- **æ¨™èªŒä½**: `SYN = 1`
- **åºåˆ—è™Ÿ**: `seq = x` (éš¨æ©Ÿç”Ÿæˆçš„åˆå§‹åºåˆ—è™Ÿ,ISN - Initial Sequence Number)
- **ç‹€æ…‹è®ŠåŒ–**: å®¢æˆ¶ç«¯å¾ `CLOSED` â†’ `SYN_SENT`
- **ç›®çš„**: å®¢æˆ¶ç«¯å‘Šè¨´ä¼ºæœå™¨ã€Œæˆ‘æƒ³å»ºç«‹é€£æ¥,æˆ‘çš„åˆå§‹åºåˆ—è™Ÿæ˜¯ xã€

**ç¬¬äºŒæ¬¡æ¡æ‰‹ (SYN + ACK)**:
- **ç™¼é€æ–¹**: ä¼ºæœå™¨
- **æ¨™èªŒä½**: `SYN = 1`, `ACK = 1`
- **åºåˆ—è™Ÿ**: `seq = y` (ä¼ºæœå™¨éš¨æ©Ÿç”Ÿæˆçš„ ISN)
- **ç¢ºèªè™Ÿ**: `ack = x + 1` (è¡¨ç¤ºã€Œæˆ‘æ”¶åˆ°äº†ä½ çš„ x,æœŸå¾…ä½ ä¸‹ä¸€å€‹å°åŒ…å¾ x+1 é–‹å§‹ã€)
- **ç‹€æ…‹è®ŠåŒ–**: ä¼ºæœå™¨å¾ `LISTEN` â†’ `SYN_RCVD`
- **ç›®çš„**: ä¼ºæœå™¨å‘Šè¨´å®¢æˆ¶ç«¯ã€Œæˆ‘æ”¶åˆ°äº†ä½ çš„è«‹æ±‚,æˆ‘åŒæ„å»ºç«‹é€£æ¥,æˆ‘çš„åˆå§‹åºåˆ—è™Ÿæ˜¯ yã€

**ç¬¬ä¸‰æ¬¡æ¡æ‰‹ (ACK)**:
- **ç™¼é€æ–¹**: å®¢æˆ¶ç«¯
- **æ¨™èªŒä½**: `ACK = 1`
- **åºåˆ—è™Ÿ**: `seq = x + 1`
- **ç¢ºèªè™Ÿ**: `ack = y + 1`
- **ç‹€æ…‹è®ŠåŒ–**: 
  - å®¢æˆ¶ç«¯å¾ `SYN_SENT` â†’ `ESTABLISHED`
  - ä¼ºæœå™¨å¾ `SYN_RCVD` â†’ `ESTABLISHED`
- **ç›®çš„**: å®¢æˆ¶ç«¯ç¢ºèªã€Œæˆ‘æ”¶åˆ°äº†ä½ çš„ç¢ºèª,é€£æ¥å»ºç«‹æˆåŠŸã€

#### ç‚ºä»€éº¼éœ€è¦ä¸‰æ¬¡æ¡æ‰‹?

**1. é˜²æ­¢èˆŠé€£æ¥åˆå§‹åŒ–**

å¦‚æœåªæœ‰å…©æ¬¡æ¡æ‰‹,å¯èƒ½å‡ºç¾ä»¥ä¸‹å•é¡Œ:

```
å ´æ™¯: å®¢æˆ¶ç«¯ç™¼é€çš„ç¬¬ä¸€å€‹ SYN å› ç¶²è·¯å»¶é²è€Œæ»¯ç•™

æ™‚é–“ç·š:
1. å®¢æˆ¶ç«¯ç™¼é€ SYNâ‚ (å› ç¶²è·¯å•é¡Œå»¶é²)
2. å®¢æˆ¶ç«¯è¶…æ™‚,é‡æ–°ç™¼é€ SYNâ‚‚
3. SYNâ‚‚ æˆåŠŸå»ºç«‹é€£æ¥,æ•¸æ“šå‚³è¼¸,é€£æ¥é—œé–‰
4. æ»¯ç•™çš„ SYNâ‚ çµ‚æ–¼åˆ°é”ä¼ºæœå™¨
5. å¦‚æœåªæœ‰å…©æ¬¡æ¡æ‰‹,ä¼ºæœå™¨æœƒèªç‚ºé€™æ˜¯æ–°çš„é€£æ¥è«‹æ±‚
   ä¸¦è¿”å› SYN+ACK,é€²å…¥ ESTABLISHED ç‹€æ…‹
6. ä½†å®¢æˆ¶ç«¯å·²ç¶“é—œé–‰,ä¸æœƒå›æ‡‰,å°è‡´ä¼ºæœå™¨è³‡æºæµªè²»
```

æœ‰äº†ç¬¬ä¸‰æ¬¡æ¡æ‰‹,å®¢æˆ¶ç«¯å¯ä»¥åœ¨ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ™‚æ‹’çµ•é€™å€‹èˆŠé€£æ¥ã€‚

**2. åŒæ­¥é›™æ–¹çš„åˆå§‹åºåˆ—è™Ÿ (ISN)**

- å®¢æˆ¶ç«¯éœ€è¦çŸ¥é“ä¼ºæœå™¨çš„ ISN
- ä¼ºæœå™¨éœ€è¦çŸ¥é“å®¢æˆ¶ç«¯çš„ ISN
- éœ€è¦ä¸‰æ¬¡æ¡æ‰‹æ‰èƒ½å®Œæˆé›™å‘çš„ ISN åŒæ­¥å’Œç¢ºèª

**3. ç¢ºèªé›™æ–¹çš„æ¥æ”¶èƒ½åŠ›**

- ç¬¬ä¸€æ¬¡æ¡æ‰‹: ä¼ºæœå™¨ç¢ºèªã€Œå®¢æˆ¶ç«¯çš„ç™¼é€èƒ½åŠ›æ­£å¸¸ã€
- ç¬¬äºŒæ¬¡æ¡æ‰‹: å®¢æˆ¶ç«¯ç¢ºèªã€Œä¼ºæœå™¨çš„æ¥æ”¶å’Œç™¼é€èƒ½åŠ›æ­£å¸¸ã€
- ç¬¬ä¸‰æ¬¡æ¡æ‰‹: ä¼ºæœå™¨ç¢ºèªã€Œå®¢æˆ¶ç«¯çš„æ¥æ”¶èƒ½åŠ›æ­£å¸¸ã€

### 2. TCP å››æ¬¡æ®æ‰‹ (Connection Termination)

#### æ®æ‰‹æµç¨‹

```
å®¢æˆ¶ç«¯ (Client)                       ä¼ºæœå™¨ (Server)
     â”‚  ESTABLISHED                        â”‚  ESTABLISHED
     â”‚                                     â”‚
     â”‚  â‘  FIN (seq=u)                      â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚  FIN_WAIT_1                         â”‚  CLOSE_WAIT
     â”‚                                     â”‚
     â”‚  â‘¡ ACK (ack=u+1)                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚  FIN_WAIT_2                         â”‚
     â”‚                                     â”‚
     â”‚      (ä¼ºæœå™¨å¯èƒ½ç¹¼çºŒç™¼é€æ•¸æ“š)        â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                     â”‚
     â”‚  â‘¢ FIN (seq=w)                      â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚  TIME_WAIT                          â”‚  LAST_ACK
     â”‚                                     â”‚
     â”‚  â‘£ ACK (ack=w+1)                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚  CLOSED
     â”‚  (ç­‰å¾… 2MSL)                        â”‚
     â”‚  CLOSED                             â”‚
```

#### è©³ç´°æ­¥é©Ÿè§£æ

**ç¬¬ä¸€æ¬¡æ®æ‰‹ (FIN from Client)**:
- **ç™¼é€æ–¹**: å®¢æˆ¶ç«¯ (ä¸»å‹•é—œé–‰æ–¹)
- **æ¨™èªŒä½**: `FIN = 1`
- **åºåˆ—è™Ÿ**: `seq = u`
- **ç‹€æ…‹è®ŠåŒ–**: å®¢æˆ¶ç«¯å¾ `ESTABLISHED` â†’ `FIN_WAIT_1`
- **å«ç¾©**: ã€Œæˆ‘æ²’æœ‰æ•¸æ“šè¦ç™¼é€äº†,ä½†ä»å¯ä»¥æ¥æ”¶æ•¸æ“šã€

**ç¬¬äºŒæ¬¡æ®æ‰‹ (ACK from Server)**:
- **ç™¼é€æ–¹**: ä¼ºæœå™¨ (è¢«å‹•é—œé–‰æ–¹)
- **æ¨™èªŒä½**: `ACK = 1`
- **ç¢ºèªè™Ÿ**: `ack = u + 1`
- **ç‹€æ…‹è®ŠåŒ–**: 
  - ä¼ºæœå™¨å¾ `ESTABLISHED` â†’ `CLOSE_WAIT`
  - å®¢æˆ¶ç«¯å¾ `FIN_WAIT_1` â†’ `FIN_WAIT_2`
- **å«ç¾©**: ã€Œæˆ‘çŸ¥é“ä½ è¦é—œé–‰é€£æ¥äº†,ä½†æˆ‘å¯èƒ½é‚„æœ‰æ•¸æ“šè¦ç™¼é€ã€

**ç¬¬ä¸‰æ¬¡æ®æ‰‹ (FIN from Server)**:
- **ç™¼é€æ–¹**: ä¼ºæœå™¨
- **æ¨™èªŒä½**: `FIN = 1`
- **åºåˆ—è™Ÿ**: `seq = w`
- **ç‹€æ…‹è®ŠåŒ–**: ä¼ºæœå™¨å¾ `CLOSE_WAIT` â†’ `LAST_ACK`
- **å«ç¾©**: ã€Œæˆ‘çš„æ•¸æ“šä¹Ÿç™¼é€å®Œäº†,å¯ä»¥é—œé–‰é€£æ¥äº†ã€

**ç¬¬å››æ¬¡æ®æ‰‹ (ACK from Client)**:
- **ç™¼é€æ–¹**: å®¢æˆ¶ç«¯
- **æ¨™èªŒä½**: `ACK = 1`
- **ç¢ºèªè™Ÿ**: `ack = w + 1`
- **ç‹€æ…‹è®ŠåŒ–**: 
  - å®¢æˆ¶ç«¯å¾ `FIN_WAIT_2` â†’ `TIME_WAIT` (ç­‰å¾… 2MSL å¾Œ) â†’ `CLOSED`
  - ä¼ºæœå™¨å¾ `LAST_ACK` â†’ `CLOSED`
- **å«ç¾©**: ã€Œæˆ‘ç¢ºèªæ”¶åˆ°ä½ çš„é—œé–‰è«‹æ±‚,é€£æ¥é—œé–‰ã€

#### ç‚ºä»€éº¼éœ€è¦å››æ¬¡æ®æ‰‹?

**TCP æ˜¯å…¨é›™å·¥é€šä¿¡**:
- å®¢æˆ¶ç«¯ç™¼é€ FIN,åªä»£è¡¨å®¢æˆ¶ç«¯ä¸å†ç™¼é€æ•¸æ“š
- ä½†ä¼ºæœå™¨å¯èƒ½é‚„æœ‰æ•¸æ“šè¦ç™¼é€
- æ‰€ä»¥éœ€è¦ä¼ºæœå™¨å–®ç¨ç™¼é€ FIN ä¾†é—œé–‰å¦ä¸€å€‹æ–¹å‘çš„é€£æ¥

**ç‚ºä»€éº¼ä¸èƒ½åˆä½µç‚ºä¸‰æ¬¡?**
- åœ¨æŸäº›æƒ…æ³ä¸‹å¯ä»¥åˆä½µ (å¦‚æœä¼ºæœå™¨æ²’æœ‰æ•¸æ“šè¦ç™¼é€,å¯ä»¥åœ¨ç¬¬äºŒæ¬¡æ®æ‰‹æ™‚åŒæ™‚ç™¼é€ FIN+ACK)
- ä½†é€šå¸¸æƒ…æ³ä¸‹,ä¼ºæœå™¨æ”¶åˆ° FIN å¾Œå¯èƒ½é‚„æœ‰æ•¸æ“šè¦ç™¼é€,æ‰€ä»¥éœ€è¦åˆ†é–‹

### 3. TCP ç‹€æ…‹è½‰æ›åœ–

#### å®Œæ•´ç‹€æ…‹æ©Ÿ

```
                              +---------+
                              |  CLOSED |
                              +----+----+
                                   |
                    ä¸»å‹•é–‹å•Ÿ / ç™¼é€ SYN
                                   |
                                   v
                            +-------------+
                    â”Œâ”€â”€â”€â”€â”€â”€â”€| SYN_SENT    |
                    |       +-------------+
                    |              |
          æ¥æ”¶ SYN  |              | æ¥æ”¶ SYN+ACK / ç™¼é€ ACK
          ç™¼é€ SYN+ACK |            v
                    |       +-------------+
                    â””â”€â”€â”€â”€â”€â”€>| ESTABLISHED |<â”€â”€â”€â”€â”€â”€â”
                            +------+------+       |
                                   |              |
                           ä¸»å‹•é—œé–‰ |              | è¢«å‹•é–‹å•Ÿ
                         ç™¼é€ FIN   |              | æ¥æ”¶ SYN / ç™¼é€ SYN+ACK
                                   |              |
                                   v              |
                            +-------------+  +-----------+
                            | FIN_WAIT_1  |  | LISTEN    |
                            +------+------+  +-----------+
                                   |              |
                   æ¥æ”¶ ACK        |              | æ¥æ”¶ SYN / ç™¼é€ SYN+ACK
                                   |              v
                                   v         +-------------+
                            +-------------+  | SYN_RCVD    |
                            | FIN_WAIT_2  |  +------+------+
                            +------+------+         |
                                   |                | æ¥æ”¶ ACK
                   æ¥æ”¶ FIN        |                v
                   ç™¼é€ ACK        |         +-------------+
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€>| ESTABLISHED |
                                             +------+------+
                                                    |
                                          è¢«å‹•é—œé–‰  |
                                          æ¥æ”¶ FIN / ç™¼é€ ACK
                                                    |
                                                    v
                                             +-------------+
                                             | CLOSE_WAIT  |
                                             +------+------+
                                                    |
                                             ç™¼é€ FIN
                                                    |
                                                    v
                                             +-------------+
                                             | LAST_ACK    |
                                             +------+------+
                                                    |
                                             æ¥æ”¶ ACK
                                                    |
                                                    v
                                             +---------+
                                             | CLOSED  |
                                             +---------+
```

#### é—œéµç‹€æ…‹èªªæ˜

| ç‹€æ…‹ | èªªæ˜ | èª°æœƒè™•æ–¼æ­¤ç‹€æ…‹ |
|------|------|----------------|
| **CLOSED** | åˆå§‹ç‹€æ…‹,æ²’æœ‰é€£æ¥ | æ‰€æœ‰ |
| **LISTEN** | ä¼ºæœå™¨ç­‰å¾…é€£æ¥ | ä¼ºæœå™¨ |
| **SYN_SENT** | ç™¼é€ SYN,ç­‰å¾…ç¢ºèª | å®¢æˆ¶ç«¯ |
| **SYN_RCVD** | æ”¶åˆ° SYN,ç™¼é€ SYN+ACK,ç­‰å¾… ACK | ä¼ºæœå™¨ |
| **ESTABLISHED** | é€£æ¥å»ºç«‹,å¯ä»¥å‚³è¼¸æ•¸æ“š | é›™æ–¹ |
| **FIN_WAIT_1** | ç™¼é€ FIN,ç­‰å¾… ACK æˆ– FIN | ä¸»å‹•é—œé–‰æ–¹ |
| **FIN_WAIT_2** | æ”¶åˆ° ACK,ç­‰å¾…å°æ–¹çš„ FIN | ä¸»å‹•é—œé–‰æ–¹ |
| **CLOSE_WAIT** | æ”¶åˆ° FIN,ç™¼é€ ACK,ç­‰å¾…æ‡‰ç”¨é—œé–‰ | è¢«å‹•é—œé–‰æ–¹ |
| **LAST_ACK** | ç™¼é€ FIN,ç­‰å¾…æœ€å¾Œçš„ ACK | è¢«å‹•é—œé–‰æ–¹ |
| **TIME_WAIT** | æ”¶åˆ° FIN,ç™¼é€ ACK,ç­‰å¾… 2MSL | ä¸»å‹•é—œé–‰æ–¹ |
| **CLOSING** | åŒæ™‚é—œé–‰çš„ä¸­é–“ç‹€æ…‹ | é›™æ–¹åŒæ™‚é—œé–‰ |

### 4. TIME_WAIT ç‹€æ…‹æ·±å…¥è§£æ

#### ç‚ºä»€éº¼éœ€è¦ TIME_WAIT?

**1. ç¢ºä¿æœ€å¾Œçš„ ACK èƒ½å¤ åˆ°é”**

```
å¦‚æœæ²’æœ‰ TIME_WAIT,ç›´æ¥é€²å…¥ CLOSED:

å®¢æˆ¶ç«¯                    ä¼ºæœå™¨
   â”‚                        â”‚ LAST_ACK
   â”‚  â‘£ ACK                 â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€X (ä¸Ÿå¤±)â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚ CLOSED                 â”‚
   â”‚                        â”‚ è¶…æ™‚é‡å‚³ FIN
   â”‚  FIN                   â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚ (å·²é—œé–‰,ç„¡æ³•å›æ‡‰)       â”‚
   â”‚                        â”‚ ä¼ºæœå™¨ç„¡æ³•æ­£å¸¸é—œé–‰
```

æœ‰äº† TIME_WAIT,å®¢æˆ¶ç«¯æœƒåœ¨ 2MSL æ™‚é–“å…§ç­‰å¾…:
- å¦‚æœæ”¶åˆ°é‡å‚³çš„ FIN,å¯ä»¥é‡æ–°ç™¼é€ ACK
- ç¢ºä¿ä¼ºæœå™¨èƒ½å¤ æ­£å¸¸é€²å…¥ CLOSED ç‹€æ…‹

**2. é˜²æ­¢èˆŠé€£æ¥çš„æ•¸æ“šåŒ…å¹²æ“¾æ–°é€£æ¥**

```
å ´æ™¯: å¿«é€Ÿé‡ç”¨åŒä¸€å€‹ (IP:Port) å››å…ƒçµ„

1. èˆŠé€£æ¥é—œé–‰,ä½†ç¶²è·¯ä¸­å¯èƒ½é‚„æœ‰æ»¯ç•™çš„æ•¸æ“šåŒ…
2. ç«‹å³å»ºç«‹æ–°é€£æ¥ (ç›¸åŒçš„ IP å’Œ Port)
3. èˆŠé€£æ¥çš„æ»¯ç•™æ•¸æ“šåŒ…åˆ°é”,è¢«æ–°é€£æ¥èª¤èªç‚ºæ˜¯è‡ªå·±çš„æ•¸æ“š
4. å°è‡´æ•¸æ“šæ··äº‚

TIME_WAIT ç­‰å¾… 2MSL (Maximum Segment Lifetime):
- ç¢ºä¿èˆŠé€£æ¥çš„æ‰€æœ‰æ•¸æ“šåŒ…éƒ½å·²ç¶“æ¶ˆå¤±
- MSL é€šå¸¸æ˜¯ 30 ç§’åˆ° 2 åˆ†é˜
- 2MSL = 60 ç§’åˆ° 4 åˆ†é˜
```

#### TIME_WAIT çš„å•é¡Œ

**é«˜ä¸¦ç™¼å ´æ™¯ä¸‹çš„å•é¡Œ**:
- æ¯å€‹ TIME_WAIT é€£æ¥æœƒå ç”¨ä¸€å€‹æœ¬åœ°ç«¯å£ (å®¢æˆ¶ç«¯ç«¯å£ç¯„åœé€šå¸¸æ˜¯ 32768-61000,ç´„ 28000 å€‹)
- å¦‚æœçŸ­æ™‚é–“å…§å»ºç«‹å¤§é‡é€£æ¥,å¯èƒ½è€—ç›¡æœ¬åœ°ç«¯å£
- ä¼ºæœå™¨ç«¯å¦‚æœæ˜¯ä¸»å‹•é—œé–‰æ–¹,ä¹Ÿæœƒç”¢ç”Ÿå¤§é‡ TIME_WAIT

**è§£æ±ºæ–¹æ¡ˆ**:

```bash
# Linux ç³»çµ±å„ªåŒ–

# 1. å•Ÿç”¨ TIME_WAIT å¿«é€Ÿå›æ”¶ (è¬¹æ…ä½¿ç”¨,å¯èƒ½å°è‡´å•é¡Œ)
net.ipv4.tcp_tw_reuse = 1

# 2. ç¸®çŸ­ FIN è¶…æ™‚æ™‚é–“
net.ipv4.tcp_fin_timeout = 30

# 3. å¢åŠ æœ¬åœ°ç«¯å£ç¯„åœ
net.ipv4.ip_local_port_range = 10000 65000

# 4. å•Ÿç”¨ TCP æ™‚é–“æˆ³ (é…åˆ tw_reuse ä½¿ç”¨)
net.ipv4.tcp_timestamps = 1
```

**ç¨‹å¼ç¢¼å±¤é¢**:
- ç›¡é‡è®“å®¢æˆ¶ç«¯ä¸»å‹•é—œé–‰é€£æ¥ (TIME_WAIT åˆ†æ•£åˆ°å®¢æˆ¶ç«¯)
- ä½¿ç”¨é€£æ¥æ± ,é‡ç”¨é€£æ¥
- ä½¿ç”¨ HTTP Keep-Alive

### 5. åŠé€£æ¥éšŠåˆ—èˆ‡å…¨é€£æ¥éšŠåˆ—

#### åŠé€£æ¥éšŠåˆ— (SYN Queue)

**å®šç¾©**: å„²å­˜è™•æ–¼ `SYN_RCVD` ç‹€æ…‹çš„é€£æ¥

**æµç¨‹**:
```
1. ä¼ºæœå™¨æ”¶åˆ° SYN,æ”¾å…¥åŠé€£æ¥éšŠåˆ—
2. ç™¼é€ SYN+ACK
3. æ”¶åˆ° ACK å¾Œ,å¾åŠé€£æ¥éšŠåˆ—ç§»é™¤,æ”¾å…¥å…¨é€£æ¥éšŠåˆ—
```

**éšŠåˆ—æ»¿çš„å¾Œæœ**:
- æ–°çš„ SYN è«‹æ±‚æœƒè¢«ä¸Ÿæ£„
- å¯èƒ½å°è‡´ SYN Flood æ”»æ“Š

**èª¿æ•´åƒæ•¸**:
```bash
# åŠé€£æ¥éšŠåˆ—å¤§å°
net.ipv4.tcp_max_syn_backlog = 8192

# SYN Cookie (é˜²ç¦¦ SYN Flood)
net.ipv4.tcp_syncookies = 1
```

#### å…¨é€£æ¥éšŠåˆ— (Accept Queue)

**å®šç¾©**: å„²å­˜è™•æ–¼ `ESTABLISHED` ç‹€æ…‹,ç­‰å¾…æ‡‰ç”¨ç¨‹åº `accept()` çš„é€£æ¥

**æµç¨‹**:
```
1. ä¸‰æ¬¡æ¡æ‰‹å®Œæˆ,é€£æ¥é€²å…¥å…¨é€£æ¥éšŠåˆ—
2. æ‡‰ç”¨ç¨‹åºèª¿ç”¨ accept() å¾éšŠåˆ—ä¸­å–å‡ºé€£æ¥
3. é–‹å§‹æ•¸æ“šå‚³è¼¸
```

**éšŠåˆ—æ»¿çš„å¾Œæœ**:
- æ–°å®Œæˆçš„é€£æ¥ç„¡æ³•é€²å…¥éšŠåˆ—
- å®¢æˆ¶ç«¯æœƒæ”¶åˆ° RST (é‡ç½®)
- æˆ–è€…ä¼ºæœå™¨æœƒä¸Ÿæ£„ ACK,å°è‡´å®¢æˆ¶ç«¯é‡å‚³

**èª¿æ•´åƒæ•¸**:
```bash
# å…¨é€£æ¥éšŠåˆ—å¤§å° (å– somaxconn å’Œ listen backlog çš„æœ€å°å€¼)
net.core.somaxconn = 8192

# åœ¨ç¨‹å¼ç¢¼ä¸­è¨­ç½® backlog
listen(sockfd, 8192)  // C èªè¨€
```

### 6. SYN Flood æ”»æ“Šèˆ‡é˜²ç¦¦

#### æ”»æ“ŠåŸç†

```
æ”»æ“Šè€…                        ä¼ºæœå™¨
   â”‚                            â”‚
   â”‚  SYN (å½é€ æº IP)            â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ æ”¾å…¥åŠé€£æ¥éšŠåˆ—
   â”‚                            â”‚ ç™¼é€ SYN+ACK (ç™¼å¾€å½é€ çš„ IP)
   â”‚                            â”‚
   â”‚  (ä¸å›æ‡‰ ACK)               â”‚ ç­‰å¾…è¶…æ™‚ (é€šå¸¸ 63 ç§’)
   â”‚                            â”‚
   â”‚  å¤§é‡ SYN...               â”‚ åŠé€£æ¥éšŠåˆ—è¢«å¡«æ»¿
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                            â”‚ æ­£å¸¸é€£æ¥ç„¡æ³•å»ºç«‹
```

**å¾Œæœ**:
- åŠé€£æ¥éšŠåˆ—è¢«å¡«æ»¿
- ä¼ºæœå™¨è³‡æºè€—ç›¡ (è¨˜æ†¶é«”ã€CPU)
- æ­£å¸¸ç”¨æˆ¶ç„¡æ³•å»ºç«‹é€£æ¥

#### é˜²ç¦¦æªæ–½

**1. SYN Cookie**

åŸç†: ä¸ä½¿ç”¨åŠé€£æ¥éšŠåˆ—,è€Œæ˜¯å°‡é€£æ¥ä¿¡æ¯ç·¨ç¢¼åˆ° ISN ä¸­

```bash
net.ipv4.tcp_syncookies = 1
```

å·¥ä½œæµç¨‹:
```
1. æ”¶åˆ° SYN,ä¸å‰µå»º SYN_RCVD çµæ§‹
2. æ ¹æ“šå®¢æˆ¶ç«¯ä¿¡æ¯è¨ˆç®—ä¸€å€‹ç‰¹æ®Šçš„ ISN (Cookie)
3. ç™¼é€ SYN+ACK,ISN = Cookie
4. æ”¶åˆ° ACK å¾Œ,é©—è­‰ Cookie æ˜¯å¦æ­£ç¢º
5. å¦‚æœæ­£ç¢º,ç›´æ¥å‰µå»º ESTABLISHED é€£æ¥
```

å„ªé»: ä¸å ç”¨åŠé€£æ¥éšŠåˆ—
ç¼ºé»: ç„¡æ³•ä½¿ç”¨ TCP é¸é … (å¦‚çª—å£ç¸®æ”¾)

**2. å¢åŠ åŠé€£æ¥éšŠåˆ—å¤§å°**

```bash
net.ipv4.tcp_max_syn_backlog = 16384
```

**3. æ¸›å°‘ SYN+ACK é‡å‚³æ¬¡æ•¸**

```bash
# é»˜èªé‡å‚³ 5 æ¬¡,ç­‰å¾…ç´„ 63 ç§’
# èª¿æ•´ç‚ºé‡å‚³ 2 æ¬¡,ç­‰å¾…ç´„ 7 ç§’
net.ipv4.tcp_synack_retries = 2
```

**4. ä½¿ç”¨é˜²ç«ç‰† / è² è¼‰å‡è¡¡å™¨**

- **é€Ÿç‡é™åˆ¶**: é™åˆ¶å–®ä¸€ IP çš„ SYN è«‹æ±‚é€Ÿç‡
- **IP é»‘åå–®**: å°é–æ”»æ“Šä¾†æº
- **SYN Proxy**: é˜²ç«ç‰†ä»£æ›¿ä¼ºæœå™¨å®Œæˆä¸‰æ¬¡æ¡æ‰‹

## ç¨‹å¼ç¢¼ç¯„ä¾‹

```go
package main

import (
	"fmt"
	"net"
	"os"
	"syscall"
	"time"
)

// æ¼”ç¤º TCP ä¸‰æ¬¡æ¡æ‰‹èˆ‡å››æ¬¡æ®æ‰‹

// 1. ç°¡å–®çš„ TCP ä¼ºæœå™¨,è§€å¯Ÿé€£æ¥å»ºç«‹å’Œé—œé–‰
func tcpServer() {
	// ç›£è½ TCP ç«¯å£
	listener, err := net.Listen("tcp", ":8080")
	if err != nil {
		fmt.Println("ç›£è½å¤±æ•—:", err)
		return
	}
	defer listener.Close()
	
	fmt.Println("ä¼ºæœå™¨å•Ÿå‹•,ç›£è½ :8080")
	fmt.Println("ä¸‰æ¬¡æ¡æ‰‹éç¨‹:")
	fmt.Println("  1. æ”¶åˆ° SYN,é€²å…¥ SYN_RCVD ç‹€æ…‹")
	fmt.Println("  2. ç™¼é€ SYN+ACK")
	fmt.Println("  3. æ”¶åˆ° ACK,é€²å…¥ ESTABLISHED ç‹€æ…‹")
	fmt.Println()
	
	for {
		// accept() å¾å…¨é€£æ¥éšŠåˆ—ä¸­å–å‡ºé€£æ¥
		// æ­¤æ™‚ä¸‰æ¬¡æ¡æ‰‹å·²ç¶“å®Œæˆ
		conn, err := listener.Accept()
		if err != nil {
			fmt.Println("æ¥å—é€£æ¥å¤±æ•—:", err)
			continue
		}
		
		fmt.Printf("âœ… é€£æ¥å»ºç«‹: %s â†’ %s\n", conn.RemoteAddr(), conn.LocalAddr())
		
		// è™•ç†é€£æ¥
		go handleConnection(conn)
	}
}

func handleConnection(conn net.Conn) {
	defer func() {
		fmt.Printf("ğŸ”´ é–‹å§‹å››æ¬¡æ®æ‰‹: %s\n", conn.RemoteAddr())
		conn.Close() // è§¸ç™¼å››æ¬¡æ®æ‰‹
		fmt.Printf("ğŸ”´ é€£æ¥é—œé–‰: %s\n", conn.RemoteAddr())
	}()
	
	// è®€å–æ•¸æ“š
	buffer := make([]byte, 1024)
	n, err := conn.Read(buffer)
	if err != nil {
		fmt.Println("è®€å–å¤±æ•—:", err)
		return
	}
	
	fmt.Printf("ğŸ“© æ”¶åˆ°æ•¸æ“š (%d å­—ç¯€): %s\n", n, buffer[:n])
	
	// å›æ‡‰æ•¸æ“š
	response := "HTTP/1.1 200 OK\r\nContent-Length: 13\r\n\r\nHello, World!"
	_, err = conn.Write([]byte(response))
	if err != nil {
		fmt.Println("ç™¼é€å¤±æ•—:", err)
		return
	}
	
	fmt.Printf("ğŸ“¤ ç™¼é€éŸ¿æ‡‰\n")
	
	// çŸ­æš«å»¶é²,æ¨¡æ“¬è™•ç†æ™‚é–“
	time.Sleep(1 * time.Second)
}

// 2. TCP å®¢æˆ¶ç«¯,ä¸»å‹•å»ºç«‹é€£æ¥
func tcpClient() {
	fmt.Println("å®¢æˆ¶ç«¯é–‹å§‹ä¸‰æ¬¡æ¡æ‰‹:")
	fmt.Println("  1. ç™¼é€ SYN,é€²å…¥ SYN_SENT ç‹€æ…‹")
	fmt.Println("  2. æ”¶åˆ° SYN+ACK")
	fmt.Println("  3. ç™¼é€ ACK,é€²å…¥ ESTABLISHED ç‹€æ…‹")
	fmt.Println()
	
	// Dial æœƒè‡ªå‹•å®Œæˆä¸‰æ¬¡æ¡æ‰‹
	conn, err := net.Dial("tcp", "localhost:8080")
	if err != nil {
		fmt.Println("é€£æ¥å¤±æ•—:", err)
		return
	}
	defer conn.Close()
	
	fmt.Printf("âœ… é€£æ¥å»ºç«‹æˆåŠŸ: %s â†’ %s\n", conn.LocalAddr(), conn.RemoteAddr())
	
	// ç™¼é€æ•¸æ“š
	request := "GET / HTTP/1.1\r\nHost: localhost\r\n\r\n"
	_, err = conn.Write([]byte(request))
	if err != nil {
		fmt.Println("ç™¼é€å¤±æ•—:", err)
		return
	}
	
	fmt.Println("ğŸ“¤ ç™¼é€è«‹æ±‚")
	
	// æ¥æ”¶éŸ¿æ‡‰
	buffer := make([]byte, 1024)
	n, err := conn.Read(buffer)
	if err != nil {
		fmt.Println("æ¥æ”¶å¤±æ•—:", err)
		return
	}
	
	fmt.Printf("ğŸ“© æ”¶åˆ°éŸ¿æ‡‰ (%d å­—ç¯€):\n%s\n", n, buffer[:n])
	
	fmt.Println("\nå®¢æˆ¶ç«¯ä¸»å‹•é—œé–‰é€£æ¥ (å››æ¬¡æ®æ‰‹):")
	fmt.Println("  1. ç™¼é€ FIN,é€²å…¥ FIN_WAIT_1 ç‹€æ…‹")
	fmt.Println("  2. æ”¶åˆ° ACK,é€²å…¥ FIN_WAIT_2 ç‹€æ…‹")
	fmt.Println("  3. æ”¶åˆ° FIN,é€²å…¥ TIME_WAIT ç‹€æ…‹")
	fmt.Println("  4. ç™¼é€ ACK,ç­‰å¾… 2MSL å¾Œé—œé–‰")
}

// 3. ä½¿ç”¨ netstat è§€å¯Ÿ TCP ç‹€æ…‹
func demonstrateTCPStates() {
	fmt.Println("\nä½¿ç”¨ netstat è§€å¯Ÿ TCP ç‹€æ…‹:")
	fmt.Println("åœ¨å¦ä¸€å€‹çµ‚ç«¯åŸ·è¡Œä»¥ä¸‹å‘½ä»¤:")
	fmt.Println("  Linux/Mac: netstat -an | grep 8080")
	fmt.Println("  æˆ–ä½¿ç”¨: ss -tan | grep 8080")
	fmt.Println("\nä½ æœƒçœ‹åˆ°é¡ä¼¼çš„è¼¸å‡º:")
	fmt.Println("  tcp  0  0  0.0.0.0:8080  0.0.0.0:*  LISTEN       # ä¼ºæœå™¨ç›£è½")
	fmt.Println("  tcp  0  0  127.0.0.1:8080  127.0.0.1:54321  ESTABLISHED  # é€£æ¥å·²å»ºç«‹")
	fmt.Println("  tcp  0  0  127.0.0.1:54321  127.0.0.1:8080  FIN_WAIT_2   # ä¸»å‹•é—œé–‰,ç­‰å¾…å°æ–¹ FIN")
	fmt.Println("  tcp  0  0  127.0.0.1:8080  127.0.0.1:54321  CLOSE_WAIT   # è¢«å‹•é—œé–‰,ç­‰å¾…æ‡‰ç”¨é—œé–‰")
	fmt.Println("  tcp  0  0  127.0.0.1:54321  127.0.0.1:8080  TIME_WAIT    # ç­‰å¾… 2MSL")
}

// 4. é…ç½® TCP åƒæ•¸ (éœ€è¦ root æ¬Šé™)
func configureTCPParameters() {
	fmt.Println("\n=== TCP åƒæ•¸é…ç½®å»ºè­° ===\n")
	
	fmt.Println("# æŸ¥çœ‹ç•¶å‰ TCP åƒæ•¸")
	fmt.Println("sysctl -a | grep tcp")
	fmt.Println()
	
	fmt.Println("# åŠé€£æ¥éšŠåˆ—å¤§å° (é˜²ç¦¦ SYN Flood)")
	fmt.Println("sysctl -w net.ipv4.tcp_max_syn_backlog=8192")
	fmt.Println()
	
	fmt.Println("# å…¨é€£æ¥éšŠåˆ—å¤§å°")
	fmt.Println("sysctl -w net.core.somaxconn=8192")
	fmt.Println()
	
	fmt.Println("# å•Ÿç”¨ SYN Cookie (é˜²ç¦¦ SYN Flood)")
	fmt.Println("sysctl -w net.ipv4.tcp_syncookies=1")
	fmt.Println()
	
	fmt.Println("# TIME_WAIT å„ªåŒ– (é«˜ä¸¦ç™¼å ´æ™¯)")
	fmt.Println("sysctl -w net.ipv4.tcp_tw_reuse=1      # å…è¨±é‡ç”¨ TIME_WAIT")
	fmt.Println("sysctl -w net.ipv4.tcp_fin_timeout=30  # ç¸®çŸ­ FIN è¶…æ™‚æ™‚é–“")
	fmt.Println()
	
	fmt.Println("# SYN+ACK é‡å‚³æ¬¡æ•¸ (æ¸›å°‘ SYN Flood å½±éŸ¿)")
	fmt.Println("sysctl -w net.ipv4.tcp_synack_retries=2")
	fmt.Println()
	
	fmt.Println("# å¢åŠ æœ¬åœ°ç«¯å£ç¯„åœ (é¿å…ç«¯å£è€—ç›¡)")
	fmt.Println("sysctl -w net.ipv4.ip_local_port_range='10000 65000'")
}

// 5. è¨­ç½® Socket é¸é …
func socketOptions() error {
	// å‰µå»º socket
	fd, err := syscall.Socket(syscall.AF_INET, syscall.SOCK_STREAM, syscall.IPPROTO_TCP)
	if err != nil {
		return fmt.Errorf("å‰µå»º socket å¤±æ•—: %v", err)
	}
	defer syscall.Close(fd)
	
	// è¨­ç½® SO_REUSEADDR (å…è¨± TIME_WAIT ç‹€æ…‹çš„ç«¯å£è¢«é‡ç”¨)
	// é€™å°ä¼ºæœå™¨é‡å•Ÿå¾ˆæœ‰ç”¨
	err = syscall.SetsockoptInt(fd, syscall.SOL_SOCKET, syscall.SO_REUSEADDR, 1)
	if err != nil {
		return fmt.Errorf("è¨­ç½® SO_REUSEADDR å¤±æ•—: %v", err)
	}
	fmt.Println("âœ… SO_REUSEADDR å·²å•Ÿç”¨ (å…è¨±ç«¯å£å¿«é€Ÿé‡ç”¨)")
	
	// è¨­ç½® SO_KEEPALIVE (å•Ÿç”¨ TCP Keep-Alive)
	// å®šæœŸç™¼é€æ¢æ¸¬å°åŒ…,æª¢æ¸¬é€£æ¥æ˜¯å¦ä»ç„¶å­˜æ´»
	err = syscall.SetsockoptInt(fd, syscall.SOL_SOCKET, syscall.SO_KEEPALIVE, 1)
	if err != nil {
		return fmt.Errorf("è¨­ç½® SO_KEEPALIVE å¤±æ•—: %v", err)
	}
	fmt.Println("âœ… SO_KEEPALIVE å·²å•Ÿç”¨ (æª¢æ¸¬æ­»é€£æ¥)")
	
	// è¨­ç½® TCP_NODELAY (ç¦ç”¨ Nagle ç®—æ³•)
	// ç«‹å³ç™¼é€å°å°åŒ…,æ¸›å°‘å»¶é²
	err = syscall.SetsockoptInt(fd, syscall.IPPROTO_TCP, syscall.TCP_NODELAY, 1)
	if err != nil {
		return fmt.Errorf("è¨­ç½® TCP_NODELAY å¤±æ•—: %v", err)
	}
	fmt.Println("âœ… TCP_NODELAY å·²å•Ÿç”¨ (é™ä½å»¶é²)")
	
	return nil
}

// 6. ç›£æ§ TCP é€£æ¥ç‹€æ…‹
func monitorTCPConnections() {
	fmt.Println("\n=== TCP é€£æ¥ç›£æ§ ===\n")
	
	// åœ¨ Linux ä¸Šå¯ä»¥è®€å– /proc/net/tcp
	if _, err := os.Stat("/proc/net/tcp"); err == nil {
		fmt.Println("å¯ä»¥é€šé /proc/net/tcp ç›£æ§ TCP é€£æ¥:")
		fmt.Println("  cat /proc/net/tcp")
		fmt.Println()
	}
	
	fmt.Println("å¸¸ç”¨ç›£æ§å‘½ä»¤:")
	fmt.Println("  1. netstat -antp          # æŸ¥çœ‹æ‰€æœ‰ TCP é€£æ¥")
	fmt.Println("  2. ss -tan                # æ›´å¿«çš„ socket çµ±è¨ˆå·¥å…·")
	fmt.Println("  3. ss -s                  # æŸ¥çœ‹çµ±è¨ˆæ‘˜è¦")
	fmt.Println("  4. ss -tan state TIME-WAIT | wc -l  # çµ±è¨ˆ TIME_WAIT æ•¸é‡")
	fmt.Println()
	
	fmt.Println("ç›£æ§æŒ‡æ¨™:")
	fmt.Println("  - ESTABLISHED é€£æ¥æ•¸     # ç•¶å‰æ´»èºé€£æ¥")
	fmt.Println("  - TIME_WAIT é€£æ¥æ•¸       # ç­‰å¾…é—œé–‰çš„é€£æ¥")
	fmt.Println("  - SYN_RECV é€£æ¥æ•¸        # åŠé€£æ¥éšŠåˆ—é•·åº¦")
	fmt.Println("  - CLOSE_WAIT é€£æ¥æ•¸      # æ‡‰ç”¨æœªæ­£ç¢ºé—œé–‰çš„é€£æ¥ (æ´©æ¼)")
}

func main() {
	fmt.Println("=== TCP ä¸‰æ¬¡æ¡æ‰‹èˆ‡å››æ¬¡æ®æ‰‹æ¼”ç¤º ===\n")
	
	// æ¼”ç¤º TCP ç‹€æ…‹
	demonstrateTCPStates()
	
	// é¡¯ç¤º TCP åƒæ•¸é…ç½®
	configureTCPParameters()
	
	// æ¼”ç¤º Socket é¸é …
	fmt.Println("\n=== Socket é¸é …æ¼”ç¤º ===")
	if err := socketOptions(); err != nil {
		fmt.Println("éŒ¯èª¤:", err)
	}
	
	// é¡¯ç¤ºç›£æ§å‘½ä»¤
	monitorTCPConnections()
	
	fmt.Println("\n=== å•Ÿå‹• TCP ä¼ºæœå™¨å’Œå®¢æˆ¶ç«¯ ===")
	fmt.Println("å–æ¶ˆè¨»é‡‹ä»¥ä¸‹ä»£ç¢¼ä¾†é‹è¡Œä¼ºæœå™¨/å®¢æˆ¶ç«¯:")
	fmt.Println("  // go tcpServer()  // åœ¨ goroutine ä¸­å•Ÿå‹•ä¼ºæœå™¨")
	fmt.Println("  // time.Sleep(1 * time.Second)")
	fmt.Println("  // tcpClient()    // å•Ÿå‹•å®¢æˆ¶ç«¯")
	
	// å–æ¶ˆè¨»é‡‹ä»¥ä¸‹ä»£ç¢¼ä¾†å¯¦éš›é‹è¡Œ
	// go tcpServer()
	// time.Sleep(1 * time.Second)
	// tcpClient()
	// time.Sleep(5 * time.Second) // ç­‰å¾… TIME_WAIT
}
```

**ç¨‹å¼ç¢¼èªªæ˜**:

1. **tcpServer**: æ¼”ç¤ºä¼ºæœå™¨ç«¯çš„é€£æ¥å»ºç«‹å’Œé—œé–‰éç¨‹
2. **tcpClient**: æ¼”ç¤ºå®¢æˆ¶ç«¯çš„é€£æ¥å»ºç«‹å’Œä¸»å‹•é—œé–‰
3. **demonstrateTCPStates**: èªªæ˜å¦‚ä½•ä½¿ç”¨ netstat è§€å¯Ÿ TCP ç‹€æ…‹
4. **configureTCPParameters**: å±•ç¤ºé‡è¦çš„ TCP å…§æ ¸åƒæ•¸é…ç½®
5. **socketOptions**: æ¼”ç¤ºå¦‚ä½•è¨­ç½® Socket é¸é …ä¾†å„ªåŒ– TCP è¡Œç‚º
6. **monitorTCPConnections**: æä¾›ç›£æ§ TCP é€£æ¥çš„å‘½ä»¤å’ŒæŒ‡æ¨™

## ç¸½çµ

### é—œéµè¦é»

1. **ä¸‰æ¬¡æ¡æ‰‹**: ç¢ºä¿é›™æ–¹çš„ç™¼é€å’Œæ¥æ”¶èƒ½åŠ›,åŒæ­¥ ISN,é˜²æ­¢èˆŠé€£æ¥å¹²æ“¾
2. **å››æ¬¡æ®æ‰‹**: å› ç‚º TCP æ˜¯å…¨é›™å·¥,éœ€è¦åˆ†åˆ¥é—œé–‰å…©å€‹æ–¹å‘çš„é€£æ¥
3. **TIME_WAIT**: ç¢ºä¿æœ€å¾Œçš„ ACK åˆ°é”,é˜²æ­¢èˆŠæ•¸æ“šåŒ…å¹²æ“¾æ–°é€£æ¥
4. **åŠé€£æ¥/å…¨é€£æ¥éšŠåˆ—**: ç†è§£éšŠåˆ—æ©Ÿåˆ¶,é¿å… SYN Flood æ”»æ“Š
5. **ç‹€æ…‹è½‰æ›**: æŒæ¡ TCP ç‹€æ…‹æ©Ÿ,èƒ½å¤ è¨ºæ–·é€£æ¥å•é¡Œ

### é¢è©¦é«˜é »å•é¡Œ

1. **Q: ç‚ºä»€éº¼æ˜¯ä¸‰æ¬¡æ¡æ‰‹,ä¸æ˜¯å…©æ¬¡æˆ–å››æ¬¡?**
   - A: å…©æ¬¡ç„¡æ³•é˜²æ­¢èˆŠé€£æ¥åˆå§‹åŒ–;ä¸‰æ¬¡æ˜¯å®Œæˆé›™å‘ ISN åŒæ­¥çš„æœ€å°æ¬¡æ•¸;å››æ¬¡æ˜¯å†—é¤˜çš„

2. **Q: ç‚ºä»€éº¼æ˜¯å››æ¬¡æ®æ‰‹,ä¸èƒ½åˆä½µç‚ºä¸‰æ¬¡?**
   - A: TCP æ˜¯å…¨é›™å·¥,è¢«å‹•é—œé–‰æ–¹æ”¶åˆ° FIN å¾Œå¯èƒ½é‚„æœ‰æ•¸æ“šè¦ç™¼é€,æ‰€ä»¥ ACK å’Œ FIN ä¸èƒ½åˆä½µ

3. **Q: TIME_WAIT ç‹€æ…‹çš„ä½œç”¨?æŒçºŒå¤šä¹…?**
   - A: â‘  ç¢ºä¿æœ€å¾Œçš„ ACK åˆ°é” â‘¡ é˜²æ­¢èˆŠé€£æ¥çš„æ•¸æ“šåŒ…å¹²æ“¾æ–°é€£æ¥;æŒçºŒ 2MSL (é€šå¸¸ 60 ç§’åˆ° 4 åˆ†é˜)

4. **Q: å¦‚ä½•æ‡‰å°å¤§é‡ TIME_WAIT é€£æ¥?**
   - A: â‘  å•Ÿç”¨ tcp_tw_reuse â‘¡ å¢åŠ æœ¬åœ°ç«¯å£ç¯„åœ â‘¢ ä½¿ç”¨é€£æ¥æ±  â‘£ è®“å®¢æˆ¶ç«¯ä¸»å‹•é—œé–‰é€£æ¥

5. **Q: ä»€éº¼æ˜¯ SYN Flood æ”»æ“Š?å¦‚ä½•é˜²ç¦¦?**
   - A: æ”»æ“Šè€…ç™¼é€å¤§é‡ SYN,å¡«æ»¿åŠé€£æ¥éšŠåˆ—;é˜²ç¦¦: â‘  å•Ÿç”¨ SYN Cookie â‘¡ å¢å¤§éšŠåˆ— â‘¢ æ¸›å°‘é‡å‚³æ¬¡æ•¸ â‘£ ä½¿ç”¨é˜²ç«ç‰†

### å»¶ä¼¸é–±è®€

- **ä¸‹ä¸€æ­¥**: [TCP å¯é å‚³è¼¸æ©Ÿåˆ¶](./tcp_reliable_transmission.md)
- **ç›¸é—œä¸»é¡Œ**: [ç¶²è·¯æ•ˆèƒ½å„ªåŒ–ç­–ç•¥](./network_performance_optimization.md)
- **å¯¦ä½œç·´ç¿’**: ä½¿ç”¨ Wireshark æŠ“åŒ…,è§€å¯Ÿä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æ®æ‰‹çš„å®Œæ•´éç¨‹
