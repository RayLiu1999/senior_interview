# 長輪詢、SSE 與 WebSocket 對比

- **難度**: 6
- **重要程度**: 4
- **標籤**: `WebSocket`, `SSE`, `長輪詢`, `即時通訊`, `推播技術`

## 問題詳述

在 HTTP 無狀態的基礎上實現伺服器向客戶端的**即時推播（Server Push）**，是構建即時通知、聊天、直播彈幕等功能的核心挑戰。長輪詢、SSE 和 WebSocket 是三種主流解決方案，各有不同的技術代價和適用場景。

## 核心理論與詳解

### 問題背景：HTTP 的局限性

傳統 HTTP 是**請求/回應模型**（Request-Response），客戶端主動請求，伺服器被動回應。若要讓伺服器主動推送，必須突破這個模型。

---

### Short Polling（短輪詢）

客戶端以**固定間隔**（如每隔 2 秒）不斷發送 HTTP 請求，詢問是否有新資料。

**缺點**：
- 大量無意義請求（大部分回應是「沒有新資料」）
- 延遲等於輪詢間隔，不夠即時
- 伺服器壓力大，資源浪費嚴重

---

### Long Polling（長輪詢）

客戶端發送請求後，伺服器**保持連接不關閉**，直到有新資料時才回應；客戶端收到回應後立即發起下一次請求。

**優點**：
- 相較短輪詢，減少無效請求
- 無需瀏覽器特殊支援，相容性極好
- 延遲相對短（有資料立即回應）

**缺點**：
- 每條消息都需要一次完整的 HTTP 請求-回應週期（頭部開銷）
- 伺服器需要長期占用連接（執行緒/進程資源）
- 消息頻繁時，效能不如 WebSocket

**適用場景**：對即時性要求不極高、需要相容老舊瀏覽器的場景

---

### Server-Sent Events (SSE)

SSE 是 HTML5 標準，基於**長連接的 HTTP 回應**（`text/event-stream`），實現伺服器到客戶端的**單向持久推送**。

**運作原理**：客戶端通過 `EventSource` API 建立一條長 HTTP 連接，伺服器持續向這個連接寫入格式化的事件。

**SSE 事件格式**：
```
data: {"user": "alice", "message": "Hello"}\n\n
event: notification\n
data: {"type": "new_order", "id": 42}\n\n
```

**優點**：
- **原生支援斷線重連**（`EventSource` 自動重連，帶 `Last-Event-ID`）
- 基於標準 HTTP，穿越防火牆/代理無障礙
- 支援 HTTP/2，可多路復用（多個 SSE 共用一個 TCP 連接）
- 實現簡單，無需額外協定升級

**缺點**：
- **單向通訊**（只能伺服器→客戶端），客戶端發送仍需另開 HTTP 請求
- 預設最大連接數限制（HTTP/1.1 瀏覽器每域名 6 個連接，SSE 會占用一個）
- 不支援二進制數據（只有文字格式）

---

### WebSocket

WebSocket 是獨立協定（RFC 6455），通過 HTTP 升級握手（`Upgrade: websocket`）建立一條**持久的全雙工 TCP 連接**，之後通信不再走 HTTP。

**運作原理**：
1. 客戶端發送 HTTP Upgrade 請求（帶 `Sec-WebSocket-Key`）
2. 伺服器回應 101 Switching Protocols
3. 之後雙方通過 WebSocket Frame 協定直接通信（低開銷）

**優點**：
- **全雙工**：客戶端和伺服器可同時互相發送消息
- **低延遲、低開銷**：WebSocket Frame 頭部僅 2-10 bytes（HTTP 頭部數百 bytes）
- 支援二進制數據（音訊、影片、文件傳輸）
- 天然適合高頻通訊

**缺點**：
- 需要特殊的負載均衡配置（保持連接到同一後端，或基於 sticky session）
- 部分代理/防火牆不支援 WebSocket
- 需要額外的心跳機制（Ping/Pong）維持長連接
- 伺服器端需要異步/事件驅動架構支撐大量並發連接

---

### 三者對比

| 比較項目 | Long Polling | SSE | WebSocket |
|---------|-------------|-----|-----------|
| 通訊方向 | 伺服器→客戶端（間歇） | 伺服器→客戶端（持久） | **全雙工** |
| 協定 | HTTP | HTTP | 獨立協定（WS） |
| 連接持久性 | 短暫（每次重建） | 持久 | 持久 |
| 頭部開銷 | 高（每次完整 HTTP） | 低（一次建立後） | 極低（Frame 格式） |
| 斷線重連 | 需手動實現 | ✅ 原生支援 | 需手動實現 |
| 二進制支援 | 無（需 Base64） | 無 | ✅ 支援 |
| 實現複雜度 | 低 | 低 | 中 |
| 適用場景 | 低頻通知、相容場景 | 新聞推送、通知、進度 | 聊天、遊戲、協作工具 |

### 選型建議

- **單向推播 + 只需文字**：優先選 **SSE**（實現最簡單，相容性好）
- **雙向即時通訊、高頻消息**：選 **WebSocket**（聊天室、實時協作、線上遊戲）
- **需相容舊系統或無法升級依賴**：選 **Long Polling**
- **AI 串流輸出（如 ChatGPT 效果）**：**SSE** 是最佳選擇（天然支援逐 Token 推送）
