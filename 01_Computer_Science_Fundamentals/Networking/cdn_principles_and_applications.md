# CDN 原理與應用

- **難度**: 6
- **重要程度**: 4
- **標籤**: `CDN`, `內容分發`, `快取`, `效能優化`, `邊緣計算`

## 問題詳述

解釋 CDN (Content Delivery Network) 的工作原理、快取策略、回源機制，以及如何利用 CDN 提升全球用戶的訪問速度和網站可用性。

## 核心理論與詳解

### 1. CDN 基本概念

**CDN (Content Delivery Network, 內容分發網路)** 是在全球部署的分散式伺服器網路，透過就近提供內容縮短用戶訪問延遲。

#### 核心優勢

- **降低延遲**: 用戶從最近的節點獲取內容
- **減輕源站壓力**: 大部分流量由 CDN 承擔
- **提高可用性**: 節點故障時自動切換
- **抵禦攻擊**: 分散流量，吸收 DDoS 攻擊
- **節省頻寬成本**: 減少源站流量

### 2. CDN 工作原理

#### 傳統訪問 vs CDN 訪問

**無 CDN**:
```
用戶 (台灣) → 源站 (美國)
延遲: 200-300ms
```

**使用 CDN**:
```
用戶 (台灣) → CDN 節點 (台灣/香港)
延遲: 10-30ms (提升 10 倍)
```

#### 完整請求流程

**第一步: DNS 解析**

```
用戶輸入 www.example.com
    ↓
本地 DNS 查詢
    ↓
權威 DNS 返回 CNAME: www.example.com.cdn.provider.com
    ↓
CDN DNS (智能 DNS) 根據用戶位置返回最近節點 IP
    ↓
返回: 203.0.113.10 (台灣節點)
```

**第二步: 內容請求**

```
用戶 → CDN 邊緣節點
          ↓
    檢查快取是否存在
          ↓
     存在? → 直接返回 (快取命中)
     不存在 ↓
    回源請求 (回到源站)
          ↓
    快取內容並返回給用戶
```

**第三步: 快取刷新**

```
內容更新時:
  源站通知 CDN
      ↓
  CDN 清除或更新快取
      ↓
  下次請求重新回源
```

### 3. CDN 節點架構

#### 分層架構

```
      [源站 Origin]
          ↓
   [中心節點 Central]
    /           \
[區域節點]   [區域節點]
  /  \         /  \
邊緣 邊緣    邊緣 邊緣
節點 節點    節點 節點
```

**邊緣節點 (Edge Nodes)**:
- 最接近用戶
- 數量最多 (數百到數千個)
- 快取熱門內容

**區域節點 (Regional Nodes)**:
- 中間層
- 數量中等 (數十個)
- 快取更多內容

**中心節點 (Central Nodes)**:
- 接近源站
- 數量少 (幾個)
- 快取幾乎所有內容

#### POP (Point of Presence)

**定義**: CDN 在特定地理位置的節點集群

**組成**:
- 多台伺服器 (負載均衡)
- 大容量儲存 (快取內容)
- 高速網路連接 (與其他 POP 和源站)

### 4. 智能調度策略

#### 地理位置就近

**原理**: 根據用戶 IP 判斷地理位置，返回最近節點

```
用戶 IP: 203.0.113.0/24
    ↓
地理定位: 台灣台北
    ↓
選擇節點: 台北 POP
```

**實現**: GeoIP 資料庫 (如 MaxMind)

#### 網路距離最優

**原理**: 考慮網路拓撲，而非純地理距離

```
用戶 ISP: Chunghwa Telecom
    ↓
選擇: 與該 ISP 直連的節點 (降低跨網延遲)
```

#### 負載均衡

**原理**: 避免單一節點過載

```
節點 A: 90% 負載
節點 B: 50% 負載 ← 選擇
節點 C: 80% 負載
```

#### 健康檢查

**原理**: 排除故障節點

```
節點健康檢查:
  - HTTP 探測: GET /health
  - 回應時間
  - 錯誤率

不健康節點 → 從調度池移除
```

#### 綜合評分

**計算公式**:
```
分數 = 地理距離權重 × 0.3
     + 網路延遲權重 × 0.4
     + 節點負載權重 × 0.2
     + 快取命中率權重 × 0.1

選擇分數最低的節點
```

### 5. 快取策略

#### HTTP 快取頭部

**Cache-Control**:
```http
Cache-Control: public, max-age=3600

public: 可被任何快取儲存
private: 只能被用戶瀏覽器快取
max-age: 快取有效時間 (秒)
no-cache: 必須驗證後才能使用快取
no-store: 完全不快取
```

**Expires**:
```http
Expires: Wed, 21 Oct 2024 07:28:00 GMT

指定絕對過期時間 (HTTP/1.0, 已過時)
```

**ETag**:
```http
ETag: "33a64df551425fcc55e4d42a148795d9f25f89d4"

資源版本標識
用於條件請求 (If-None-Match)
```

**Last-Modified**:
```http
Last-Modified: Wed, 21 Oct 2024 07:28:00 GMT

資源最後修改時間
用於條件請求 (If-Modified-Since)
```

#### 快取驗證

**條件請求 (Conditional Request)**:

```http
客戶端請求:
GET /image.jpg HTTP/1.1
If-None-Match: "33a64df551425fcc55e4d42a148795d9f25f89d4"

伺服器回應 (未修改):
HTTP/1.1 304 Not Modified

伺服器回應 (已修改):
HTTP/1.1 200 OK
ETag: "new-etag-value"
[新內容]
```

#### 快取層級

**L1 快取 (記憶體)**:
- 最熱門內容
- 毫秒級存取
- 容量有限 (幾 GB 到幾十 GB)

**L2 快取 (SSD)**:
- 次熱門內容
- 微秒到毫秒級存取
- 容量中等 (幾百 GB 到幾 TB)

**L3 快取 (HDD)**:
- 長尾內容
- 毫秒到秒級存取
- 容量大 (幾 TB 到幾十 TB)

#### 快取淘汰策略

**LRU (Least Recently Used)**:
- 淘汰最久未使用的內容
- 實現簡單，效果好

**LFU (Least Frequently Used)**:
- 淘汰訪問頻率最低的內容
- 適合熱門內容穩定的場景

**TTL (Time To Live)**:
- 基於過期時間淘汰
- 結合業務需求設定

### 6. 回源機制

#### 回源觸發條件

1. **快取未命中 (Cache Miss)**:
   - 首次請求
   - 快取已過期
   - 快取已被淘汰

2. **快取驗證 (Cache Revalidation)**:
   - 快取過期但存在
   - 使用條件請求驗證

3. **強制回源**:
   - URL 帶特殊參數 (如 `?nocache=1`)
   - 快取刷新請求

#### 回源優化

**1. 回源合併 (Request Coalescing)**

**問題**: 多個用戶同時請求未快取的內容

```
用戶 1 → CDN (快取未命中) → 回源
用戶 2 → CDN (快取未命中) → 回源
用戶 3 → CDN (快取未命中) → 回源
源站壓力大！
```

**解決**: 只發起一次回源請求，其他請求等待

```
用戶 1 → CDN → 回源 (獲取內容)
用戶 2 → CDN ┘
用戶 3 → CDN ┘ 等待第一個請求完成
所有用戶從快取獲取內容
```

**2. 分層回源**

```
邊緣節點 → 區域節點 (命中) → 返回
邊緣節點 → 區域節點 (未命中) → 中心節點
邊緣節點 → 區域節點 → 中心節點 (未命中) → 源站
```

**優勢**: 減少直接回源次數，保護源站

**3. 預快取 (Pre-caching)**

**原理**: 主動推送熱門內容到邊緣節點

```
源站更新內容
    ↓
主動推送到 CDN
    ↓
邊緣節點預先快取
    ↓
用戶請求直接命中
```

**適用**: 可預期的熱門內容 (如新品發布)

### 7. CDN 安全

#### DDoS 防護

**吸收攻擊**:
- CDN 節點分散全球
- 單一節點攻擊影響有限
- 自動限流和黑名單

**類型防護**:
- **SYN Flood**: 在邊緣節點過濾
- **HTTP Flood**: 速率限制、挑戰驗證
- **DNS 放大**: DNS 節點過濾異常查詢

#### Web 應用防火牆 (WAF)

**功能**:
- 過濾惡意請求
- SQL 注入防護
- XSS 攻擊防護
- 自訂安全規則

**部署**: 在 CDN 邊緣節點

#### SSL/TLS

**全程加密**:
```
用戶 ──HTTPS──> CDN ──HTTPS──> 源站
```

**SSL 終止**:
```
用戶 ──HTTPS──> CDN ──HTTP──> 源站 (內網)
```

**憑證管理**:
- 支援自訂憑證
- 提供免費憑證 (如 Let's Encrypt)
- 自動續期

#### 防盜鏈 (Hotlink Protection)

**問題**: 其他網站直接連結你的資源

**解決方案**:

**1. Referer 檢查**:
```nginx
valid_referers none blocked example.com *.example.com;
if ($invalid_referer) {
    return 403;
}
```

**2. 簽名 URL**:
```
https://cdn.example.com/image.jpg?expires=1234567890&signature=abc123

CDN 驗證:
- 時間未過期
- 簽名正確
```

**3. Token 認證**:
```
Authorization: Bearer token123
```

### 8. 效能優化

#### 內容優化

**1. 圖片優化**:
- WebP 格式 (體積減少 30-50%)
- 響應式圖片 (根據裝置提供不同尺寸)
- 延遲載入 (Lazy Loading)

**2. 壓縮**:
- Gzip / Brotli 壓縮 (文字類內容減少 70-90%)
- Minify (CSS/JS 最小化)

**3. 合併**:
- CSS Sprite (合併小圖示)
- JS/CSS 打包

#### 協定優化

**HTTP/2**:
- 多路復用
- 頭部壓縮
- 伺服器推送

**HTTP/3 (QUIC)**:
- 更快的連接建立 (0-RTT)
- 更好的弱網表現
- 避免隊頭阻塞

#### 預加載

**DNS Prefetch**:
```html
<link rel="dns-prefetch" href="//cdn.example.com">
```

**Preconnect**:
```html
<link rel="preconnect" href="//cdn.example.com">
```

**Prefetch / Preload**:
```html
<link rel="prefetch" href="/next-page.html">
<link rel="preload" href="/critical.css" as="style">
```

### 9. 監控與分析

#### 關鍵指標

**快取效能**:
- **快取命中率 (Cache Hit Ratio)**: 命中請求 / 總請求
  - 目標: > 90%
- **字節命中率**: 快取字節 / 總字節
- **回源率**: 回源請求 / 總請求

**用戶體驗**:
- **首字節時間 (TTFB)**: 瀏覽器發起請求到收到首字節的時間
- **內容下載時間**: 完整下載內容的時間
- **錯誤率**: 4xx/5xx 錯誤佔比

**流量指標**:
- **頻寬使用**: 峰值和平均頻寬
- **請求數**: QPS 峰值和平均
- **流量分布**: 各地區、各內容類型流量

#### 實時日誌

**訪問日誌**:
```
時間戳 | 客戶端 IP | 請求 URL | 狀態碼 | 快取狀態 | 回應時間
```

**分析**:
- 熱門內容 (Top URLs)
- 錯誤內容 (404/5xx)
- 慢請求 (P95/P99 延遲)
- 異常流量 (突增、攻擊)

### 10. 實務最佳實踐

#### CDN 配置清單

- [ ] 設定合理的快取規則 (按檔案類型)
- [ ] 配置快取驗證 (ETag, Last-Modified)
- [ ] 啟用壓縮 (Gzip/Brotli)
- [ ] 啟用 HTTP/2 或 HTTP/3
- [ ] 配置 SSL/TLS
- [ ] 設定防盜鏈規則
- [ ] 配置 CORS (如需要)
- [ ] 啟用 WAF (Web 應用防火牆)
- [ ] 設定速率限制
- [ ] 配置監控和告警
- [ ] 建立快取刷新流程
- [ ] 測試故障轉移

#### 快取策略建議

**靜態資源**:
```
圖片 (jpg, png, webp): max-age=31536000 (1 年)
CSS/JS: max-age=31536000, 使用版本號或 hash
字體: max-age=31536000
```

**動態內容**:
```
HTML: max-age=0, must-revalidate
API: no-cache 或短 TTL (如 60 秒)
用戶特定內容: private, no-cache
```

## 總結

CDN 是現代 Web 應用的基礎設施：

1. **全球加速**: 透過就近提供內容顯著降低延遲
2. **減輕源站壓力**: 大部分流量由 CDN 承擔
3. **提升安全性**: 分散式架構抵禦 DDoS，WAF 防護應用層攻擊
4. **優化成本**: 減少源站頻寬成本，提高資源利用率
5. **提升可用性**: 多節點冗餘，故障自動切換

作為資深後端工程師，你需要：
- 理解 CDN 的工作原理和調度策略
- 能夠設計合理的快取策略
- 掌握 CDN 配置和優化技巧
- 實施有效的安全防護措施
- 建立監控體系，持續優化效能
